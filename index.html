<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>🚚 Truck Data Manager</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #2c3e50;
            padding: 10px;
            min-height: 100vh;
            font-size: 14px;
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
        }

        header {
            text-align: center;
            padding: 15px 10px;
            background: linear-gradient(135deg, #ff8c42 0%, #ff6b35 100%);
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            margin-bottom: 10px;
        }

        h1 {
            font-size: 1.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 5px;
            color: white;
        }

        .subtitle {
            font-size: 0.85em;
            opacity: 0.9;
            color: white;
        }

        .tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .tab-button {
            padding: 12px 16px;
            background: #5a7fa7;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 0.9em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            min-height: 44px;
            flex: 1 1 auto;
            min-width: 80px;
        }

        .tab-button:active {
            transform: scale(0.95);
        }

        .tab-button.active {
            background: linear-gradient(135deg, #ff8c42 0%, #ff6b35 100%);
            box-shadow: 0 4px 8px rgba(255, 140, 66, 0.4);
        }

        .tab-content {
            display: none;
            background: #f8f9fa;
            padding: 15px 10px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .tab-content.active {
            display: block;
        }

        .controls {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn {
            padding: 8px 12px;
            background: linear-gradient(135deg, #5a7fa7 0%, #4a6f97 100%);
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 0.8em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            min-height: 44px;
            white-space: nowrap;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .btn-primary {
            background: linear-gradient(135deg, #ff8c42 0%, #ff6b35 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        }

        .filters {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            flex-wrap: wrap;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .filter-section {
            display: flex;
            flex-direction: column;
            gap: 6px;
            flex: 1 1 100%;
            min-width: 0;
        }

        .filter-section label {
            font-weight: bold;
            color: #1e3c72;
            font-size: 0.85em;
        }

        .filter-item {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .filter-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .filter-item label {
            cursor: pointer;
            font-weight: bold;
            color: #2c3e50;
            font-size: 0.9em;
            user-select: none;
        }

        .filter-item select,
        .filter-item input[type="text"],
        .filter-item input[type="number"] {
            padding: 8px 10px;
            border: 2px solid #5a7fa7;
            border-radius: 4px;
            font-size: 0.9em;
            width: 100%;
            min-height: 44px;
        }

        .advanced-filter {
            display: flex;
            gap: 6px;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .advanced-filter select,
        .advanced-filter input {
            flex: 1 1 100%;
            min-width: 0;
            min-height: 44px;
        }

        .progress-container {
            display: none;
            background: white;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .progress-container.show {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #ff8c42 0%, #ff6b35 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9em;
        }

        .progress-status {
            margin-top: 8px;
            color: #2c3e50;
            font-weight: bold;
            text-align: center;
            font-size: 0.9em;
        }

        .table-container {
            overflow-x: auto;
            background: white;
            border-radius: 6px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-height: 500px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 500px;
            background: white;
        }

        th, td {
            padding: 6px 4px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
            font-size: 10px;
            white-space: nowrap;
            position: relative;
        }

        th {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
            user-select: none;
            font-size: 9px;
        }

        th:active {
            background: linear-gradient(135deg, #2a5298 0%, #3a62a8 100%);
        }

        th .sort-indicator {
            margin-left: 4px;
            font-size: 0.8em;
        }

        tr:nth-child(even) {
            background: #f8f9fa;
        }

        tr:nth-child(odd) {
            background: white;
        }

        .row-green {
            background: #d4edda !important;
        }

        .row-yellow {
            background: #fff3cd !important;
        }

        .row-red {
            background: #f8d7da !important;
        }

        .row-gray {
            background: #e8d5f0 !important;
            opacity: 0.9;
        }

        .status-bar {
            background: white;
            padding: 8px;
            border-radius: 6px;
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 6px;
            flex: 1 1 auto;
            min-width: 100px;
            justify-content: center;
        }

        .status-badge {
            padding: 6px 10px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 0.8em;
            white-space: nowrap;
        }

        .badge-green {
            background: #27ae60;
            color: white;
        }

        .badge-yellow {
            background: #f39c12;
            color: white;
        }

        .badge-red {
            background: #e74c3c;
            color: white;
        }

        .badge-total {
            background: #5a7fa7;
            color: white;
        }

        .pagination {
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
            padding: 8px;
            background: white;
            border-radius: 6px;
            flex-wrap: wrap;
        }

        .pagination button {
            padding: 8px 12px;
            background: #5a7fa7;
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-weight: bold;
            min-height: 44px;
            font-size: 0.85em;
        }

        .pagination button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .pagination button:active:not(:disabled) {
            transform: scale(0.95);
        }

        .pagination select {
            padding: 8px;
            border: 2px solid #5a7fa7;
            border-radius: 4px;
            min-height: 44px;
            font-size: 0.85em;
        }

        .pagination span {
            font-weight: bold;
            text-align: center;
            flex: 1 1 100%;
            font-size: 0.85em;
        }

        .chart-section {
            background: white;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .chart-controls {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .chart-control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .chart-control-group label {
            font-weight: bold;
            color: #1e3c72;
            font-size: 0.9em;
        }

        .chart-controls select,
        .chart-controls input {
            padding: 10px;
            border: 2px solid #5a7fa7;
            border-radius: 4px;
            background: white;
            color: #2c3e50;
            font-size: 0.9em;
            min-height: 44px;
        }

        .chart-canvas-container {
            max-width: 100%;
            margin: 20px auto;
            overflow-x: auto;
        }

        .dataset-section {
            background: white;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .dataset-section h3 {
            color: #1e3c72;
            margin-bottom: 10px;
            border-bottom: 2px solid #ff8c42;
            padding-bottom: 5px;
            font-size: 1.1em;
        }

        .totals-bar {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 10px 8px;
            border-radius: 6px;
            margin-top: 10px;
            font-weight: bold;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 8px;
        }

        .total-item {
            font-size: 0.85em;
            text-align: center;
            flex: 1 1 auto;
            min-width: 130px;
        }

        .settings-panel {
            background: white;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .settings-section {
            margin-bottom: 25px;
        }

        .settings-section h3 {
            color: #1e3c72;
            margin-bottom: 15px;
            font-size: 1.1em;
            border-bottom: 2px solid #ff8c42;
            padding-bottom: 8px;
        }

        .sheet-input-group {
            margin-bottom: 15px;
        }

        .sheet-input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
            font-size: 0.9em;
        }

        .sheet-input-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #5a7fa7;
            border-radius: 4px;
            font-size: 0.85em;
            min-height: 44px;
        }

        .auto-refresh-indicator {
            display: inline-block;
            padding: 8px 12px;
            background: #27ae60;
            color: white;
            border-radius: 6px;
            font-size: 0.8em;
            margin-left: 10px;
        }

        .chart-type-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .chart-type-btn {
            padding: 10px 14px;
            background: #5a7fa7;
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 0.85em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1 1 auto;
            min-height: 44px;
        }

        .chart-type-btn.active {
            background: #ff8c42;
        }

        .chart-type-btn:active {
            transform: scale(0.95);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .summary-card {
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }

        .summary-card.overpaid {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
        }

        .summary-card.underpaid {
            background: #fff4e6;
            border: 2px solid #ff8c42;
        }

        .summary-card.total {
            background: #e6f2ff;
            border: 2px solid #5a7fa7;
        }

        .summary-value {
            font-size: 1.5em;
            font-weight: bold;
            margin: 10px 0;
        }

        .summary-label {
            font-size: 0.9em;
            color: #666;
        }

        .discrepancy-table {
            font-size: 9px;
            width: 100%;
            border-collapse: collapse;
        }

        .discrepancy-table th {
            background: #1e3c72;
            color: white;
            padding: 5px 4px;
            font-size: 8px;
            text-align: left;
        }

        .discrepancy-table td {
            padding: 4px;
            border-bottom: 1px solid #ddd;
            font-size: 9px;
        }

        .discrepancy-table tr:hover {
            background: #f0f0f0;
        }

        .amount-negative {
            color: #e74c3c;
            font-weight: bold;
        }

        .amount-positive {
            color: #3498db;
            font-weight: bold;
        }

        .money-header {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
            padding: 20px 15px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(39, 174, 96, 0.3);
        }

        .money-header h2 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .money-emoji {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .money-card {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border: 3px solid #27ae60;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .money-card h3 {
            color: #155724;
            font-size: 1.2em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .money-total {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            font-size: 1em;
            font-weight: bold;
            text-align: center;
            box-shadow: 0 4px 8px rgba(39, 174, 96, 0.3);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 20px auto;
            padding: 20px;
            border: 1px solid #888;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #1e3c72;
        }

        .modal-header h2 {
            color: #1e3c72;
            margin: 0;
            font-size: 1.2em;
        }

        .close {
            color: #aaa;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close:active {
            color: #000;
        }

        /* Mobile-specific improvements */
        @media (max-width: 768px) {
            body {
                padding: 5px;
                font-size: 11px;
            }

            h1 {
                font-size: 1.2em;
            }

            .tab-button {
                padding: 8px 10px;
                font-size: 0.75em;
                min-width: 65px;
            }

            .btn {
                font-size: 0.75em;
                padding: 8px 10px;
            }

            th, td {
                font-size: 9px;
                padding: 5px 3px;
            }

            th {
                font-size: 8px;
            }

            .filters {
                padding: 8px;
            }

            .filter-section {
                flex: 1 1 100%;
            }

            .status-item {
                min-width: 90px;
            }

            .status-badge {
                font-size: 0.7em;
                padding: 5px 8px;
            }

            .total-item {
                font-size: 0.75em;
                min-width: 110px;
            }

            .table-container {
                max-height: 600px;
            }

            .chart-canvas-container {
                overflow-x: auto;
            }

            .dataset-section h3 {
                font-size: 1em;
            }

            .dataset-section p {
                font-size: 0.85em;
            }

            .discrepancy-table {
                font-size: 8px;
            }

            .discrepancy-table th {
                font-size: 7px;
                padding: 4px 3px;
            }

            .discrepancy-table td {
                font-size: 8px;
                padding: 3px;
            }
        }

        @media (max-width: 480px) {
            body {
                font-size: 10px;
            }

            h1 {
                font-size: 1.1em;
            }

            .tab-button {
                font-size: 0.7em;
                padding: 7px 8px;
            }

            th, td {
                font-size: 8px;
                padding: 4px 2px;
            }

            th {
                font-size: 7px;
            }

            .status-badge {
                font-size: 0.65em;
                padding: 4px 6px;
            }

            .total-item {
                font-size: 0.7em;
            }

            .money-emoji {
                font-size: 1.8em;
            }

            .money-header h2 {
                font-size: 1.1em;
            }

            .discrepancy-table {
                font-size: 7px;
            }

            .discrepancy-table th {
                font-size: 6px;
                padding: 3px 2px;
            }

            .discrepancy-table td {
                font-size: 7px;
                padding: 2px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>🚚 Truck Data Manager</h1>
            <p class="subtitle">Manage Your Idling Summons Data</p>
        </header>

        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('at')">🚛 AT</button>
            <button class="tab-button" onclick="switchTab('at-nyc')">🏙️ AT NYC</button>
            <button class="tab-button" onclick="switchTab('mbt')">🚚 MBT</button>
            <button class="tab-button" onclick="switchTab('new-money')">💰 NEW MONEY</button>
            <button class="tab-button" onclick="switchTab('discrepancies')">⚠️ DISC</button>
            <button class="tab-button" onclick="switchTab('trends')">📈 TRENDS</button>
            <button class="tab-button" onclick="switchTab('fun-facts')">🎉 FACTS</button>
            <button class="tab-button" onclick="switchTab('charts')">📊 CHARTS</button>
            <button class="tab-button" onclick="switchTab('settings')">⚙️ SET</button>
        </div>

        <!-- AT Tab -->
        <div id="at" class="tab-content active">
            <div class="controls">
                <button class="btn btn-primary" onclick="loadAllData()">📄 Load All</button>
                <button class="btn" onclick="refreshData('at')">🔄 Refresh</button>
                <button class="btn btn-danger" onclick="clearData('at')">🗑️ Clear</button>
                <div class="filter-item" style="margin-left: auto;">
                    <input type="checkbox" id="at-show-extra" onchange="toggleExtraColumns('at')">
                    <label for="at-show-extra">Extra Data</label>
                </div>
            </div>

            <div class="progress-container" id="at-progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="at-progress-fill" style="width: 0%">0%</div>
                </div>
                <div class="progress-status" id="at-progress-status">Initializing...</div>
            </div>

            <div class="filters" id="at-filters">
                <div class="filter-section">
                    <label>Visibility</label>
                    <div class="filter-item">
                        <input type="checkbox" id="at-filter-paid" checked onchange="debouncedApplyFilters('at')">
                        <label for="at-filter-paid">Paid</label>
                    </div>
                    <div class="filter-item">
                        <input type="checkbox" id="at-filter-requested" checked onchange="debouncedApplyFilters('at')">
                        <label for="at-filter-requested">Requested</label>
                    </div>
                    <div class="filter-item">
                        <input type="checkbox" id="at-filter-disqualified" checked onchange="debouncedApplyFilters('at')">
                        <label for="at-filter-disqualified">Disqualified</label>
                    </div>
                    <div class="filter-item">
                        <input type="checkbox" id="at-filter-unpaid" checked onchange="debouncedApplyFilters('at')">
                        <label for="at-filter-unpaid">Unpaid</label>
                    </div>
                </div>

                <div class="filter-section">
                    <label>Quick Filters</label>
                    <div class="filter-item">
                        <select id="at-filter-payment-status" onchange="debouncedApplyFilters('at')">
                            <option value="">All Payment Status</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <select id="at-filter-company" onchange="debouncedApplyFilters('at')">
                            <option value="">All Companies</option>
                        </select>
                    </div>
                </div>

                <div class="filter-section">
                    <label>Search</label>
                    <div class="filter-item">
                        <input type="text" id="at-filter-search" placeholder="Search all columns..." onkeyup="debouncedApplyFilters('at')">
                    </div>
                </div>
            </div>

            <div class="status-bar" id="at-status"></div>

            <div class="table-container" id="at-table-container">
                <table id="at-table">
                    <thead id="at-thead"></thead>
                    <tbody id="at-tbody"></tbody>
                </table>
            </div>

            <div class="pagination" id="at-pagination">
                <span id="at-page-info">Page 1</span>
                <button onclick="changePage('at', -1)">Previous</button>
                <button onclick="changePage('at', 1)">Next</button>
                <select id="at-page-size" onchange="changePageSize('at')">
                    <option value="50">50 per page</option>
                    <option value="100">100 per page</option>
                    <option value="all" selected>Show All</option>
                </select>
            </div>

            <div class="totals-bar" id="at-totals"></div>
        </div>

        <!-- AT NYC Tab -->
        <div id="at-nyc" class="tab-content">
            <div class="controls">
                <button class="btn btn-primary" onclick="loadAllData()">📄 Load All</button>
                <button class="btn" onclick="refreshData('at-nyc')">🔄 Refresh</button>
                <button class="btn btn-danger" onclick="clearData('at-nyc')">🗑️ Clear</button>
                <div class="filter-item" style="margin-left: auto;">
                    <input type="checkbox" id="at-nyc-show-extra" onchange="toggleExtraColumns('at-nyc')">
                    <label for="at-nyc-show-extra">Extra Data</label>
                </div>
            </div>

            <div class="progress-container" id="at-nyc-progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="at-nyc-progress-fill" style="width: 0%">0%</div>
                </div>
                <div class="progress-status" id="at-nyc-progress-status">Initializing...</div>
            </div>

            <div class="filters" id="at-nyc-filters">
                <div class="filter-section">
                    <label>Visibility</label>
                    <div class="filter-item">
                        <input type="checkbox" id="at-nyc-filter-paid" checked onchange="debouncedApplyFilters('at-nyc')">
                        <label for="at-nyc-filter-paid">Paid</label>
                    </div>
                    <div class="filter-item">
                        <input type="checkbox" id="at-nyc-filter-requested" checked onchange="debouncedApplyFilters('at-nyc')">
                        <label for="at-nyc-filter-requested">Requested</label>
                    </div>
                    <div class="filter-item">
                        <input type="checkbox" id="at-nyc-filter-disqualified" checked onchange="debouncedApplyFilters('at-nyc')">
                        <label for="at-nyc-filter-disqualified">Disqualified</label>
                    </div>
                    <div class="filter-item">
                        <input type="checkbox" id="at-nyc-filter-unpaid" checked onchange="debouncedApplyFilters('at-nyc')">
                        <label for="at-nyc-filter-unpaid">Unpaid</label>
                    </div>
                </div>

                <div class="filter-section">
                    <label>Quick Filters</label>
                    <div class="filter-item">
                        <select id="at-nyc-filter-payment-status" onchange="debouncedApplyFilters('at-nyc')">
                            <option value="">All Payment Status</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <select id="at-nyc-filter-company" onchange="debouncedApplyFilters('at-nyc')">
                            <option value="">All Companies</option>
                        </select>
                    </div>
                </div>

                <div class="filter-section">
                    <label>Search</label>
                    <div class="filter-item">
                        <input type="text" id="at-nyc-filter-search" placeholder="Search all columns..." onkeyup="debouncedApplyFilters('at-nyc')">
                    </div>
                </div>
            </div>

            <div class="status-bar" id="at-nyc-status"></div>

            <div class="table-container" id="at-nyc-table-container">
                <table id="at-nyc-table">
                    <thead id="at-nyc-thead"></thead>
                    <tbody id="at-nyc-tbody"></tbody>
                </table>
            </div>

            <div class="pagination" id="at-nyc-pagination">
                <span id="at-nyc-page-info">Page 1</span>
                <button onclick="changePage('at-nyc', -1)">Previous</button>
                <button onclick="changePage('at-nyc', 1)">Next</button>
                <select id="at-nyc-page-size" onchange="changePageSize('at-nyc')">
                    <option value="50">50 per page</option>
                    <option value="100">100 per page</option>
                    <option value="all" selected>Show All</option>
                </select>
            </div>

            <div class="totals-bar" id="at-nyc-totals"></div>
        </div>

        <!-- MBT Tab -->
        <div id="mbt" class="tab-content">
            <div class="controls">
                <button class="btn btn-primary" onclick="loadAllData()">📄 Load All</button>
                <button class="btn" onclick="refreshData('mbt')">🔄 Refresh</button>
                <button class="btn btn-danger" onclick="clearData('mbt')">🗑️ Clear</button>
                <div class="filter-item" style="margin-left: auto;">
                    <input type="checkbox" id="mbt-show-extra" onchange="toggleExtraColumns('mbt')">
                    <label for="mbt-show-extra">Extra Data</label>
                </div>
            </div>

            <div class="progress-container" id="mbt-progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="mbt-progress-fill" style="width: 0%">0%</div>
                </div>
                <div class="progress-status" id="mbt-progress-status">Initializing...</div>
            </div>

            <div class="filters" id="mbt-filters">
                <div class="filter-section">
                    <label>Visibility</label>
                    <div class="filter-item">
                        <input type="checkbox" id="mbt-filter-paid" checked onchange="debouncedApplyFilters('mbt')">
                        <label for="mbt-filter-paid">Paid</label>
                    </div>
                    <div class="filter-item">
                        <input type="checkbox" id="mbt-filter-requested" checked onchange="debouncedApplyFilters('mbt')">
                        <label for="mbt-filter-requested">Requested</label>
                    </div>
                    <div class="filter-item">
                        <input type="checkbox" id="mbt-filter-disqualified" checked onchange="debouncedApplyFilters('mbt')">
                        <label for="mbt-filter-disqualified">Disqualified</label>
                    </div>
                    <div class="filter-item">
                        <input type="checkbox" id="mbt-filter-unpaid" checked onchange="debouncedApplyFilters('mbt')">
                        <label for="mbt-filter-unpaid">Unpaid</label>
                    </div>
                </div>

                <div class="filter-section">
                    <label>Quick Filters</label>
                    <div class="filter-item">
                        <select id="mbt-filter-payment-status" onchange="debouncedApplyFilters('mbt')">
                            <option value="">All Payment Status</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <select id="mbt-filter-company" onchange="debouncedApplyFilters('mbt')">
                            <option value="">All Companies</option>
                        </select>
                    </div>
                </div>

                <div class="filter-section">
                    <label>Search</label>
                    <div class="filter-item">
                        <input type="text" id="mbt-filter-search" placeholder="Search all columns..." onkeyup="debouncedApplyFilters('mbt')">
                    </div>
                </div>
            </div>

            <div class="status-bar" id="mbt-status"></div>

            <div class="table-container" id="mbt-table-container">
                <table id="mbt-table">
                    <thead id="mbt-thead"></thead>
                    <tbody id="mbt-tbody"></tbody>
                </table>
            </div>

            <div class="pagination" id="mbt-pagination">
                <span id="mbt-page-info">Page 1</span>
                <button onclick="changePage('mbt', -1)">Previous</button>
                <button onclick="changePage('mbt', 1)">Next</button>
                <select id="mbt-page-size" onchange="changePageSize('mbt')">
                    <option value="50">50 per page</option>
                    <option value="100">100 per page</option>
                    <option value="all" selected>Show All</option>
                </select>
            </div>

            <div class="totals-bar" id="mbt-totals"></div>
        </div>

        <!-- NEW MONEY Tab -->
        <div id="new-money" class="tab-content">
            <div class="money-header">
                <div class="money-emoji">💰💵💸</div>
                <h2>New Money Waiting to Collect</h2>
                <p style="font-size: 0.95em; opacity: 0.95;">Summonses marked "Paid in Full" but not yet collected from NYC</p>
            </div>

            <div class="controls">
                <button class="btn btn-success" onclick="refreshNewMoney()">🔄 Refresh New Money</button>
            </div>

            <div class="money-card">
                <h3>💚 AT Dataset</h3>
                <div class="table-container">
                    <table id="new-money-at-table">
                        <thead id="new-money-at-thead"></thead>
                        <tbody id="new-money-at-tbody"></tbody>
                    </table>
                </div>
                <div class="money-total" id="new-money-at-totals"></div>
            </div>

            <div class="money-card">
                <h3>💙 AT NYC Dataset</h3>
                <div class="table-container">
                    <table id="new-money-at-nyc-table">
                        <thead id="new-money-at-nyc-thead"></thead>
                        <tbody id="new-money-at-nyc-tbody"></tbody>
                    </table>
                </div>
                <div class="money-total" id="new-money-at-nyc-totals"></div>
            </div>

            <div class="money-card">
                <h3>💛 MBT Dataset</h3>
                <div class="table-container">
                    <table id="new-money-mbt-table">
                        <thead id="new-money-mbt-thead"></thead>
                        <tbody id="new-money-mbt-tbody"></tbody>
                    </table>
                </div>
                <div class="money-total" id="new-money-mbt-totals"></div>
            </div>
        </div>

        <!-- DISCREPANCIES Tab -->
        <div id="discrepancies" class="tab-content">
            <div class="controls">
                <button class="btn btn-primary" onclick="generateDiscrepancies()">🔍 Generate Reports</button>
            </div>

            <div class="dataset-section">
                <h3>Payment Amount Mismatches</h3>
                <p style="margin-bottom: 15px; color: #666; font-size: 0.9em;">Invoices where the amount you received doesn't match 25% of what NYC was paid.</p>
                <div id="discrepancies-mismatches"></div>
            </div>

            <div class="dataset-section">
                <h3>Paid But Not "Paid in Full"</h3>
                <p style="margin-bottom: 15px; color: #666; font-size: 0.9em;">Summonses with a Paid Amount above zero but Hearing Status is not "Paid in Full".</p>
                <div id="discrepancies-paid-not-full"></div>
            </div>

            <div class="dataset-section">
                <h3>Orphaned Payments</h3>
                <p style="margin-bottom: 15px; color: #666; font-size: 0.9em;">Payments in your "Paid" sheet that don't have a corresponding entry in the master dataset.</p>
                <div id="discrepancies-orphaned"></div>
            </div>
        </div>

        <!-- TRENDS Tab -->
        <div id="trends" class="tab-content">
            <div style="background: white; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                <h3 style="color: #1e3c72; margin-bottom: 12px;">📈 Trends Over Time</h3>
                <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">Track how your summons data changes over time with interactive trend analysis.</p>
                
                <div class="controls">
                    <button class="btn btn-primary" onclick="generateAllTrends()">🔄 Generate All Trends</button>
                    <div class="filter-item">
                        <select id="trends-dataset" onchange="generateAllTrends()">
                            <option value="all">All Datasets</option>
                            <option value="at">AT Only</option>
                            <option value="at-nyc">AT NYC Only</option>
                            <option value="mbt">MBT Only</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <select id="trends-grouping" onchange="generateAllTrends()">
                            <option value="month">By Month</option>
                            <option value="quarter">By Quarter</option>
                            <option value="year">By Year</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Summons Volume Over Time -->
            <div class="chart-section">
                <h4 style="color: #1e3c72; margin-bottom: 10px; font-size: 1em;">📊 Summons Volume Over Time</h4>
                <p style="color: #666; font-size: 0.85em; margin-bottom: 12px;">Total number of summonses issued per time period</p>
                <div class="chart-canvas-container">
                    <canvas id="trend-volume-chart"></canvas>
                </div>
            </div>

            <!-- Payment Status Trend -->
            <div class="chart-section">
                <h4 style="color: #1e3c72; margin-bottom: 10px; font-size: 1em;">💰 Payment Collection Trend</h4>
                <p style="color: #666; font-size: 0.85em; margin-bottom: 12px;">Track how payments, requests, and disqualifications change over time</p>
                <div class="chart-canvas-container">
                    <canvas id="trend-payment-chart"></canvas>
                </div>
            </div>

            <!-- Revenue Over Time -->
            <div class="chart-section">
                <h4 style="color: #1e3c72; margin-bottom: 10px; font-size: 1em;">💵 Revenue Over Time</h4>
                <p style="color: #666; font-size: 0.85em; margin-bottom: 12px;">Total amount paid to NYC and your 25% share</p>
                <div class="chart-canvas-container">
                    <canvas id="trend-revenue-chart"></canvas>
                </div>
            </div>

            <!-- Disqualification Rate -->
            <div class="chart-section">
                <h4 style="color: #1e3c72; margin-bottom: 10px; font-size: 1em;">❌ Disqualification Rate Over Time</h4>
                <p style="color: #666; font-size: 0.85em; margin-bottom: 12px;">Percentage of cases disqualified per period</p>
                <div class="chart-canvas-container">
                    <canvas id="trend-disqualification-chart"></canvas>
                </div>
            </div>

            <!-- Key Metrics Summary -->
            <div style="background: white; padding: 15px; border-radius: 6px; margin-top: 15px;">
                <h4 style="color: #1e3c72; margin-bottom: 12px; font-size: 1em;">📋 Period Comparison</h4>
                <div id="period-comparison" style="overflow-x: auto;">
                    <p style="color: #666; font-size: 0.85em;">Generate trends to see period-over-period comparisons</p>
                </div>
            </div>

            <!-- Top Companies Trend -->
            <div class="chart-section">
                <h4 style="color: #1e3c72; margin-bottom: 10px; font-size: 1em;">🏢 Top Companies Activity Over Time</h4>
                <p style="color: #666; font-size: 0.85em; margin-bottom: 12px;">Track summons volume for top 5 companies</p>
                <div class="chart-canvas-container">
                    <canvas id="trend-companies-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- FUN FACTS Tab -->
        <div id="fun-facts" class="tab-content">
            <div class="controls">
                <button class="btn btn-primary" onclick="generateFunFacts()">🎉 Generate Fun Facts</button>
            </div>
            <div id="fun-facts-container" style="display: grid; grid-template-columns: 1fr; gap: 15px; margin-top: 20px;"></div>
        </div>

        <!-- CHARTS Tab -->
        <div id="charts" class="tab-content">
            <div class="chart-section">
                <h3 style="margin-bottom: 15px; color: #1e3c72;">📊 Data Visualizations</h3>
                
                <!-- Quick Insights -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                    <h4 style="color: #1e3c72; margin-bottom: 10px; font-size: 1em;">⚡ Quick Insights</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px;">
                        <button class="btn btn-primary" onclick="showPaymentStatusChart()" style="font-size: 0.75em; padding: 8px;">Payment Status</button>
                        <button class="btn btn-primary" onclick="showCompanyChart()" style="font-size: 0.75em; padding: 8px;">Top Companies</button>
                        <button class="btn btn-primary" onclick="showBoroughChart()" style="font-size: 0.75em; padding: 8px;">By Borough</button>
                        <button class="btn btn-primary" onclick="showMonthlyTrend()" style="font-size: 0.75em; padding: 8px;">Monthly Trend</button>
                        <button class="btn btn-primary" onclick="showHearingResults()" style="font-size: 0.75em; padding: 8px;">Hearing Results</button>
                        <button class="btn btn-primary" onclick="showRevenueAnalysis()" style="font-size: 0.75em; padding: 8px;">Revenue Analysis</button>
                    </div>
                </div>

                <!-- Custom Chart Builder -->
                <div style="background: white; padding: 15px; border-radius: 6px; margin-bottom: 20px; border: 2px solid #5a7fa7;">
                    <h4 style="color: #1e3c72; margin-bottom: 12px; font-size: 1em;">🎨 Custom Chart Builder</h4>
                    
                    <div class="chart-type-buttons">
                        <button class="chart-type-btn active" onclick="setChartType('pie')">Pie</button>
                        <button class="chart-type-btn" onclick="setChartType('bar')">Bar</button>
                        <button class="chart-type-btn" onclick="setChartType('line')">Line</button>
                        <button class="chart-type-btn" onclick="setChartType('doughnut')">Doughnut</button>
                        <button class="chart-type-btn" onclick="setChartType('horizontalBar')">H-Bar</button>
                    </div>

                    <div class="chart-controls">
                        <div class="chart-control-group">
                            <label>📁 Data Source</label>
                            <select id="chart-tab-selector">
                                <option value="all">All Datasets Combined</option>
                                <option value="at">AT Only</option>
                                <option value="at-nyc">AT NYC Only</option>
                                <option value="mbt">MBT Only</option>
                            </select>
                        </div>

                        <div class="chart-control-group">
                            <label>📊 Measure</label>
                            <select id="chart-measure">
                                <option value="count">Count of Records</option>
                                <option value="sum-paid">Sum of Paid Amount</option>
                                <option value="avg-paid">Average Paid Amount</option>
                                <option value="sum-balance">Sum of Balance Due</option>
                            </select>
                        </div>

                        <div class="chart-control-group">
                            <label>🏷️ Group By</label>
                            <select id="chart-field-selector">
                                <option value="Payment Status">Payment Status</option>
                                <option value="Status">Status</option>
                                <option value="Hearing Status">Hearing Status</option>
                                <option value="Hearing Result">Hearing Result</option>
                                <option value="Company Name">Company Name</option>
                                <option value="Issuing Agency">Issuing Agency</option>
                                <option value="Violation Location (Borough)">Borough</option>
                                <option value="month">Month (from Violation Date)</option>
                                <option value="year">Year (from Violation Date)</option>
                            </select>
                        </div>

                        <div class="chart-control-group">
                            <label>🎯 Filter by Status</label>
                            <select id="chart-status-filter">
                                <option value="">All Statuses</option>
                                <option value="paid">Paid Only</option>
                                <option value="requested">Requested Only</option>
                                <option value="disqualified">Disqualified Only</option>
                                <option value="unpaid">Unpaid Only</option>
                            </select>
                        </div>

                        <div class="chart-control-group">
                            <label>📅 Date Range</label>
                            <select id="chart-date-range">
                                <option value="all">All Time</option>
                                <option value="ytd">Year to Date</option>
                                <option value="last-12">Last 12 Months</option>
                                <option value="last-6">Last 6 Months</option>
                                <option value="last-3">Last 3 Months</option>
                                <option value="this-year">This Year</option>
                                <option value="last-year">Last Year</option>
                            </select>
                        </div>

                        <div class="chart-control-group">
                            <label>🔢 Max Items</label>
                            <select id="chart-max-items">
                                <option value="5">Top 5</option>
                                <option value="10" selected>Top 10</option>
                                <option value="15">Top 15</option>
                                <option value="20">Top 20</option>
                                <option value="all">Show All</option>
                            </select>
                        </div>

                        <div class="chart-control-group">
                            <label>📈 Sort By</label>
                            <select id="chart-sort">
                                <option value="value-desc">Value (High to Low)</option>
                                <option value="value-asc">Value (Low to High)</option>
                                <option value="label-asc">Label (A to Z)</option>
                                <option value="label-desc">Label (Z to A)</option>
                            </select>
                        </div>

                        <div class="chart-control-group">
                            <label>🎨 Color Scheme</label>
                            <select id="chart-color-scheme">
                                <option value="default">Default Rainbow</option>
                                <option value="blue">Blue Gradient</option>
                                <option value="green">Green Gradient</option>
                                <option value="red">Red Gradient</option>
                                <option value="purple">Purple Gradient</option>
                                <option value="status">Status Colors</option>
                            </select>
                        </div>
                    </div>

                    <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 15px;">
                        <button class="btn btn-primary" onclick="updateGlobalChart()">🎨 Generate Chart</button>
                        <button class="btn btn-success" onclick="exportChartImage()">💾 Save as Image</button>
                        <button class="btn" onclick="exportChartDataCSV()">📄 Export Data (CSV)</button>
                    </div>
                </div>

                <!-- Chart Display Area -->
                <div style="background: white; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                    <div id="chart-title" style="text-align: center; font-size: 1.1em; font-weight: bold; color: #1e3c72; margin-bottom: 15px;">
                        Select options and click Generate Chart
                    </div>
                    <div class="chart-canvas-container">
                        <canvas id="global-chart"></canvas>
                    </div>
                </div>

                <!-- Statistics Panel -->
                <div id="chart-stats" style="background: #f8f9fa; padding: 15px; border-radius: 6px; display: none;"></div>

                <!-- Data Table -->
                <div id="chart-data-table" style="background: white; padding: 15px; border-radius: 6px; margin-top: 20px; display: none;">
                    <h4 style="color: #1e3c72; margin-bottom: 10px; font-size: 1em;">📋 Chart Data</h4>
                    <div style="overflow-x: auto;">
                        <table id="chart-table" style="width: 100%; font-size: 0.85em;">
                            <thead id="chart-table-head"></thead>
                            <tbody id="chart-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- SETTINGS Tab -->
        <div id="settings" class="tab-content">
            <div class="settings-panel">
                <div class="settings-section">
                    <h3>📊 Google Sheets Configuration</h3>
                    <p style="margin-bottom: 15px; color: #666; font-size: 0.9em;">Enter the URLs of your Google Sheets. Make sure each sheet is published to the web (File → Share → Publish to web → CSV format).</p>
                    
                    <h4 style="margin: 15px 0 10px 0; color: #1e3c72;">AT Dataset</h4>
                    <div class="sheet-input-group">
                        <label>Master Data:</label>
                        <input type="text" id="sheet-at-master" placeholder="https://docs.google.com/..." onchange="saveSheetURLs()">
                    </div>
                    <div class="sheet-input-group">
                        <label>Paid from NYC:</label>
                        <input type="text" id="sheet-at-paid" placeholder="https://docs.google.com/..." onchange="saveSheetURLs()">
                    </div>
                    <div class="sheet-input-group">
                        <label>Payment Requests:</label>
                        <input type="text" id="sheet-at-requests" placeholder="https://docs.google.com/..." onchange="saveSheetURLs()">
                    </div>

                    <h4 style="margin: 15px 0 10px 0; color: #1e3c72;">AT NYC Dataset</h4>
                    <div class="sheet-input-group">
                        <label>Master Data:</label>
                        <input type="text" id="sheet-at-nyc-master" placeholder="https://docs.google.com/..." onchange="saveSheetURLs()">
                    </div>
                    <div class="sheet-input-group">
                        <label>Paid from NYC:</label>
                        <input type="text" id="sheet-at-nyc-paid" placeholder="https://docs.google.com/..." onchange="saveSheetURLs()">
                    </div>
                    <div class="sheet-input-group">
                        <label>Payment Requests:</label>
                        <input type="text" id="sheet-at-nyc-requests" placeholder="https://docs.google.com/..." onchange="saveSheetURLs()">
                    </div>

                    <h4 style="margin: 15px 0 10px 0; color: #1e3c72;">MBT Dataset</h4>
                    <div class="sheet-input-group">
                        <label>Master Data:</label>
                        <input type="text" id="sheet-mbt-master" placeholder="https://docs.google.com/..." onchange="saveSheetURLs()">
                    </div>
                    <div class="sheet-input-group">
                        <label>Paid from NYC:</label>
                        <input type="text" id="sheet-mbt-paid" placeholder="https://docs.google.com/..." onchange="saveSheetURLs()">
                    </div>
                    <div class="sheet-input-group">
                        <label>Payment Requests:</label>
                        <input type="text" id="sheet-mbt-requests" placeholder="https://docs.google.com/..." onchange="saveSheetURLs()">
                    </div>

                    <button class="btn btn-success" onclick="loadAllData()">Load All Data</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global data storage
        const appData = {
            'at': { master: [], paid: [], requests: [], merged: [], filtered: [], currentPage: 1, pageSize: 'all', showExtra: false, lastRefreshSheets: null, lastRefreshNYC: null },
            'at-nyc': { master: [], paid: [], requests: [], merged: [], filtered: [], currentPage: 1, pageSize: 'all', showExtra: false, lastRefreshSheets: null, lastRefreshNYC: null },
            'mbt': { master: [], paid: [], requests: [], merged: [], filtered: [], currentPage: 1, pageSize: 'all', showExtra: false, lastRefreshSheets: null, lastRefreshNYC: null }
        };

        const sheetURLs = {
            'at': { 
                master: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ1o9qMz_zElO_r9I5ViHfeBmRQCv46NiecZoLDAOG76oojqjMnkd2Sy1MWZFYDYyE5RJ7OpFZXQ9Vb/pub?output=csv', 
                paid: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTwItpq2AsDCUfw9cEkRGe3E9JqXmIKQXztaXJSXiM4M6u1kwTzfszMAw3CgKXCa8tteoidy0MyMMoh/pub?output=csv', 
                requests: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS6Z2wJLGR3zBW0dSUxReBhrgzu0iKOpUURySRtnjL5R-7JJp_F8UCyqBO9kcJoJAmertKe7yQwuX31/pub?output=csv' 
            },
            'at-nyc': { 
                master: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRncTRjr3qqbr3n0iFhLr7kJ-1pwpVg9t1NJtR2RQFHsuq2QAQcyo75WgyQ1MVqZcY5gfDw2zy8jM67/pub?output=csv', 
                paid: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSKFvWDobRvxkaLQUZoVFh-YLag37CTTubJMRYS7KpS_Xv4a7ts3bhvdlU1s_mKiQY5FWKpaW7SjD2H/pub?output=csv', 
                requests: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT7mgKpDJmK_BbcK98IZUqUm2S5zk97nLdxndeVKAtOF5gjMzgjIGrSfm18fj5lFWEGgfJMJh8ZvmEC/pub?output=csv' 
            },
            'mbt': { 
                master: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQEdHNxEgIJnRElve2T6iUA-racSM-4Y871MGa6ruZ_Id8pGaENVZOAHRwOqNeypl7unfnSlHVgKnjK/pub?output=csv', 
                paid: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRBmD38Ggf3XOiDTgkmAjW0zOQfmTJyQTSxHFdj4GtgugY1L0ZO4gkgWvOcBT8OlgQ5TJSOL27_qM86/pub?output=csv', 
                requests: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTZtnehNQnyC0Zd794OvuYJtUVQFMou3IWUdnOQY491BNisPe3aIYvYHjsxJkTbtb_Eo9TW0H8u-Wzn/pub?output=csv' 
            }
        };

        let currentSortColumn = {};
        let currentSortDirection = {};
        let globalChart = null;
        let currentChartType = 'pie';
        let autoRefreshInterval = null;
        let filterDebounceTimers = {};

        const extraNYCFields = [
            'Violation Time', 'Issuing Agency', 'Respondent First Name', 'Respondent Last Name',
            'Balance Due', 'Violation Location (Borough)', 'Violation Location (House #)',
            'Violation Location (Street Name)', 'Hearing Result', 'Total Violation Amount'
        ];
        
        const defaultColumns = [
            'Complaint Number', 'Summons Number', 'Violation Date', 'Company Name',
            'Place of Occurrence', 'Status', 'Date Submitted', 'Hearing Date',
            'Paid Amount', 'Paid To Me', 'Payment Status', 'Payment Received',
            'Hearing Status', 'Hearing Result'
        ];

        const nycFieldMapping = {
            'ticket_number': 'Ticket Number',
            'violation_date': 'Violation Date',
            'respondent_last_name': 'Respondent Last Name',
            'paid_amount': 'Paid Amount',
            'hearing_status': 'Hearing Status',
            'hearing_date': 'Hearing Date',
            'violation_time': 'Violation Time',
            'issuing_agency': 'Issuing Agency',
            'respondent_first_name': 'Respondent First Name',
            'balance_due': 'Balance Due',
            'violation_location_borough': 'Violation Location (Borough)',
            'violation_location_house': 'Violation Location (House #)',
            'violation_location_street_name': 'Violation Location (Street Name)',
            'hearing_result': 'Hearing Result',
            'total_violation_amount': 'Total Violation Amount'
        };

        function formatDate(dateStr) {
            if (!dateStr) return '';
            return dateStr.replace(/T\d{2}:\d{2}:\d{2}\.\d{3}/, '');
        }

        function toggleExtraColumns(tab) {
            appData[tab].showExtra = document.getElementById(`${tab}-show-extra`).checked;
            renderTable(tab);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function debouncedApplyFilters(tab) {
            if (filterDebounceTimers[tab]) {
                clearTimeout(filterDebounceTimers[tab]);
            }
            filterDebounceTimers[tab] = setTimeout(() => {
                applyFilters(tab);
            }, 300);
        }

        function getColumns(tab) {
            const filteredData = appData[tab].filtered;
            if (filteredData.length === 0) return [];

            const allColumnsSet = new Set();
            filteredData.forEach(row => {
                Object.keys(row).forEach(col => {
                    if (!col.startsWith('_')) {
                        allColumnsSet.add(col);
                    }
                });
            });
            let allColumns = Array.from(allColumnsSet);
            
            let columns = [];
            
            if (!appData[tab].showExtra) {
                columns = defaultColumns.filter(col => allColumns.includes(col));
            } else {
                columns = defaultColumns.filter(col => allColumns.includes(col));
                extraNYCFields.forEach(field => {
                    if (!columns.includes(field)) {
                        columns.push(field);
                    }
                });
            }

            return columns;
        }

        window.onload = function() {
            loadSheetURLs();
            loadFromStorage();
            startAutoRefresh();
        };

        function startAutoRefresh() {
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
            autoRefreshInterval = setInterval(() => {
                loadAllData(true);
            }, 300000);
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            
            const tabElement = document.getElementById(tabName);
            tabElement.classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'new-money') {
                renderNewMoney();
            }
        }

        function convertToCSVUrl(url) {
            if (!url) return '';
            if (url.includes('pub?output=csv') || url.includes('export?format=csv')) {
                return url;
            }
            const match = url.match(/\/d\/([a-zA-Z0-9-_]+)/);
            if (match) {
                const sheetId = match[1];
                return `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv`;
            }
            return url;
        }

        async function fetchWithCORS(url) {
            try {
                const response = await fetch(url);
                if (response.ok) {
                    return await response.text();
                }
            } catch (error) {
                console.log('Direct fetch failed, trying CORS proxy...');
            }

            const corsProxies = [
                `https://corsproxy.io/?${encodeURIComponent(url)}`,
                `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`
            ];

            for (const proxyUrl of corsProxies) {
                try {
                    const response = await fetch(proxyUrl);
                    if (response.ok) {
                        return await response.text();
                    }
                } catch (error) {
                    console.log('Proxy failed:', error.message);
                }
            }

            throw new Error('Failed to fetch from Google Sheets');
        }

        function saveSheetURLs() {
            ['at', 'at-nyc', 'mbt'].forEach(tab => {
                sheetURLs[tab].master = document.getElementById(`sheet-${tab}-master`).value;
                sheetURLs[tab].paid = document.getElementById(`sheet-${tab}-paid`).value;
                sheetURLs[tab].requests = document.getElementById(`sheet-${tab}-requests`).value;
            });
            localStorage.setItem('sheetURLs', JSON.stringify(sheetURLs));
        }

        function loadSheetURLs() {
            const saved = localStorage.getItem('sheetURLs');
            if (saved) {
                const loaded = JSON.parse(saved);
                ['at', 'at-nyc', 'mbt'].forEach(tab => {
                    if (loaded[tab]) {
                        sheetURLs[tab] = loaded[tab];
                        if (sheetURLs[tab].master) document.getElementById(`sheet-${tab}-master`).value = sheetURLs[tab].master;
                        if (sheetURLs[tab].paid) document.getElementById(`sheet-${tab}-paid`).value = sheetURLs[tab].paid;
                        if (sheetURLs[tab].requests) document.getElementById(`sheet-${tab}-requests`).value = sheetURLs[tab].requests;
                    }
                });
            }
        }

        async function loadAllData(silent = false) {
            if (!silent) updateProgress('at', 0, 'Loading data from Google Sheets...');
            
            for (const tab of ['at', 'at-nyc', 'mbt']) {
                try {
                    if (sheetURLs[tab].master) {
                        const masterData = await fetchCSVFromSheet(convertToCSVUrl(sheetURLs[tab].master));
                        appData[tab].master = masterData;
                    }
                    if (sheetURLs[tab].paid) {
                        const paidData = await fetchCSVFromSheet(convertToCSVUrl(sheetURLs[tab].paid));
                        appData[tab].paid = paidData;
                    }
                    if (sheetURLs[tab].requests) {
                        const requestsData = await fetchCSVFromSheet(convertToCSVUrl(sheetURLs[tab].requests));
                        appData[tab].requests = requestsData;
                    }

                    appData[tab].lastRefreshSheets = new Date().toISOString();

                    mergeData(tab);
                    await enrichFromNYC(tab, true);
                    applyFilters(tab);
                    populateFilterDropdowns(tab);
                } catch (error) {
                    console.error(`Error loading ${tab}:`, error);
                }
            }

            saveToStorage();
            if (!silent) {
                updateProgress('at', 100, 'Data loaded successfully!');
                alert('All data loaded from Google Sheets!');
            }
        }

        async function fetchCSVFromSheet(url) {
            const text = await fetchWithCORS(url);
            const parsed = parseCSV(text);
            return parsed;
        }

        function parseCSV(text) {
            const rows = [];
            let currentRow = [];
            let currentCell = '';
            let insideQuotes = false;
            
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const nextChar = text[i + 1];
                
                if (char === '"') {
                    if (insideQuotes && nextChar === '"') {
                        currentCell += '"';
                        i++;
                    } else {
                        insideQuotes = !insideQuotes;
                    }
                } else if (char === ',' && !insideQuotes) {
                    currentRow.push(currentCell.trim());
                    currentCell = '';
                } else if ((char === '\n' || char === '\r') && !insideQuotes) {
                    if (char === '\r' && nextChar === '\n') {
                        i++;
                    }
                    if (currentCell || currentRow.length > 0) {
                        currentRow.push(currentCell.trim());
                        if (currentRow.some(cell => cell.length > 0)) {
                            rows.push(currentRow);
                        }
                        currentRow = [];
                        currentCell = '';
                    }
                } else {
                    currentCell += char;
                }
            }
            
            if (currentCell || currentRow.length > 0) {
                currentRow.push(currentCell.trim());
                if (currentRow.some(cell => cell.length > 0)) {
                    rows.push(currentRow);
                }
            }
            
            if (rows.length === 0) return [];
            
            const headers = rows[0].map(h => h.trim());
            const data = [];
            
            for (let i = 1; i < rows.length; i++) {
                const row = {};
                const values = rows[i];
                
                headers.forEach((header, index) => {
                    row[header] = values[index] ? values[index].trim() : '';
                });
                
                const hasData = Object.values(row).some(val => val.length > 0);
                if (hasData) {
                    data.push(row);
                }
            }
            
            return data;
        }

        function mergeData(tab) {
            const master = appData[tab].master;
            const paid = appData[tab].paid;
            const requests = appData[tab].requests;

            if (master.length === 0) {
                appData[tab].merged = [];
                return;
            }

            const paidMap = {};
            paid.forEach(row => {
                const summonsNum = row['Summons #'] || row['Summons Number'];
                if (summonsNum) paidMap[summonsNum.trim()] = row;
            });

            const requestsMap = {};
            requests.forEach(row => {
                const summonsNum = row['Complaint Number'] || row['Summons Number'];
                if (summonsNum) requestsMap[summonsNum.trim()] = row;
            });

            const merged = master.map(row => {
                const summonsNum = (row['Summons Number'] || '').trim();
                const newRow = { ...row };

                if (!newRow['Paid Amount']) newRow['Paid Amount'] = '';
                if (!newRow['Hearing Status']) newRow['Hearing Status'] = '';

                // Check if status is "Submitted"
                const status = (row['Status'] || '').toLowerCase();
                if (status === 'submitted') {
                    newRow['_rowType'] = 'submitted';
                }

                if (summonsNum && paidMap[summonsNum]) {
                    newRow['_rowType'] = 'paid';
                    
                    const paidRow = paidMap[summonsNum];
                    Object.keys(paidRow).forEach(key => {
                        if (key !== 'Summons #' && key !== 'Summons Number') {
                            newRow[key] = paidRow[key];
                        }
                    });
                    
                    newRow['Payment Status'] = 'PAID TO ME';
                } else if (summonsNum && requestsMap[summonsNum]) {
                    if (newRow['_rowType'] !== 'submitted') {
                        newRow['_rowType'] = 'requested';
                    }
                    
                    Object.keys(requestsMap[summonsNum]).forEach(key => {
                        if (key !== 'Complaint Number' && key !== 'Summons Number') {
                            newRow[key] = requestsMap[summonsNum][key];
                        }
                    });
                    newRow['Payment Status'] = 'REQUESTED';
                }
                
                const hearingResult = (row['Hearing Result'] || newRow['Hearing Result'] || '').toLowerCase();
                if (status.includes('disqualified') || hearingResult.includes('dismissed')) {
                    newRow['_rowType'] = 'disqualified';
                }

                return newRow;
            });

            appData[tab].merged = merged;
        }

        async function enrichFromNYC(tab, silent = false) {
            const data = appData[tab].merged;
            if (data.length === 0) return;

            try {
                const summonsNumbers = data.map(row => row['Summons Number']).filter(num => num && num.trim() !== '');
                if (summonsNumbers.length === 0) return;

                const batchSize = 50;
                const enrichedDataMap = {};

                for (let i = 0; i < summonsNumbers.length; i += batchSize) {
                    const batch = summonsNumbers.slice(i, i + batchSize);
                    const ticketNumbers = batch.map(num => `'${num}'`).join(',');
                    const url = `https://data.cityofnewyork.us/resource/jz4z-kudi.json?$where=ticket_number IN (${ticketNumbers})&$limit=1000`;

                    const response = await fetch(url);
                    const nycData = await response.json();

                    nycData.forEach(item => {
                        enrichedDataMap[item.ticket_number] = item;
                    });
                }

                appData[tab].merged = data.map(row => {
                    const summonsNum = (row['Summons Number'] || '').trim();
                    if (summonsNum && enrichedDataMap[summonsNum]) {
                        const nycRow = enrichedDataMap[summonsNum];
                        const enrichedRow = { ...row };
                        
                        Object.keys(nycFieldMapping).forEach(apiField => {
                            const displayName = nycFieldMapping[apiField];
                            if (nycRow[apiField] !== undefined && nycRow[apiField] !== null) {
                                enrichedRow[displayName] = nycRow[apiField];
                            }
                        });

                        return enrichedRow;
                    }
                    return row;
                });

                appData[tab].lastRefreshNYC = new Date().toISOString();

                saveToStorage();
            } catch (error) {
                console.error('Enrichment error:', error);
            }
        }

        function refreshData(tab) {
            loadAllData();
        }

        function clearData(tab) {
            if (!confirm(`Clear all data for ${tab.toUpperCase()}?`)) return;
            appData[tab] = { master: [], paid: [], requests: [], merged: [], filtered: [], currentPage: 1, pageSize: 'all' };
            saveToStorage();
            applyFilters(tab);
        }

        function populateFilterDropdowns(tab) {
            const data = appData[tab].merged;
            
            const paymentStatuses = new Set();
            const companies = new Set();
            
            data.forEach(row => {
                if (row['Payment Status']) paymentStatuses.add(row['Payment Status']);
                if (row['Company Name']) companies.add(row['Company Name']);
            });

            const paymentSelect = document.getElementById(`${tab}-filter-payment-status`);
            paymentSelect.innerHTML = '<option value="">All Payment Status</option>';
            [...paymentStatuses].sort().forEach(status => {
                paymentSelect.innerHTML += `<option value="${status}">${status}</option>`;
            });

            const companySelect = document.getElementById(`${tab}-filter-company`);
            companySelect.innerHTML = '<option value="">All Companies</option>';
            [...companies].sort().forEach(company => {
                companySelect.innerHTML += `<option value="${company}">${company}</option>`;
            });
        }

        function applyFilters(tab) {
            const data = appData[tab].merged;
            
            const showPaid = document.getElementById(`${tab}-filter-paid`).checked;
            const showRequested = document.getElementById(`${tab}-filter-requested`).checked;
            const showDisqualified = document.getElementById(`${tab}-filter-disqualified`).checked;
            const showUnpaid = document.getElementById(`${tab}-filter-unpaid`).checked;
            
            const paymentStatusFilter = document.getElementById(`${tab}-filter-payment-status`)?.value || '';
            const companyFilter = document.getElementById(`${tab}-filter-company`)?.value || '';
            const searchText = (document.getElementById(`${tab}-filter-search`)?.value || '').toLowerCase();

            const filteredData = data.filter(row => {
                if (row['_rowType'] === 'paid' && !showPaid) return false;
                if (row['_rowType'] === 'requested' && !showRequested) return false;
                if (row['_rowType'] === 'disqualified' && !showDisqualified) return false;
                
                const paymentStatus = (row['Payment Status'] || '').trim();
                if (!showUnpaid && !paymentStatus && row['_rowType'] !== 'submitted') return false;

                if (paymentStatusFilter && row['Payment Status'] !== paymentStatusFilter) return false;
                if (companyFilter && row['Company Name'] !== companyFilter) return false;

                if (searchText) {
                    const rowText = Object.values(row).join(' ').toLowerCase();
                    if (!rowText.includes(searchText)) return false;
                }
                
                return true;
            });

            appData[tab].filtered = filteredData;
            appData[tab].currentPage = 1;
            renderTable(tab);
        }

        function renderTable(tab) {
            const filteredData = appData[tab].filtered;
            const thead = document.getElementById(`${tab}-thead`);
            const tbody = document.getElementById(`${tab}-tbody`);

            if (filteredData.length === 0) {
                thead.innerHTML = '';
                tbody.innerHTML = '<tr><td colspan="100" style="text-align: center;">No data matches filters.</td></tr>';
                updateStatusBar(tab);
                updatePagination(tab);
                return;
            }

            const columns = getColumns(tab);

            thead.innerHTML = '<tr>' + columns.map(col => {
                return `<th onclick="sortTable('${tab}', '${col}')">${col} <span class="sort-indicator">${getSortIndicator(tab, col)}</span></th>`;
            }).join('') + '</tr>';

            const pageSize = appData[tab].pageSize;
            const currentPage = appData[tab].currentPage;
            const start = (currentPage - 1) * pageSize;
            const end = pageSize === 'all' ? filteredData.length : start + pageSize;
            const pageData = filteredData.slice(start, end);

            tbody.innerHTML = pageData.map(row => {
                let rowClass = '';
                if (row['_rowType'] === 'paid') rowClass = 'row-green';
                else if (row['_rowType'] === 'requested') rowClass = 'row-yellow';
                else if (row['_rowType'] === 'disqualified') rowClass = 'row-red';
                else if (row['_rowType'] === 'submitted') rowClass = 'row-gray';

                return '<tr class="' + rowClass + '">' + columns.map(col => {
                    let value = row[col] || '';
                    value = formatDate(value);
                    return `<td>${value}</td>`;
                }).join('') + '</tr>';
            }).join('');

            updateStatusBar(tab);
            updateTotalsBar(tab, filteredData);
            updatePagination(tab);
        }

        function updatePagination(tab) {
            const filtered = appData[tab].filtered;
            const pageSize = appData[tab].pageSize === 'all' ? filtered.length : appData[tab].pageSize;
            const totalPages = Math.ceil(filtered.length / pageSize);
            const currentPage = appData[tab].currentPage;

            const pageInfo = document.getElementById(`${tab}-page-info`);
            if (pageInfo) {
                pageInfo.textContent = `Page ${currentPage} of ${totalPages} (${filtered.length} total)`;
            }

            const pagination = document.getElementById(`${tab}-pagination`);
            if (!pagination) return;
            
            const prevBtn = pagination.querySelector('button:nth-child(2)');
            const nextBtn = pagination.querySelector('button:nth-child(3)');

            if (prevBtn) prevBtn.disabled = currentPage === 1;
            if (nextBtn) nextBtn.disabled = currentPage === totalPages || totalPages === 0;
        }

        function changePage(tab, direction) {
            appData[tab].currentPage += direction;
            renderTable(tab);
        }

        function changePageSize(tab) {
            const value = document.getElementById(`${tab}-page-size`).value;
            appData[tab].pageSize = value === 'all' ? 'all' : parseInt(value);
            appData[tab].currentPage = 1;
            renderTable(tab);
        }

        function getSortIndicator(tab, column) {
            if (currentSortColumn[tab] === column) {
                return currentSortDirection[tab] === 'asc' ? '▲' : '▼';
            }
            return '⇅';
        }

        function sortTable(tab, column) {
            if (currentSortColumn[tab] === column) {
                currentSortDirection[tab] = currentSortDirection[tab] === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn[tab] = column;
                currentSortDirection[tab] = 'asc';
            }

            const data = appData[tab].filtered;
            data.sort((a, b) => {
                let aVal = a[column] || '';
                let bVal = b[column] || '';

                const aNum = parseFloat(aVal.replace(/[$,]/g, ''));
                const bNum = parseFloat(bVal.replace(/[$,]/g, ''));

                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return currentSortDirection[tab] === 'asc' ? aNum - bNum : bNum - aNum;
                }

                if (currentSortDirection[tab] === 'asc') {
                    return aVal.localeCompare(bVal);
                } else {
                    return bVal.localeCompare(aVal);
                }
            });

            renderTable(tab);
        }

        function updateStatusBar(tab) {
            const data = appData[tab].merged;
            const statusBar = document.getElementById(`${tab}-status`);

            const paidCount = data.filter(row => row['_rowType'] === 'paid').length;
            const requestedCount = data.filter(row => row['_rowType'] === 'requested').length;
            const disqualifiedCount = data.filter(row => row['_rowType'] === 'disqualified').length;
            const totalCount = data.length;

            const reviewedCount = data.filter(row => {
                const status = (row['Status'] || '').toLowerCase();
                return status !== 'submitted' && status !== '';
            }).length;

            const nonSubmittedCount = data.filter(row => {
                const status = (row['Status'] || '').toLowerCase();
                return status !== 'submitted' && status !== '';
            }).length;
            const disqualifiedPercentage = nonSubmittedCount > 0 ? ((disqualifiedCount / nonSubmittedCount) * 100).toFixed(1) : 0;

            statusBar.innerHTML = `
                <div class="status-item">
                    <span class="status-badge badge-total">Total: ${totalCount}</span>
                </div>
                <div class="status-item">
                    <span class="status-badge badge-green">Paid: ${paidCount}</span>
                </div>
                <div class="status-item">
                    <span class="status-badge badge-yellow">Requested: ${requestedCount}</span>
                </div>
                <div class="status-item">
                    <span class="status-badge badge-red">Disq: ${disqualifiedCount} (${disqualifiedPercentage}%)</span>
                </div>
            `;
        }

        function updateTotalsBar(tab, filteredData) {
            const totalsBar = document.getElementById(`${tab}-totals`);
            if (!totalsBar) return;

            let totalHtml = `<div class="total-item">Visible: ${filteredData.length}</div>`;

            let totalPaidAmount = 0;
            let totalRequestedAmount = 0;

            filteredData.forEach(row => {
                const paidAmount = parseFloat((row['Paid Amount'] || '').replace(/[$,]/g, ''));
                
                if (row['_rowType'] === 'paid' && !isNaN(paidAmount)) {
                    totalPaidAmount += paidAmount;
                } else if (row['_rowType'] === 'requested' && !isNaN(paidAmount)) {
                    totalRequestedAmount += paidAmount;
                }
            });

            if (totalPaidAmount > 0) {
                const quarterPaid = totalPaidAmount / 4;
                totalHtml += `<div class="total-item">Paid: $${totalPaidAmount.toFixed(2)} ($${quarterPaid.toFixed(2)})</div>`;
            }

            if (totalRequestedAmount > 0) {
                const quarterRequested = totalRequestedAmount / 4;
                totalHtml += `<div class="total-item">Requested: $${totalRequestedAmount.toFixed(2)} ($${quarterRequested.toFixed(2)})</div>`;
            }

            totalsBar.innerHTML = totalHtml;
        }

        function updateProgress(tab, percent, message) {
            const progressContainer = document.getElementById(`${tab}-progress`);
            const progressFill = document.getElementById(`${tab}-progress-fill`);
            const progressStatus = document.getElementById(`${tab}-progress-status`);

            if (!progressContainer) return;

            progressContainer.classList.add('show');
            progressFill.style.width = percent + '%';
            progressFill.textContent = Math.round(percent) + '%';
            progressStatus.textContent = message;

            if (percent >= 100) {
                setTimeout(() => {
                    progressContainer.classList.remove('show');
                }, 1500);
            }
        }

        function renderNewMoney() {
            ['at', 'at-nyc', 'mbt'].forEach(tab => {
                const data = appData[tab].merged;
                const newMoneyData = data.filter(row => {
                    const hearingStatus = (row['Hearing Status'] || '').toLowerCase();
                    const paymentStatus = (row['Payment Status'] || '').trim();
                    return hearingStatus === 'paid in full' && !paymentStatus;
                });

                const thead = document.getElementById(`new-money-${tab}-thead`);
                const tbody = document.getElementById(`new-money-${tab}-tbody`);

                if (newMoneyData.length === 0) {
                    thead.innerHTML = '';
                    tbody.innerHTML = '<tr><td colspan="100" style="text-align: center;">✅ All caught up!</td></tr>';
                    document.getElementById(`new-money-${tab}-totals`).innerHTML = '💰 Total: $0.00';
                    return;
                }

                const columns = Object.keys(newMoneyData[0]).filter(col => !col.startsWith('_'));

                thead.innerHTML = '<tr>' + columns.map(col => `<th>${col}</th>`).join('') + '</tr>';
                tbody.innerHTML = newMoneyData.map(row => {
                    return '<tr>' + columns.map(col => {
                        let value = row[col] || '';
                        value = formatDate(value);
                        return `<td>${value}</td>`;
                    }).join('') + '</tr>';
                }).join('');

                let totalWaitingToCollect = 0;
                newMoneyData.forEach(row => {
                    const amount = parseFloat((row['Paid Amount'] || '').replace(/[$,]/g, ''));
                    if (!isNaN(amount)) {
                        totalWaitingToCollect += amount;
                    }
                });

                const quarterAmount = totalWaitingToCollect / 4;
                document.getElementById(`new-money-${tab}-totals`).innerHTML = `
                    💰 Total: $${totalWaitingToCollect.toFixed(2)} | Your 25%: $${quarterAmount.toFixed(2)} | Count: ${newMoneyData.length}
                `;
            });
        }

        function refreshNewMoney() {
            loadAllData(true);
            setTimeout(renderNewMoney, 2000);
        }

        function generateFunFacts() {
            const container = document.getElementById('fun-facts-container');
            const allData = [];
            
            ['at', 'at-nyc', 'mbt'].forEach(tab => {
                appData[tab].merged.forEach(row => {
                    allData.push({ ...row, _dataset: tab });
                });
            });

            if (allData.length === 0) {
                container.innerHTML = '<p>No data available. Please load data first.</p>';
                return;
            }

            const facts = [];

            facts.push({
                title: '📊 Total Records',
                description: `You have ${allData.length.toLocaleString()} summons records across all datasets`
            });

            const paidCount = allData.filter(row => row['_rowType'] === 'paid').length;
            const paymentRate = ((paidCount / allData.length) * 100).toFixed(1);
            facts.push({
                title: '💵 Payment Collection Rate',
                description: `${paymentRate}% of summonses have been paid (${paidCount} out of ${allData.length})`
            });

            let totalCollected = 0;
            allData.filter(row => row['_rowType'] === 'paid').forEach(row => {
                const amount = parseFloat((row['Paid Amount'] || '').replace(/[$,]/g, ''));
                if (!isNaN(amount)) totalCollected += amount;
            });
            const yourShare = totalCollected * 0.25;
            facts.push({
                title: '💰 Total Money Collected',
                description: `NYC paid $${totalCollected.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} total. Your 25% share: $${yourShare.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`
            });

            const disqualifiedCount = allData.filter(row => row['_rowType'] === 'disqualified').length;
            const disqualificationRate = ((disqualifiedCount / allData.length) * 100).toFixed(1);
            facts.push({
                title: '❌ Disqualification Rate',
                description: `${disqualificationRate}% of cases were disqualified (${disqualifiedCount} total)`
            });

            const companyCounts = {};
            allData.forEach(row => {
                const company = row['Company Name'] || 'Unknown';
                companyCounts[company] = (companyCounts[company] || 0) + 1;
            });
            const topCompany = Object.keys(companyCounts).reduce((a, b) => companyCounts[a] > companyCounts[b] ? a : b);
            facts.push({
                title: '🚚 Most Frequent Violator',
                description: `${topCompany} appears ${companyCounts[topCompany]} times in the records`
            });

            container.innerHTML = facts.map(fact => `
                <div style="background: white; padding: 15px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <h4 style="color: #1e3c72; margin-bottom: 10px; font-size: 1em;">${fact.title}</h4>
                    <p style="color: #2c3e50; line-height: 1.5; font-size: 0.9em;">${fact.description}</p>
                </div>
            `).join('');
        }

        function generateDiscrepancies() {
            const mismatchesDiv = document.getElementById('discrepancies-mismatches');
            const paidNotFullDiv = document.getElementById('discrepancies-paid-not-full');
            const orphanedDiv = document.getElementById('discrepancies-orphaned');

            let mismatchesHTML = '';
            let paidNotFullHTML = '';
            let orphanedHTML = '';

            ['at', 'at-nyc', 'mbt'].forEach(tab => {
                const datasetName = tab.toUpperCase();
                const merged = appData[tab].merged;
                const paid = appData[tab].paid;

                // Report A: Payment Mismatches
                const mismatches = [];
                let totalExpected = 0;
                let totalReceived = 0;

                merged.forEach(row => {
                    const summonsNum = (row['Summons Number'] || '').trim();
                    const nycPaidAmount = parseFloat((row['Paid Amount'] || '').replace(/[$,]/g, ''));
                    
                    if (!isNaN(nycPaidAmount) && nycPaidAmount > 0 && summonsNum) {
                        let receivedAmount = 0;
                        let paymentDate = '';
                        
                        if (row['Paid To Me']) {
                            receivedAmount = parseFloat((row['Paid To Me'] || '').replace(/[$,]/g, ''));
                            paymentDate = row['Payment Received'] || '';
                        }
                        
                        if (isNaN(receivedAmount) || receivedAmount === 0) {
                            const paidRow = paid.find(p => {
                                const paidSummons = (p['Summons #'] || p['Summons Number'] || '').trim();
                                return paidSummons === summonsNum;
                            });

                            if (paidRow) {
                                const amountFields = ['Paid To Me', 'Amount', 'Payment Amount', 'Check Amount', 'Amount Received', 'Paid Amount', 'Amount Paid'];
                                
                                for (const field of amountFields) {
                                    if (paidRow[field]) {
                                        const testAmount = parseFloat((paidRow[field] || '').replace(/[$,]/g, ''));
                                        if (!isNaN(testAmount) && testAmount > 0) {
                                            receivedAmount = testAmount;
                                            break;
                                        }
                                    }
                                }
                                paymentDate = paidRow['Payment Received'] || paidRow['Date Received'] || '';
                            }
                        }

                        if (receivedAmount > 0) {
                            const expected = nycPaidAmount * 0.25;
                            const difference = receivedAmount - expected;

                            if (Math.abs(difference) > 0.50) {
                                const invoiceNum = 'BP' + summonsNum.substring(1);
                                
                                mismatches.push({
                                    summons: summonsNum,
                                    invoice: invoiceNum,
                                    company: row['Company Name'] || 'Unknown',
                                    nycPaid: nycPaidAmount,
                                    expected: expected,
                                    received: receivedAmount,
                                    difference: difference,
                                    paymentDate: paymentDate
                                });
                                totalExpected += expected;
                                totalReceived += receivedAmount;
                            }
                        }
                    }
                });

                if (mismatches.length > 0) {
                    const totalDifference = totalReceived - totalExpected;
                    mismatchesHTML += `
                        <div style="margin-bottom: 25px;">
                            <h4 style="color: #1e3c72; margin-bottom: 12px; font-size: 1em;">${datasetName} - ${mismatches.length} Discrepancies</h4>
                            <div style="overflow-x: auto;">
                                <table class="discrepancy-table">
                                    <thead>
                                        <tr>
                                            <th>Invoice #</th>
                                            <th>Company</th>
                                            <th style="text-align: right;">NYC Paid</th>
                                            <th style="text-align: right;">Expected</th>
                                            <th style="text-align: right;">Received</th>
                                            <th>Date</th>
                                            <th style="text-align: right;">Diff</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${mismatches.map(m => `
                                            <tr>
                                                <td>${m.invoice}</td>
                                                <td>${m.company}</td>
                                                <td style="text-align: right;">$${m.nycPaid.toFixed(2)}</td>
                                                <td style="text-align: right;">$${m.expected.toFixed(2)}</td>
                                                <td style="text-align: right;">$${m.received.toFixed(2)}</td>
                                                <td>${m.paymentDate}</td>
                                                <td style="text-align: right;" class="${m.difference < 0 ? 'amount-negative' : 'amount-positive'}">
                                                    ${m.difference < 0 ? '-' : '+'}$${Math.abs(m.difference).toFixed(2)}
                                                </td>
                                            </tr>
                                        `).join('')}
                                        <tr style="background: #f0f0f0; font-weight: bold;">
                                            <td colspan="3">TOTALS</td>
                                            <td style="text-align: right;">$${totalExpected.toFixed(2)}</td>
                                            <td style="text-align: right;">$${totalReceived.toFixed(2)}</td>
                                            <td>-</td>
                                            <td style="text-align: right;" class="${totalDifference < 0 ? 'amount-negative' : 'amount-positive'}">
                                                ${totalDifference < 0 ? '-' : '+'}$${Math.abs(totalDifference).toFixed(2)}
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }

                // NEW REPORT: Paid But Not "Paid in Full"
                const paidNotFull = [];
                
                // Create sets of summons numbers that are in Paid or Requested datasets
                const paidSummonsSet = new Set();
                paid.forEach(row => {
                    const summonsNum = (row['Summons #'] || row['Summons Number'] || '').trim();
                    if (summonsNum) paidSummonsSet.add(summonsNum);
                });
                
                const requestedSummonsSet = new Set();
                appData[tab].requests.forEach(row => {
                    const summonsNum = (row['Complaint Number'] || row['Summons Number'] || '').trim();
                    if (summonsNum) requestedSummonsSet.add(summonsNum);
                });
                
                merged.forEach(row => {
                    const paidAmount = parseFloat((row['Paid Amount'] || '').replace(/[$,]/g, ''));
                    const hearingStatus = (row['Hearing Status'] || '').toLowerCase();
                    const summonsNum = (row['Summons Number'] || '').trim();
                    
                    // Only include if: has paid amount, not "paid in full", and NOT in Paid or Requested datasets
                    if (!isNaN(paidAmount) && paidAmount > 0 && 
                        hearingStatus !== 'paid in full' && 
                        summonsNum &&
                        !paidSummonsSet.has(summonsNum) &&
                        !requestedSummonsSet.has(summonsNum)) {
                        const invoiceNum = 'BP' + summonsNum.substring(1);
                        paidNotFull.push({
                            invoice: invoiceNum,
                            company: row['Company Name'] || 'Unknown',
                            paidAmount: paidAmount,
                            hearingStatus: row['Hearing Status'] || 'Unknown',
                            violationDate: row['Violation Date'] || ''
                        });
                    }
                });

                if (paidNotFull.length > 0) {
                    const totalPaidNotFull = paidNotFull.reduce((sum, item) => sum + item.paidAmount, 0);
                    paidNotFullHTML += `
                        <div style="margin-bottom: 25px;">
                            <h4 style="color: #1e3c72; margin-bottom: 12px; font-size: 1em;">${datasetName} - ${paidNotFull.length} Cases</h4>
                            <div style="overflow-x: auto;">
                                <table class="discrepancy-table">
                                    <thead>
                                        <tr>
                                            <th>Invoice #</th>
                                            <th>Company</th>
                                            <th style="text-align: right;">Paid Amount</th>
                                            <th>Hearing Status</th>
                                            <th>Violation Date</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${paidNotFull.map(p => `
                                            <tr>
                                                <td>${p.invoice}</td>
                                                <td>${p.company}</td>
                                                <td style="text-align: right; color: #f39c12; font-weight: bold;">$${p.paidAmount.toFixed(2)}</td>
                                                <td>${p.hearingStatus}</td>
                                                <td>${p.violationDate}</td>
                                            </tr>
                                        `).join('')}
                                        <tr style="background: #f0f0f0; font-weight: bold;">
                                            <td colspan="2">TOTAL</td>
                                            <td style="text-align: right; color: #f39c12;">$${totalPaidNotFull.toFixed(2)}</td>
                                            <td colspan="2">-</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }

                // Report C: Orphaned Payments
                const orphaned = [];
                const masterSummons = new Set(merged.map(row => (row['Summons Number'] || '').trim()));

                paid.forEach(paidRow => {
                    const summonsNum = (paidRow['Summons #'] || paidRow['Summons Number'] || '').trim();
                    if (summonsNum && !masterSummons.has(summonsNum)) {
                        const amountFields = ['Paid To Me', 'Amount', 'Payment Amount', 'Check Amount', 'Amount Received', 'Paid Amount', 'Amount Paid'];
                        let amount = 0;
                        
                        for (const field of amountFields) {
                            if (paidRow[field]) {
                                amount = parseFloat((paidRow[field] || '').replace(/[$,]/g, ''));
                                if (!isNaN(amount) && amount > 0) break;
                            }
                        }

                        const invoiceNum = 'BP' + summonsNum.substring(1);
                        const paymentDate = paidRow['Payment Received'] || paidRow['Date Received'] || '';

                        orphaned.push({
                            summons: summonsNum,
                            invoice: invoiceNum,
                            amount: amount,
                            paymentDate: paymentDate
                        });
                    }
                });

                if (orphaned.length > 0) {
                    orphanedHTML += `
                        <div style="margin-bottom: 25px;">
                            <h4 style="color: #1e3c72; margin-bottom: 12px; font-size: 1em;">${datasetName} - ${orphaned.length} Orphaned</h4>
                            <div style="overflow-x: auto;">
                                <table class="discrepancy-table">
                                    <thead>
                                        <tr>
                                            <th>Invoice #</th>
                                            <th style="text-align: right;">Amount</th>
                                            <th>Date</th>
                                            <th>Note</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${orphaned.map(o => `
                                            <tr>
                                                <td>${o.invoice}</td>
                                                <td style="text-align: right;">$${o.amount.toFixed(2)}</td>
                                                <td>${o.paymentDate}</td>
                                                <td style="font-style: italic; color: #666;">Not in master</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }
            });

            mismatchesDiv.innerHTML = mismatchesHTML || '<p style="color: #27ae60; font-weight: bold;">✅ No payment mismatches found!</p>';
            paidNotFullDiv.innerHTML = paidNotFullHTML || '<p style="color: #27ae60; font-weight: bold;">✅ All paid amounts match "Paid in Full" status!</p>';
            orphanedDiv.innerHTML = orphanedHTML || '<p style="color: #27ae60; font-weight: bold;">✅ No orphaned payments found!</p>';
        }

        function setChartType(type) {
            currentChartType = type;
            document.querySelectorAll('.chart-type-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        function getChartColors(count, scheme) {
            const schemes = {
                'default': (i, total) => `hsl(${(i * 360 / total)}, 70%, 60%)`,
                'blue': (i, total) => `hsl(210, ${70 - (i * 40 / total)}%, ${60 - (i * 30 / total)}%)`,
                'green': (i, total) => `hsl(120, ${70 - (i * 40 / total)}%, ${50 - (i * 30 / total)}%)`,
                'red': (i, total) => `hsl(0, ${70 - (i * 40 / total)}%, ${60 - (i * 30 / total)}%)`,
                'purple': (i, total) => `hsl(280, ${70 - (i * 40 / total)}%, ${60 - (i * 30 / total)}%)`,
                'status': (i, total, label) => {
                    const statusColors = {
                        'PAID TO ME': '#27ae60',
                        'REQUESTED': '#f39c12',
                        'Paid': '#27ae60',
                        'Requested': '#f39c12',
                        'Disqualified': '#e74c3c',
                        'Submitted': '#9b59b6',
                        'Unpaid': '#95a5a6'
                    };
                    return statusColors[label] || `hsl(${(i * 360 / total)}, 70%, 60%)`;
                }
            };
            return schemes[scheme] || schemes['default'];
        }

        function filterDataByDateRange(data, dateRange) {
            if (dateRange === 'all') return data;
            
            const now = new Date();
            const getDateThreshold = () => {
                switch(dateRange) {
                    case 'ytd':
                        return new Date(now.getFullYear(), 0, 1);
                    case 'last-12':
                        return new Date(now.setMonth(now.getMonth() - 12));
                    case 'last-6':
                        return new Date(now.setMonth(now.getMonth() - 6));
                    case 'last-3':
                        return new Date(now.setMonth(now.getMonth() - 3));
                    case 'this-year':
                        return new Date(now.getFullYear(), 0, 1);
                    case 'last-year':
                        return [new Date(now.getFullYear() - 1, 0, 1), new Date(now.getFullYear() - 1, 11, 31)];
                    default:
                        return null;
                }
            };
            
            const threshold = getDateThreshold();
            if (!threshold) return data;
            
            return data.filter(row => {
                const dateStr = row['Violation Date'] || row['Date Submitted'];
                if (!dateStr) return false;
                const rowDate = new Date(dateStr);
                if (Array.isArray(threshold)) {
                    return rowDate >= threshold[0] && rowDate <= threshold[1];
                }
                return rowDate >= threshold;
            });
        }

        function groupByMonth(data) {
            const monthCounts = {};
            data.forEach(row => {
                const dateStr = row['Violation Date'] || row['Date Submitted'];
                if (dateStr) {
                    const date = new Date(dateStr);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    monthCounts[monthKey] = (monthCounts[monthKey] || 0) + 1;
                }
            });
            return monthCounts;
        }

        function groupByYear(data) {
            const yearCounts = {};
            data.forEach(row => {
                const dateStr = row['Violation Date'] || row['Date Submitted'];
                if (dateStr) {
                    const date = new Date(dateStr);
                    const year = date.getFullYear();
                    yearCounts[year] = (yearCounts[year] || 0) + 1;
                }
            });
            return yearCounts;
        }

        function calculateMeasure(data, measure, field) {
            if (measure === 'count') {
                const counts = {};
                data.forEach(row => {
                    const value = row[field] || 'Unknown';
                    counts[value] = (counts[value] || 0) + 1;
                });
                return counts;
            } else if (measure === 'sum-paid') {
                const sums = {};
                data.forEach(row => {
                    const value = row[field] || 'Unknown';
                    const amount = parseFloat((row['Paid Amount'] || '0').replace(/[$,]/g, ''));
                    sums[value] = (sums[value] || 0) + (isNaN(amount) ? 0 : amount);
                });
                return sums;
            } else if (measure === 'avg-paid') {
                const sums = {};
                const counts = {};
                data.forEach(row => {
                    const value = row[field] || 'Unknown';
                    const amount = parseFloat((row['Paid Amount'] || '0').replace(/[$,]/g, ''));
                    if (!isNaN(amount) && amount > 0) {
                        sums[value] = (sums[value] || 0) + amount;
                        counts[value] = (counts[value] || 0) + 1;
                    }
                });
                const avgs = {};
                Object.keys(sums).forEach(key => {
                    avgs[key] = sums[key] / (counts[key] || 1);
                });
                return avgs;
            } else if (measure === 'sum-balance') {
                const sums = {};
                data.forEach(row => {
                    const value = row[field] || 'Unknown';
                    const amount = parseFloat((row['Balance Due'] || '0').replace(/[$,]/g, ''));
                    sums[value] = (sums[value] || 0) + (isNaN(amount) ? 0 : amount);
                });
                return sums;
            }
            return {};
        }

        function updateGlobalChart() {
            const tabSelector = document.getElementById('chart-tab-selector').value;
            const fieldSelector = document.getElementById('chart-field-selector').value;
            const measure = document.getElementById('chart-measure').value;
            const sortBy = document.getElementById('chart-sort').value;
            const maxItems = document.getElementById('chart-max-items').value;
            const statusFilter = document.getElementById('chart-status-filter').value;
            const dateRange = document.getElementById('chart-date-range').value;
            const colorScheme = document.getElementById('chart-color-scheme').value;

            let data = [];
            if (tabSelector === 'all') {
                ['at', 'at-nyc', 'mbt'].forEach(tab => data.push(...appData[tab].merged));
            } else {
                data = appData[tabSelector].merged;
            }

            if (data.length === 0) {
                alert('No data available. Please load data first.');
                return;
            }

            // Apply status filter
            if (statusFilter) {
                data = data.filter(row => {
                    if (statusFilter === 'paid') return row['_rowType'] === 'paid';
                    if (statusFilter === 'requested') return row['_rowType'] === 'requested';
                    if (statusFilter === 'disqualified') return row['_rowType'] === 'disqualified';
                    if (statusFilter === 'unpaid') return !row['Payment Status'] || row['Payment Status'] === '';
                    return true;
                });
            }

            // Apply date range filter
            data = filterDataByDateRange(data, dateRange);

            let chartData;
            if (fieldSelector === 'month') {
                chartData = groupByMonth(data);
            } else if (fieldSelector === 'year') {
                chartData = groupByYear(data);
            } else {
                chartData = calculateMeasure(data, measure, fieldSelector);
            }

            let entries = Object.entries(chartData);

            // Sort
            if (sortBy === 'value-desc') {
                entries.sort((a, b) => b[1] - a[1]);
            } else if (sortBy === 'value-asc') {
                entries.sort((a, b) => a[1] - b[1]);
            } else if (sortBy === 'label-asc') {
                entries.sort((a, b) => a[0].localeCompare(b[0]));
            } else if (sortBy === 'label-desc') {
                entries.sort((a, b) => b[0].localeCompare(a[0]));
            }

            // Limit items
            if (maxItems !== 'all') {
                entries = entries.slice(0, parseInt(maxItems));
            }

            if (entries.length === 0) {
                alert('No data matches the selected filters.');
                return;
            }

            const labels = entries.map(e => e[0]);
            const values = entries.map(e => e[1]);

            const colorFunc = getChartColors(labels.length, colorScheme);
            const colors = labels.map((label, i) => colorFunc(i, labels.length, label));

            const ctx = document.getElementById('global-chart').getContext('2d');

            if (globalChart) globalChart.destroy();

            const chartType = currentChartType === 'horizontalBar' ? 'bar' : currentChartType;
            const isHorizontal = currentChartType === 'horizontalBar';

            globalChart = new Chart(ctx, {
                type: chartType,
                data: {
                    labels: labels,
                    datasets: [{
                        label: getMeasureLabel(measure),
                        data: values,
                        backgroundColor: colors,
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    indexAxis: isHorizontal ? 'y' : 'x',
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: chartType === 'line' || isHorizontal ? 'top' : 'right',
                            labels: { font: { size: 10 }, padding: 8 }
                        },
                        title: {
                            display: true,
                            text: getChartTitle(fieldSelector, measure),
                            font: { size: 14, weight: 'bold' },
                            color: '#1e3c72'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (measure.includes('sum') || measure.includes('avg')) {
                                        label += '$' + context.parsed.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                                    } else {
                                        label += context.parsed.toLocaleString();
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: chartType === 'bar' || chartType === 'line' ? {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    if (measure.includes('sum') || measure.includes('avg')) {
                                        return '$' + value.toLocaleString();
                                    }
                                    return value.toLocaleString();
                                }
                            }
                        }
                    } : {}
                }
            });

            // Update title
            document.getElementById('chart-title').textContent = getChartTitle(fieldSelector, measure);

            // Show stats
            displayChartStats(values, measure, labels.length, data.length);

            // Show data table
            displayChartDataTable(labels, values, measure);
        }

        function getMeasureLabel(measure) {
            const labels = {
                'count': 'Count',
                'sum-paid': 'Total Paid Amount',
                'avg-paid': 'Average Paid Amount',
                'sum-balance': 'Total Balance Due'
            };
            return labels[measure] || 'Value';
        }

        function getChartTitle(field, measure) {
            const measureName = getMeasureLabel(measure);
            return `${measureName} by ${field}`;
        }

        function displayChartStats(values, measure, categoryCount, totalRecords) {
            const total = values.reduce((a, b) => a + b, 0);
            const avg = total / values.length;
            const max = Math.max(...values);
            const min = Math.min(...values);

            const statsDiv = document.getElementById('chart-stats');
            statsDiv.style.display = 'block';
            
            const isMonetary = measure.includes('sum') || measure.includes('avg');
            const formatValue = (val) => {
                if (isMonetary) {
                    return '$' + val.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                }
                return val.toLocaleString();
            };

            statsDiv.innerHTML = `
                <h4 style="color: #1e3c72; margin-bottom: 12px; font-size: 1em;">📈 Statistics</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
                    <div style="padding: 10px; background: linear-gradient(135deg, #ff8c42 0%, #ff6b35 100%); border-radius: 6px; text-align: center;">
                        <div style="color: white; font-size: 0.7em; opacity: 0.9;">TOTAL</div>
                        <div style="color: white; font-size: 1.2em; font-weight: bold;">${formatValue(total)}</div>
                    </div>
                    <div style="padding: 10px; background: #3498db; border-radius: 6px; text-align: center;">
                        <div style="color: white; font-size: 0.7em; opacity: 0.9;">AVERAGE</div>
                        <div style="color: white; font-size: 1.2em; font-weight: bold;">${formatValue(avg)}</div>
                    </div>
                    <div style="padding: 10px; background: #27ae60; border-radius: 6px; text-align: center;">
                        <div style="color: white; font-size: 0.7em; opacity: 0.9;">HIGHEST</div>
                        <div style="color: white; font-size: 1.2em; font-weight: bold;">${formatValue(max)}</div>
                    </div>
                    <div style="padding: 10px; background: #e74c3c; border-radius: 6px; text-align: center;">
                        <div style="color: white; font-size: 0.7em; opacity: 0.9;">LOWEST</div>
                        <div style="color: white; font-size: 1.2em; font-weight: bold;">${formatValue(min)}</div>
                    </div>
                    <div style="padding: 10px; background: #9b59b6; border-radius: 6px; text-align: center;">
                        <div style="color: white; font-size: 0.7em; opacity: 0.9;">CATEGORIES</div>
                        <div style="color: white; font-size: 1.2em; font-weight: bold;">${categoryCount}</div>
                    </div>
                    <div style="padding: 10px; background: #34495e; border-radius: 6px; text-align: center;">
                        <div style="color: white; font-size: 0.7em; opacity: 0.9;">RECORDS</div>
                        <div style="color: white; font-size: 1.2em; font-weight: bold;">${totalRecords.toLocaleString()}</div>
                    </div>
                </div>
            `;
        }

        function displayChartDataTable(labels, values, measure) {
            const tableDiv = document.getElementById('chart-data-table');
            tableDiv.style.display = 'block';

            const thead = document.getElementById('chart-table-head');
            const tbody = document.getElementById('chart-table-body');

            const isMonetary = measure.includes('sum') || measure.includes('avg');
            const formatValue = (val) => {
                if (isMonetary) {
                    return '$' + val.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                }
                return val.toLocaleString();
            };

            thead.innerHTML = `
                <tr style="background: #1e3c72; color: white;">
                    <th style="padding: 8px; text-align: left;">Category</th>
                    <th style="padding: 8px; text-align: right;">${getMeasureLabel(measure)}</th>
                    <th style="padding: 8px; text-align: right;">Percentage</th>
                </tr>
            `;

            const total = values.reduce((a, b) => a + b, 0);
            tbody.innerHTML = labels.map((label, i) => {
                const percentage = ((values[i] / total) * 100).toFixed(1);
                return `
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 6px;">${label}</td>
                        <td style="padding: 6px; text-align: right; font-weight: bold;">${formatValue(values[i])}</td>
                        <td style="padding: 6px; text-align: right;">${percentage}%</td>
                    </tr>
                `;
            }).join('') + `
                <tr style="background: #f0f0f0; font-weight: bold;">
                    <td style="padding: 6px;">TOTAL</td>
                    <td style="padding: 6px; text-align: right;">${formatValue(total)}</td>
                    <td style="padding: 6px; text-align: right;">100%</td>
                </tr>
            `;
        }

        // Quick Insight Functions
        function showPaymentStatusChart() {
            document.getElementById('chart-tab-selector').value = 'all';
            document.getElementById('chart-measure').value = 'count';
            document.getElementById('chart-field-selector').value = 'Payment Status';
            document.getElementById('chart-status-filter').value = '';
            document.getElementById('chart-date-range').value = 'all';
            document.getElementById('chart-color-scheme').value = 'status';
            setChartTypeByName('pie');
            updateGlobalChart();
        }

        function showCompanyChart() {
            document.getElementById('chart-tab-selector').value = 'all';
            document.getElementById('chart-measure').value = 'count';
            document.getElementById('chart-field-selector').value = 'Company Name';
            document.getElementById('chart-status-filter').value = '';
            document.getElementById('chart-date-range').value = 'all';
            document.getElementById('chart-max-items').value = '10';
            document.getElementById('chart-color-scheme').value = 'default';
            setChartTypeByName('horizontalBar');
            updateGlobalChart();
        }

        function showBoroughChart() {
            document.getElementById('chart-tab-selector').value = 'all';
            document.getElementById('chart-measure').value = 'count';
            document.getElementById('chart-field-selector').value = 'Violation Location (Borough)';
            document.getElementById('chart-status-filter').value = '';
            document.getElementById('chart-date-range').value = 'all';
            document.getElementById('chart-color-scheme').value = 'blue';
            setChartTypeByName('bar');
            updateGlobalChart();
        }

        function showMonthlyTrend() {
            document.getElementById('chart-tab-selector').value = 'all';
            document.getElementById('chart-measure').value = 'count';
            document.getElementById('chart-field-selector').value = 'month';
            document.getElementById('chart-status-filter').value = '';
            document.getElementById('chart-date-range').value = 'last-12';
            document.getElementById('chart-sort').value = 'label-asc';
            document.getElementById('chart-max-items').value = 'all';
            document.getElementById('chart-color-scheme').value = 'blue';
            setChartTypeByName('line');
            updateGlobalChart();
        }

        function showHearingResults() {
            document.getElementById('chart-tab-selector').value = 'all';
            document.getElementById('chart-measure').value = 'count';
            document.getElementById('chart-field-selector').value = 'Hearing Result';
            document.getElementById('chart-status-filter').value = '';
            document.getElementById('chart-date-range').value = 'all';
            document.getElementById('chart-color-scheme').value = 'purple';
            setChartTypeByName('doughnut');
            updateGlobalChart();
        }

        function showRevenueAnalysis() {
            document.getElementById('chart-tab-selector').value = 'all';
            document.getElementById('chart-measure').value = 'sum-paid';
            document.getElementById('chart-field-selector').value = 'Company Name';
            document.getElementById('chart-status-filter').value = 'paid';
            document.getElementById('chart-date-range').value = 'all';
            document.getElementById('chart-max-items').value = '10';
            document.getElementById('chart-color-scheme').value = 'green';
            setChartTypeByName('bar');
            updateGlobalChart();
        }

        function setChartTypeByName(type) {
            currentChartType = type;
            document.querySelectorAll('.chart-type-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.chart-type-btn').forEach(btn => {
                if (btn.textContent.toLowerCase().includes(type.toLowerCase().replace('horizontalbar', 'h-bar'))) {
                    btn.classList.add('active');
                }
            });
        }

        function exportChartImage() {
            if (!globalChart) {
                alert('Please generate a chart first.');
                return;
            }
            const canvas = document.getElementById('global-chart');
            const link = document.createElement('a');
            link.download = 'chart-' + new Date().getTime() + '.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        function exportChartDataCSV() {
            const thead = document.getElementById('chart-table-head');
            const tbody = document.getElementById('chart-table-body');
            
            if (!thead || !tbody || tbody.children.length === 0) {
                alert('Please generate a chart first.');
                return;
            }

            let csv = 'Category,Value,Percentage\n';
            Array.from(tbody.children).forEach(row => {
                const cells = Array.from(row.children);
                csv += cells.map(cell => '"' + cell.textContent.trim() + '"').join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.download = 'chart-data-' + new Date().getTime() + '.csv';
            link.href = url;
            link.click();
            window.URL.revokeObjectURL(url);
        }

        // ===== TRENDS TAB FUNCTIONS =====
        let trendCharts = {
            volume: null,
            payment: null,
            revenue: null,
            disqualification: null,
            companies: null
        };

        function getTimeKey(date, grouping) {
            const d = new Date(date);
            if (isNaN(d.getTime())) return null;
            
            if (grouping === 'month') {
                return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
            } else if (grouping === 'quarter') {
                const quarter = Math.floor(d.getMonth() / 3) + 1;
                return `${d.getFullYear()}-Q${quarter}`;
            } else if (grouping === 'year') {
                return `${d.getFullYear()}`;
            }
            return null;
        }

        function formatTimeLabel(key, grouping) {
            if (grouping === 'month') {
                const [year, month] = key.split('-');
                const date = new Date(year, parseInt(month) - 1);
                return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
            } else if (grouping === 'quarter') {
                return key;
            } else if (grouping === 'year') {
                return key;
            }
            return key;
        }

        function getTrendData() {
            const dataset = document.getElementById('trends-dataset').value;
            let data = [];
            
            if (dataset === 'all') {
                ['at', 'at-nyc', 'mbt'].forEach(tab => data.push(...appData[tab].merged));
            } else {
                data = appData[dataset].merged;
            }
            
            return data;
        }

        function generateAllTrends() {
            const data = getTrendData();
            
            if (data.length === 0) {
                alert('No data available. Please load data first.');
                return;
            }

            const grouping = document.getElementById('trends-grouping').value;
            
            generateVolumeChart(data, grouping);
            generatePaymentTrendChart(data, grouping);
            generateRevenueChart(data, grouping);
            generateDisqualificationChart(data, grouping);
            generateCompaniesChart(data, grouping);
            generatePeriodComparison(data, grouping);
        }

        function generateVolumeChart(data, grouping) {
            const timeData = {};
            
            data.forEach(row => {
                const dateStr = row['Violation Date'] || row['Date Submitted'];
                if (dateStr) {
                    const key = getTimeKey(dateStr, grouping);
                    if (key) {
                        timeData[key] = (timeData[key] || 0) + 1;
                    }
                }
            });

            const sortedKeys = Object.keys(timeData).sort();
            const labels = sortedKeys.map(key => formatTimeLabel(key, grouping));
            const values = sortedKeys.map(key => timeData[key]);

            const ctx = document.getElementById('trend-volume-chart').getContext('2d');
            
            if (trendCharts.volume) trendCharts.volume.destroy();
            
            trendCharts.volume = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Summons Issued',
                        data: values,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Summons: ' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function generatePaymentTrendChart(data, grouping) {
            const timeData = {};
            
            data.forEach(row => {
                const dateStr = row['Violation Date'] || row['Date Submitted'];
                if (dateStr) {
                    const key = getTimeKey(dateStr, grouping);
                    if (key) {
                        if (!timeData[key]) {
                            timeData[key] = { paid: 0, requested: 0, disqualified: 0, unpaid: 0 };
                        }
                        
                        if (row['_rowType'] === 'paid') {
                            timeData[key].paid++;
                        } else if (row['_rowType'] === 'requested') {
                            timeData[key].requested++;
                        } else if (row['_rowType'] === 'disqualified') {
                            timeData[key].disqualified++;
                        } else {
                            timeData[key].unpaid++;
                        }
                    }
                }
            });

            const sortedKeys = Object.keys(timeData).sort();
            const labels = sortedKeys.map(key => formatTimeLabel(key, grouping));

            const ctx = document.getElementById('trend-payment-chart').getContext('2d');
            
            if (trendCharts.payment) trendCharts.payment.destroy();
            
            trendCharts.payment = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Paid',
                            data: sortedKeys.map(key => timeData[key].paid),
                            borderColor: '#27ae60',
                            backgroundColor: 'rgba(39, 174, 96, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Requested',
                            data: sortedKeys.map(key => timeData[key].requested),
                            borderColor: '#f39c12',
                            backgroundColor: 'rgba(243, 156, 18, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Disqualified',
                            data: sortedKeys.map(key => timeData[key].disqualified),
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Unpaid',
                            data: sortedKeys.map(key => timeData[key].unpaid),
                            borderColor: '#95a5a6',
                            backgroundColor: 'rgba(149, 165, 166, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: true, position: 'top' }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            stacked: false
                        }
                    }
                }
            });
        }

        function generateRevenueChart(data, grouping) {
            const timeData = {};
            
            data.forEach(row => {
                const dateStr = row['Violation Date'] || row['Date Submitted'];
                if (dateStr && row['_rowType'] === 'paid') {
                    const key = getTimeKey(dateStr, grouping);
                    if (key) {
                        const amount = parseFloat((row['Paid Amount'] || '0').replace(/[$,]/g, ''));
                        if (!isNaN(amount)) {
                            timeData[key] = (timeData[key] || 0) + amount;
                        }
                    }
                }
            });

            const sortedKeys = Object.keys(timeData).sort();
            const labels = sortedKeys.map(key => formatTimeLabel(key, grouping));
            const totalValues = sortedKeys.map(key => timeData[key]);
            const yourShareValues = sortedKeys.map(key => timeData[key] * 0.25);

            const ctx = document.getElementById('trend-revenue-chart').getContext('2d');
            
            if (trendCharts.revenue) trendCharts.revenue.destroy();
            
            trendCharts.revenue = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Total Paid to NYC',
                            data: totalValues,
                            backgroundColor: 'rgba(52, 152, 219, 0.7)',
                            borderColor: '#3498db',
                            borderWidth: 1
                        },
                        {
                            label: 'Your 25% Share',
                            data: yourShareValues,
                            backgroundColor: 'rgba(39, 174, 96, 0.7)',
                            borderColor: '#27ae60',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': $' + context.parsed.y.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function generateDisqualificationChart(data, grouping) {
            const timeData = {};
            
            data.forEach(row => {
                const dateStr = row['Violation Date'] || row['Date Submitted'];
                if (dateStr) {
                    const key = getTimeKey(dateStr, grouping);
                    if (key) {
                        if (!timeData[key]) {
                            timeData[key] = { total: 0, disqualified: 0 };
                        }
                        timeData[key].total++;
                        if (row['_rowType'] === 'disqualified') {
                            timeData[key].disqualified++;
                        }
                    }
                }
            });

            const sortedKeys = Object.keys(timeData).sort();
            const labels = sortedKeys.map(key => formatTimeLabel(key, grouping));
            const percentages = sortedKeys.map(key => {
                const rate = (timeData[key].disqualified / timeData[key].total) * 100;
                return rate.toFixed(1);
            });

            const ctx = document.getElementById('trend-disqualification-chart').getContext('2d');
            
            if (trendCharts.disqualification) trendCharts.disqualification.destroy();
            
            trendCharts.disqualification = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Disqualification Rate (%)',
                        data: percentages,
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Rate: ' + context.parsed.y + '%';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        function generateCompaniesChart(data, grouping) {
            // Get top 5 companies
            const companyCounts = {};
            data.forEach(row => {
                const company = row['Company Name'] || 'Unknown';
                companyCounts[company] = (companyCounts[company] || 0) + 1;
            });
            
            const topCompanies = Object.entries(companyCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(e => e[0]);

            // Track each company over time
            const companyTimeData = {};
            topCompanies.forEach(company => {
                companyTimeData[company] = {};
            });

            data.forEach(row => {
                const company = row['Company Name'] || 'Unknown';
                if (topCompanies.includes(company)) {
                    const dateStr = row['Violation Date'] || row['Date Submitted'];
                    if (dateStr) {
                        const key = getTimeKey(dateStr, grouping);
                        if (key) {
                            companyTimeData[company][key] = (companyTimeData[company][key] || 0) + 1;
                        }
                    }
                }
            });

            const allKeys = new Set();
            Object.values(companyTimeData).forEach(timeData => {
                Object.keys(timeData).forEach(key => allKeys.add(key));
            });
            const sortedKeys = Array.from(allKeys).sort();
            const labels = sortedKeys.map(key => formatTimeLabel(key, grouping));

            const colors = ['#3498db', '#27ae60', '#f39c12', '#e74c3c', '#9b59b6'];
            const datasets = topCompanies.map((company, i) => ({
                label: company,
                data: sortedKeys.map(key => companyTimeData[company][key] || 0),
                borderColor: colors[i],
                backgroundColor: colors[i] + '20',
                borderWidth: 2,
                fill: false,
                tension: 0.4
            }));

            const ctx = document.getElementById('trend-companies-chart').getContext('2d');
            
            if (trendCharts.companies) trendCharts.companies.destroy();
            
            trendCharts.companies = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: true, position: 'top' }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function generatePeriodComparison(data, grouping) {
            const timeData = {};
            
            data.forEach(row => {
                const dateStr = row['Violation Date'] || row['Date Submitted'];
                if (dateStr) {
                    const key = getTimeKey(dateStr, grouping);
                    if (key) {
                        if (!timeData[key]) {
                            timeData[key] = {
                                total: 0,
                                paid: 0,
                                requested: 0,
                                disqualified: 0,
                                revenue: 0
                            };
                        }
                        timeData[key].total++;
                        
                        if (row['_rowType'] === 'paid') {
                            timeData[key].paid++;
                            const amount = parseFloat((row['Paid Amount'] || '0').replace(/[$,]/g, ''));
                            if (!isNaN(amount)) {
                                timeData[key].revenue += amount;
                            }
                        } else if (row['_rowType'] === 'requested') {
                            timeData[key].requested++;
                        } else if (row['_rowType'] === 'disqualified') {
                            timeData[key].disqualified++;
                        }
                    }
                }
            });

            const sortedKeys = Object.keys(timeData).sort();
            const recentPeriods = sortedKeys.slice(-6); // Last 6 periods

            const comparisonDiv = document.getElementById('period-comparison');
            
            if (recentPeriods.length === 0) {
                comparisonDiv.innerHTML = '<p style="color: #666; font-size: 0.85em;">No data available for comparison</p>';
                return;
            }

            let html = '<div style="overflow-x: auto;"><table style="width: 100%; font-size: 0.8em; border-collapse: collapse;">';
            html += '<thead><tr style="background: #1e3c72; color: white;">';
            html += '<th style="padding: 8px; text-align: left;">Period</th>';
            html += '<th style="padding: 8px; text-align: right;">Total</th>';
            html += '<th style="padding: 8px; text-align: right;">Paid</th>';
            html += '<th style="padding: 8px; text-align: right;">Requested</th>';
            html += '<th style="padding: 8px; text-align: right;">Disqualified</th>';
            html += '<th style="padding: 8px; text-align: right;">Revenue</th>';
            html += '<th style="padding: 8px; text-align: right;">Your Share</th>';
            html += '</tr></thead><tbody>';

            recentPeriods.forEach((key, index) => {
                const period = timeData[key];
                const bgColor = index % 2 === 0 ? '#f8f9fa' : 'white';
                html += `<tr style="background: ${bgColor}; border-bottom: 1px solid #ddd;">`;
                html += `<td style="padding: 6px; font-weight: bold;">${formatTimeLabel(key, grouping)}</td>`;
                html += `<td style="padding: 6px; text-align: right;">${period.total}</td>`;
                html += `<td style="padding: 6px; text-align: right; color: #27ae60;">${period.paid}</td>`;
                html += `<td style="padding: 6px; text-align: right; color: #f39c12;">${period.requested}</td>`;
                html += `<td style="padding: 6px; text-align: right; color: #e74c3c;">${period.disqualified}</td>`;
                html += `<td style="padding: 6px; text-align: right;">$${period.revenue.toFixed(2)}</td>`;
                html += `<td style="padding: 6px; text-align: right; font-weight: bold; color: #27ae60;">$${(period.revenue * 0.25).toFixed(2)}</td>`;
                html += '</tr>';
            });

            html += '</tbody></table></div>';
            comparisonDiv.innerHTML = html;
        }

        function saveToStorage() {
            try {
                const saveData = {};
                ['at', 'at-nyc', 'mbt'].forEach(tab => {
                    saveData[tab] = {
                        master: appData[tab].master,
                        paid: appData[tab].paid,
                        requests: appData[tab].requests,
                        merged: appData[tab].merged,
                        lastRefreshSheets: appData[tab].lastRefreshSheets,
                        lastRefreshNYC: appData[tab].lastRefreshNYC
                    };
                });
                localStorage.setItem('truckDataManager', JSON.stringify(saveData));
            } catch (e) {
                console.error('Error saving to localStorage:', e);
            }
        }

        function loadFromStorage() {
            try {
                const saved = localStorage.getItem('truckDataManager');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    Object.keys(parsed).forEach(tab => {
                        if (appData[tab] && parsed[tab]) {
                            appData[tab].master = parsed[tab].master || [];
                            appData[tab].paid = parsed[tab].paid || [];
                            appData[tab].requests = parsed[tab].requests || [];
                            appData[tab].merged = parsed[tab].merged || [];
                            appData[tab].lastRefreshSheets = parsed[tab].lastRefreshSheets || null;
                            appData[tab].lastRefreshNYC = parsed[tab].lastRefreshNYC || null;
                        }
                    });
                    ['at', 'at-nyc', 'mbt'].forEach(tab => {
                        if (appData[tab].merged.length > 0) {
                            applyFilters(tab);
                            populateFilterDropdowns(tab);
                        }
                    });
                }
            } catch (e) {
                console.error('Error loading from localStorage:', e);
            }
        }
    </script>
</body>
</html>
