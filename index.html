<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>🚚 Truck Data Manager</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #2c3e50;
            padding: 10px;
            min-height: 100vh;
            font-size: 14px;
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
        }

        header {
            text-align: center;
            padding: 15px 10px;
            background: linear-gradient(135deg, #ff8c42 0%, #ff6b35 100%);
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            margin-bottom: 10px;
        }

        h1 {
            font-size: 1.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 5px;
            color: white;
        }

        .subtitle {
            font-size: 0.85em;
            opacity: 0.9;
            color: white;
        }

        .tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .tab-button {
            padding: 12px 16px;
            background: #5a7fa7;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 0.9em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            min-height: 44px;
            flex: 1 1 auto;
            min-width: 80px;
        }

        .tab-button:active {
            transform: scale(0.95);
        }

        .tab-button.active {
            background: linear-gradient(135deg, #ff8c42 0%, #ff6b35 100%);
            box-shadow: 0 4px 8px rgba(255, 140, 66, 0.4);
        }

        .tab-content {
            display: none;
            background: #f8f9fa;
            padding: 15px 10px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .tab-content.active {
            display: block;
        }

        .controls {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn {
            padding: 8px 12px;
            background: linear-gradient(135deg, #5a7fa7 0%, #4a6f97 100%);
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 0.8em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            min-height: 44px;
            white-space: nowrap;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .btn-primary {
            background: linear-gradient(135deg, #ff8c42 0%, #ff6b35 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        }

        .filters-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            margin-bottom: 10px;
            overflow: hidden;
        }

        .filters-toggle {
            width: 100%;
            padding: 12px 15px;
            background: linear-gradient(135deg, #5a7fa7 0%, #4a6f97 100%);
            border: none;
            color: white;
            font-weight: 600;
            font-size: 0.9em;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s ease;
        }

        .filters-toggle:hover {
            background: linear-gradient(135deg, #4a6f97 0%, #3a5f87 100%);
        }

        .filters-toggle:active {
            transform: scale(0.98);
        }

        .filters-toggle-icon {
            transition: transform 0.3s ease;
            font-size: 1.2em;
        }

        .filters-toggle-icon.open {
            transform: rotate(180deg);
        }

        .filters {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            padding: 15px;
            background: white;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }

        .filters.show {
            max-height: 500px;
            padding: 15px;
        }

        @media (min-width: 769px) {
            .filters {
                grid-template-columns: auto 1fr auto;
                align-items: start;
                gap: 20px;
            }
            
            .filters.show {
                max-height: 300px;
            }
        }

        .filter-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .filter-section > label {
            font-weight: 700;
            color: #1e3c72;
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }

        .visibility-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 8px;
        }

        @media (min-width: 769px) {
            .visibility-grid {
                grid-template-columns: 1fr;
                gap: 6px;
            }
        }

        .filter-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            background: #f8f9fa;
            border-radius: 6px;
            transition: background 0.2s ease;
        }

        .filter-item:hover {
            background: #e9ecef;
        }

        .filter-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #5a7fa7;
        }

        .filter-item label {
            cursor: pointer;
            font-weight: 500;
            color: #2c3e50;
            font-size: 0.85em;
            user-select: none;
            flex: 1;
        }

        .filter-dropdowns {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .filter-item select,
        .filter-item input[type="text"],
        .filter-item input[type="number"] {
            padding: 10px 12px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 0.9em;
            width: 100%;
            min-height: 44px;
            background: white;
            transition: border-color 0.2s ease;
        }

        .filter-item select:focus,
        .filter-item input[type="text"]:focus,
        .filter-item input[type="number"]:focus {
            outline: none;
            border-color: #5a7fa7;
            box-shadow: 0 0 0 3px rgba(90, 127, 167, 0.1);
        }

        .search-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .search-section input {
            padding: 10px 12px 10px 38px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 0.9em;
            width: 100%;
            min-height: 44px;
            background: white url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%235a7fa7' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E") no-repeat 12px center;
            transition: border-color 0.2s ease;
        }

        .search-section input:focus {
            outline: none;
            border-color: #5a7fa7;
            box-shadow: 0 0 0 3px rgba(90, 127, 167, 0.1);
        }

        .advanced-filter {
            display: flex;
            gap: 6px;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .advanced-filter select,
        .advanced-filter input {
            flex: 1 1 100%;
            min-width: 0;
            min-height: 44px;
        }

        .progress-container {
            display: none;
            background: white;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .progress-container.show {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #ff8c42 0%, #ff6b35 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9em;
        }

        .progress-status {
            margin-top: 8px;
            color: #2c3e50;
            font-weight: bold;
            text-align: center;
            font-size: 0.9em;
        }

        .table-container {
            overflow-x: auto;
            background: white;
            border-radius: 6px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-height: 500px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 500px;
            background: white;
        }

        th, td {
            padding: 6px 4px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
            font-size: 10px;
            white-space: nowrap;
            position: relative;
        }

        th {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
            user-select: none;
            font-size: 9px;
        }

        th:active {
            background: linear-gradient(135deg, #2a5298 0%, #3a62a8 100%);
        }

        th .sort-indicator {
            margin-left: 4px;
            font-size: 0.8em;
        }

        tr:nth-child(even) {
            background: #f8f9fa;
        }

        tr:nth-child(odd) {
            background: white;
        }

        .row-green {
            background: #d4edda !important;
        }

        .row-yellow {
            background: #fff3cd !important;
        }

        .row-red {
            background: #f8d7da !important;
        }
        
        .row-dismissed {
            background: #d9534f !important;
            color: white;
        }

        .row-gray {
            background: #e8d5f0 !important;
            opacity: 0.9;
        }

        .status-bar {
            background: white;
            padding: 8px;
            border-radius: 6px;
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 6px;
            flex: 1 1 auto;
            min-width: 100px;
            justify-content: center;
        }

        .status-badge {
            padding: 6px 10px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 0.8em;
            white-space: nowrap;
        }

        .badge-green {
            background: #27ae60;
            color: white;
        }

        .badge-yellow {
            background: #f39c12;
            color: white;
        }

        .badge-red {
            background: #e74c3c;
            color: white;
        }

        .badge-total {
            background: #5a7fa7;
            color: white;
        }

        .pagination {
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
            padding: 8px;
            background: white;
            border-radius: 6px;
            flex-wrap: wrap;
        }

        .pagination button {
            padding: 8px 12px;
            background: #5a7fa7;
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-weight: bold;
            min-height: 44px;
            font-size: 0.85em;
        }

        .pagination button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .pagination button:active:not(:disabled) {
            transform: scale(0.95);
        }

        .pagination select {
            padding: 8px;
            border: 2px solid #5a7fa7;
            border-radius: 4px;
            min-height: 44px;
            font-size: 0.85em;
        }

        .pagination span {
            font-weight: bold;
            text-align: center;
            flex: 1 1 100%;
            font-size: 0.85em;
        }

        .chart-section {
            background: white;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .chart-controls {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .chart-control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .chart-control-group label {
            font-weight: bold;
            color: #1e3c72;
            font-size: 0.9em;
        }

        .chart-controls select,
        .chart-controls input {
            padding: 10px;
            border: 2px solid #5a7fa7;
            border-radius: 4px;
            background: white;
            color: #2c3e50;
            font-size: 0.9em;
            min-height: 44px;
        }

        .chart-canvas-container {
            max-width: 100%;
            margin: 20px auto;
            overflow-x: auto;
        }

        .dataset-section {
            background: white;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .dataset-section h3 {
            color: #1e3c72;
            margin-bottom: 10px;
            border-bottom: 2px solid #ff8c42;
            padding-bottom: 5px;
            font-size: 1.1em;
        }

        .totals-bar {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 10px 8px;
            border-radius: 6px;
            margin-top: 10px;
            font-weight: bold;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 8px;
        }

        .total-item {
            font-size: 0.85em;
            text-align: center;
            flex: 1 1 auto;
            min-width: 130px;
        }

        .settings-panel {
            background: white;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .settings-section {
            margin-bottom: 25px;
        }

        .settings-section h3 {
            color: #1e3c72;
            margin-bottom: 15px;
            font-size: 1.1em;
            border-bottom: 2px solid #ff8c42;
            padding-bottom: 8px;
        }

        .sheet-input-group {
            margin-bottom: 15px;
        }

        .sheet-input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
            font-size: 0.9em;
        }

        .sheet-input-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #5a7fa7;
            border-radius: 4px;
            font-size: 0.85em;
            min-height: 44px;
        }

        .auto-refresh-indicator {
            display: inline-block;
            padding: 8px 12px;
            background: #27ae60;
            color: white;
            border-radius: 6px;
            font-size: 0.8em;
            margin-left: 10px;
        }

        .chart-type-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .chart-type-btn {
            padding: 10px 14px;
            background: #5a7fa7;
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 0.85em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1 1 auto;
            min-height: 44px;
        }

        .chart-type-btn.active {
            background: #ff8c42;
        }

        .chart-type-btn:active {
            transform: scale(0.95);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .summary-card {
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }

        .summary-card.overpaid {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
        }

        .summary-card.underpaid {
            background: #fff4e6;
            border: 2px solid #ff8c42;
        }

        .summary-card.total {
            background: #e6f2ff;
            border: 2px solid #5a7fa7;
        }

        .summary-value {
            font-size: 1.5em;
            font-weight: bold;
            margin: 10px 0;
        }

        .summary-label {
            font-size: 0.9em;
            color: #666;
        }

        .discrepancy-table {
            font-size: 9px;
            width: 100%;
            border-collapse: collapse;
        }

        .discrepancy-table th {
            background: #1e3c72;
            color: white;
            padding: 5px 4px;
            font-size: 8px;
            text-align: left;
        }

        .discrepancy-table td {
            padding: 4px;
            border-bottom: 1px solid #ddd;
            font-size: 9px;
        }

        .discrepancy-table tr:hover {
            background: #f0f0f0;
        }

        .amount-negative {
            color: #e74c3c;
            font-weight: bold;
        }

        .amount-positive {
            color: #3498db;
            font-weight: bold;
        }

        .money-header {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
            padding: 20px 15px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(39, 174, 96, 0.3);
        }

        .money-header h2 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .money-emoji {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .money-card {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border: 3px solid #27ae60;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .money-card h3 {
            color: #155724;
            font-size: 1.2em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .money-total {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            font-size: 1em;
            font-weight: bold;
            text-align: center;
            box-shadow: 0 4px 8px rgba(39, 174, 96, 0.3);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 20px auto;
            padding: 20px;
            border: 1px solid #888;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #1e3c72;
        }

        .modal-header h2 {
            color: #1e3c72;
            margin: 0;
            font-size: 1.2em;
        }

        .close {
            color: #aaa;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close:active {
            color: #000;
        }

        /* Mobile-specific improvements */
        @media (max-width: 768px) {
            body {
                padding: 5px;
                font-size: 11px;
            }

            h1 {
                font-size: 1.2em;
            }

            .tab-button {
                padding: 8px 10px;
                font-size: 0.75em;
                min-width: 65px;
            }

            .btn {
                font-size: 0.75em;
                padding: 8px 10px;
            }

            th, td {
                font-size: 9px;
                padding: 5px 3px;
            }

            th {
                font-size: 8px;
            }

            .filters {
                padding: 12px;
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .visibility-grid {
                grid-template-columns: 1fr 1fr;
            }

            .filter-section > label {
                font-size: 0.7em;
            }

            .filter-item label {
                font-size: 0.8em;
            }

            .status-item {
                min-width: 90px;
            }

            .status-badge {
                font-size: 0.7em;
                padding: 5px 8px;
            }

            .total-item {
                font-size: 0.75em;
                min-width: 110px;
            }

            .table-container {
                max-height: 600px;
            }

            .chart-canvas-container {
                overflow-x: auto;
            }

            .dataset-section h3 {
                font-size: 1em;
            }

            .dataset-section p {
                font-size: 0.85em;
            }

            .discrepancy-table {
                font-size: 8px;
            }

            .discrepancy-table th {
                font-size: 7px;
                padding: 4px 3px;
            }

            .discrepancy-table td {
                font-size: 8px;
                padding: 3px;
            }
        }

        @media (max-width: 480px) {
            body {
                font-size: 10px;
            }

            h1 {
                font-size: 1.1em;
            }

            .tab-button {
                font-size: 0.7em;
                padding: 7px 8px;
            }

            th, td {
                font-size: 8px;
                padding: 4px 2px;
            }

            th {
                font-size: 7px;
            }

            .status-badge {
                font-size: 0.65em;
                padding: 4px 6px;
            }

            .total-item {
                font-size: 0.7em;
            }

            .money-emoji {
                font-size: 1.8em;
            }

            .money-header h2 {
                font-size: 1.1em;
            }

            .discrepancy-table {
                font-size: 7px;
            }

            .discrepancy-table th {
                font-size: 6px;
                padding: 3px 2px;
            }

            .discrepancy-table td {
                font-size: 7px;
                padding: 2px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>🚚 Truck Data Manager</h1>
            <p class="subtitle">Manage Your Idling Summons Data</p>
        </header>

        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('at')">🚛 AT</button>
            <button class="tab-button" onclick="switchTab('at-nyc')">🏙️ AT NYC</button>
            <button class="tab-button" onclick="switchTab('mbt')">🚚 MBT</button>
            <button class="tab-button" onclick="switchTab('new-money')">💰 NEW MONEY</button>
            <button class="tab-button" onclick="switchTab('discrepancies')">⚠️ DISC</button>
            <button class="tab-button" onclick="switchTab('trends')">📈 TRENDS</button>
            <button class="tab-button" onclick="switchTab('changes')">🔄 CHANGES</button>
            <button class="tab-button" onclick="switchTab('fun-facts')">🎉 FACTS</button>
            <button class="tab-button" onclick="switchTab('insights')">🚀 INSIGHTS</button>
            <button class="tab-button" onclick="switchTab('charts')">📊 CHARTS</button>
            <button class="tab-button" onclick="switchTab('settings')">⚙️ SET</button>
        </div>

        <!-- AT Tab -->
        <div id="at" class="tab-content active">
            <div class="controls">
                <button class="btn btn-primary" onclick="loadAllData()">📄 Load All</button>
                <button class="btn" onclick="refreshData('at')">🔄 Refresh</button>
                <button class="btn btn-danger" onclick="clearData('at')">🗑️ Clear</button>
                <div id="at-timestamps" style="display: inline-block; padding: 0 15px; font-size: 0.7em; color: #666; white-space: nowrap;"></div>
                <div class="filter-item" style="margin-left: auto;">
                    <input type="checkbox" id="at-show-extra" onchange="toggleExtraColumns('at')">
                    <label for="at-show-extra">Extra Data</label>
                </div>
            </div>

            <div class="progress-container" id="at-progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="at-progress-fill" style="width: 0%">0%</div>
                </div>
                <div class="progress-status" id="at-progress-status">Initializing...</div>
            </div>

            <div class="filters-container">
                <button class="filters-toggle" onclick="toggleFilters('at')">
                    <span>🔍 Filters</span>
                    <span class="filters-toggle-icon" id="at-filters-icon">▼</span>
                </button>
                <div class="filters" id="at-filters">
                    <div class="filter-section">
                        <label>Visibility</label>
                        <div class="visibility-grid">
                            <div class="filter-item">
                                <input type="checkbox" id="at-filter-paid" checked onchange="debouncedApplyFilters('at')">
                                <label for="at-filter-paid">Paid</label>
                            </div>
                            <div class="filter-item">
                                <input type="checkbox" id="at-filter-requested" checked onchange="debouncedApplyFilters('at')">
                                <label for="at-filter-requested">Requested</label>
                            </div>
                            <div class="filter-item">
                                <input type="checkbox" id="at-filter-disqualified" checked onchange="debouncedApplyFilters('at')">
                                <label for="at-filter-disqualified">Disqualified</label>
                            </div>
                            <div class="filter-item">
                                <input type="checkbox" id="at-filter-unpaid" checked onchange="debouncedApplyFilters('at')">
                                <label for="at-filter-unpaid">Unpaid</label>
                            </div>
                        </div>
                    </div>

                    <div class="filter-section">
                        <label>Quick Filters</label>
                        <div class="filter-dropdowns">
                            <select id="at-filter-payment-status" onchange="debouncedApplyFilters('at')" style="padding: 10px 12px; border: 2px solid #dee2e6; border-radius: 6px; font-size: 0.9em; min-height: 44px; background: white;">
                                <option value="">All Payment Status</option>
                            </select>
                            <select id="at-filter-company" onchange="debouncedApplyFilters('at')" style="padding: 10px 12px; border: 2px solid #dee2e6; border-radius: 6px; font-size: 0.9em; min-height: 44px; background: white;">
                                <option value="">All Companies</option>
                            </select>
                        </div>
                    </div>

                    <div class="filter-section search-section">
                        <label>Search</label>
                        <input type="text" id="at-filter-search" placeholder="Search all columns..." onkeyup="debouncedApplyFilters('at')">
                    </div>
                </div>
            </div>

            <div class="status-bar" id="at-status"></div>

            <div class="table-container" id="at-table-container">
                <table id="at-table">
                    <thead id="at-thead"></thead>
                    <tbody id="at-tbody"></tbody>
                </table>
            </div>

            <div class="pagination" id="at-pagination">
                <span id="at-page-info">Page 1</span>
                <button onclick="changePage('at', -1)">Previous</button>
                <button onclick="changePage('at', 1)">Next</button>
                <select id="at-page-size" onchange="changePageSize('at')">
                    <option value="50">50 per page</option>
                    <option value="100">100 per page</option>
                    <option value="all" selected>Show All</option>
                </select>
            </div>

            <div class="totals-bar" id="at-totals"></div>
        </div>

        <!-- AT NYC Tab -->
        <div id="at-nyc" class="tab-content">
            <div class="controls">
                <button class="btn btn-primary" onclick="loadAllData()">📄 Load All</button>
                <button class="btn" onclick="refreshData('at-nyc')">🔄 Refresh</button>
                <button class="btn btn-danger" onclick="clearData('at-nyc')">🗑️ Clear</button>
                <div id="at-nyc-timestamps" style="display: inline-block; padding: 0 15px; font-size: 0.7em; color: #666; white-space: nowrap;"></div>
                <div class="filter-item" style="margin-left: auto;">
                    <input type="checkbox" id="at-nyc-show-extra" onchange="toggleExtraColumns('at-nyc')">
                    <label for="at-nyc-show-extra">Extra Data</label>
                </div>
            </div>

            <div class="progress-container" id="at-nyc-progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="at-nyc-progress-fill" style="width: 0%">0%</div>
                </div>
                <div class="progress-status" id="at-nyc-progress-status">Initializing...</div>
            </div>

            <div class="filters-container">
                <button class="filters-toggle" onclick="toggleFilters('at-nyc')">
                    <span>🔍 Filters</span>
                    <span class="filters-toggle-icon" id="at-nyc-filters-icon">▼</span>
                </button>
                <div class="filters" id="at-nyc-filters">
                    <div class="filter-section">
                        <label>Visibility</label>
                        <div class="visibility-grid">
                            <div class="filter-item">
                                <input type="checkbox" id="at-nyc-filter-paid" checked onchange="debouncedApplyFilters('at-nyc')">
                                <label for="at-nyc-filter-paid">Paid</label>
                            </div>
                            <div class="filter-item">
                                <input type="checkbox" id="at-nyc-filter-requested" checked onchange="debouncedApplyFilters('at-nyc')">
                                <label for="at-nyc-filter-requested">Requested</label>
                            </div>
                            <div class="filter-item">
                                <input type="checkbox" id="at-nyc-filter-disqualified" checked onchange="debouncedApplyFilters('at-nyc')">
                                <label for="at-nyc-filter-disqualified">Disqualified</label>
                            </div>
                            <div class="filter-item">
                                <input type="checkbox" id="at-nyc-filter-unpaid" checked onchange="debouncedApplyFilters('at-nyc')">
                                <label for="at-nyc-filter-unpaid">Unpaid</label>
                            </div>
                        </div>
                    </div>

                    <div class="filter-section">
                        <label>Quick Filters</label>
                        <div class="filter-dropdowns">
                            <select id="at-nyc-filter-payment-status" onchange="debouncedApplyFilters('at-nyc')" style="padding: 10px 12px; border: 2px solid #dee2e6; border-radius: 6px; font-size: 0.9em; min-height: 44px; background: white;">
                                <option value="">All Payment Status</option>
                            </select>
                            <select id="at-nyc-filter-company" onchange="debouncedApplyFilters('at-nyc')" style="padding: 10px 12px; border: 2px solid #dee2e6; border-radius: 6px; font-size: 0.9em; min-height: 44px; background: white;">
                                <option value="">All Companies</option>
                            </select>
                        </div>
                    </div>

                    <div class="filter-section search-section">
                        <label>Search</label>
                        <input type="text" id="at-nyc-filter-search" placeholder="Search all columns..." onkeyup="debouncedApplyFilters('at-nyc')">
                    </div>
                </div>
            </div>

            <div class="status-bar" id="at-nyc-status"></div>

            <div class="table-container" id="at-nyc-table-container">
                <table id="at-nyc-table">
                    <thead id="at-nyc-thead"></thead>
                    <tbody id="at-nyc-tbody"></tbody>
                </table>
            </div>

            <div class="pagination" id="at-nyc-pagination">
                <span id="at-nyc-page-info">Page 1</span>
                <button onclick="changePage('at-nyc', -1)">Previous</button>
                <button onclick="changePage('at-nyc', 1)">Next</button>
                <select id="at-nyc-page-size" onchange="changePageSize('at-nyc')">
                    <option value="50">50 per page</option>
                    <option value="100">100 per page</option>
                    <option value="all" selected>Show All</option>
                </select>
            </div>

            <div class="totals-bar" id="at-nyc-totals"></div>
        </div>

        <!-- MBT Tab -->
        <div id="mbt" class="tab-content">
            <div class="controls">
                <button class="btn btn-primary" onclick="loadAllData()">📄 Load All</button>
                <button class="btn" onclick="refreshData('mbt')">🔄 Refresh</button>
                <button class="btn btn-danger" onclick="clearData('mbt')">🗑️ Clear</button>
                <div id="mbt-timestamps" style="display: inline-block; padding: 0 15px; font-size: 0.7em; color: #666; white-space: nowrap;"></div>
                <div class="filter-item" style="margin-left: auto;">
                    <input type="checkbox" id="mbt-show-extra" onchange="toggleExtraColumns('mbt')">
                    <label for="mbt-show-extra">Extra Data</label>
                </div>
            </div>

            <div class="progress-container" id="mbt-progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="mbt-progress-fill" style="width: 0%">0%</div>
                </div>
                <div class="progress-status" id="mbt-progress-status">Initializing...</div>
            </div>

            <div class="filters-container">
                <button class="filters-toggle" onclick="toggleFilters('mbt')">
                    <span>🔍 Filters</span>
                    <span class="filters-toggle-icon" id="mbt-filters-icon">▼</span>
                </button>
                <div class="filters" id="mbt-filters">
                    <div class="filter-section">
                        <label>Visibility</label>
                        <div class="visibility-grid">
                            <div class="filter-item">
                                <input type="checkbox" id="mbt-filter-paid" checked onchange="debouncedApplyFilters('mbt')">
                                <label for="mbt-filter-paid">Paid</label>
                            </div>
                            <div class="filter-item">
                                <input type="checkbox" id="mbt-filter-requested" checked onchange="debouncedApplyFilters('mbt')">
                                <label for="mbt-filter-requested">Requested</label>
                            </div>
                            <div class="filter-item">
                                <input type="checkbox" id="mbt-filter-disqualified" checked onchange="debouncedApplyFilters('mbt')">
                                <label for="mbt-filter-disqualified">Disqualified</label>
                            </div>
                            <div class="filter-item">
                                <input type="checkbox" id="mbt-filter-unpaid" checked onchange="debouncedApplyFilters('mbt')">
                                <label for="mbt-filter-unpaid">Unpaid</label>
                            </div>
                        </div>
                    </div>

                    <div class="filter-section">
                        <label>Quick Filters</label>
                        <div class="filter-dropdowns">
                            <select id="mbt-filter-payment-status" onchange="debouncedApplyFilters('mbt')" style="padding: 10px 12px; border: 2px solid #dee2e6; border-radius: 6px; font-size: 0.9em; min-height: 44px; background: white;">
                                <option value="">All Payment Status</option>
                            </select>
                            <select id="mbt-filter-company" onchange="debouncedApplyFilters('mbt')" style="padding: 10px 12px; border: 2px solid #dee2e6; border-radius: 6px; font-size: 0.9em; min-height: 44px; background: white;">
                                <option value="">All Companies</option>
                            </select>
                        </div>
                    </div>

                    <div class="filter-section search-section">
                        <label>Search</label>
                        <input type="text" id="mbt-filter-search" placeholder="Search all columns..." onkeyup="debouncedApplyFilters('mbt')">
                    </div>
                </div>
            </div>

            <div class="status-bar" id="mbt-status"></div>

            <div class="table-container" id="mbt-table-container">
                <table id="mbt-table">
                    <thead id="mbt-thead"></thead>
                    <tbody id="mbt-tbody"></tbody>
                </table>
            </div>

            <div class="pagination" id="mbt-pagination">
                <span id="mbt-page-info">Page 1</span>
                <button onclick="changePage('mbt', -1)">Previous</button>
                <button onclick="changePage('mbt', 1)">Next</button>
                <select id="mbt-page-size" onchange="changePageSize('mbt')">
                    <option value="50">50 per page</option>
                    <option value="100">100 per page</option>
                    <option value="all" selected>Show All</option>
                </select>
            </div>

            <div class="totals-bar" id="mbt-totals"></div>
        </div>

        <!-- NEW MONEY Tab -->
        <div id="new-money" class="tab-content">
            <div class="money-header">
                <div class="money-emoji">💰💵💸</div>
                <h2>New Money Waiting to Collect</h2>
                <p style="font-size: 0.95em; opacity: 0.95;">Summonses marked "Paid in Full" but not yet collected from NYC</p>
            </div>

            <div class="controls">
                <button class="btn btn-success" onclick="refreshNewMoney()">🔄 Refresh New Money</button>
            </div>

            <div class="money-card">
                <h3>💚 AT Dataset</h3>
                <div class="table-container">
                    <table id="new-money-at-table">
                        <thead id="new-money-at-thead"></thead>
                        <tbody id="new-money-at-tbody"></tbody>
                    </table>
                </div>
                <div class="money-total" id="new-money-at-totals"></div>
            </div>

            <div class="money-card">
                <h3>💙 AT NYC Dataset</h3>
                <div class="table-container">
                    <table id="new-money-at-nyc-table">
                        <thead id="new-money-at-nyc-thead"></thead>
                        <tbody id="new-money-at-nyc-tbody"></tbody>
                    </table>
                </div>
                <div class="money-total" id="new-money-at-nyc-totals"></div>
            </div>

            <div class="money-card">
                <h3>💛 MBT Dataset</h3>
                <div class="table-container">
                    <table id="new-money-mbt-table">
                        <thead id="new-money-mbt-thead"></thead>
                        <tbody id="new-money-mbt-tbody"></tbody>
                    </table>
                </div>
                <div class="money-total" id="new-money-mbt-totals"></div>
            </div>
        </div>

        <!-- DISCREPANCIES Tab -->
        <div id="discrepancies" class="tab-content">
            <div class="controls">
                <button class="btn btn-primary" onclick="generateDiscrepancies()">🔍 Generate Reports</button>
            </div>

            <div class="dataset-section">
                <h3>Payment Amount Mismatches</h3>
                <p style="margin-bottom: 15px; color: #666; font-size: 0.9em;">Invoices where the amount you received doesn't match 25% of what NYC was paid.</p>
                <div style="margin-bottom: 10px;">
                    <button class="btn btn-success" onclick="exportMismatchesPDF()">📄 Export PDF Report</button>
                </div>
                <div id="discrepancies-mismatches"></div>
            </div>

            <div class="dataset-section">
                <h3>Paid But Not "Paid in Full"</h3>
                <p style="margin-bottom: 15px; color: #666; font-size: 0.9em;">Summonses with a Paid Amount above zero but Hearing Status is not "Paid in Full".</p>
                <div id="discrepancies-paid-not-full"></div>
            </div>

            <div class="dataset-section">
                <h3>Orphaned Payments</h3>
                <p style="margin-bottom: 15px; color: #666; font-size: 0.9em;">Payments in your "Paid" sheet that don't have a corresponding entry in the master dataset.</p>
                <div id="discrepancies-orphaned"></div>
            </div>
        </div>

        <!-- TRENDS Tab -->
        <div id="trends" class="tab-content">
            <div style="background: white; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                <h3 style="color: #1e3c72; margin-bottom: 12px;">📈 Trends Over Time</h3>
                <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">Track how your summons data changes over time with interactive trend analysis.</p>
                
                <div class="controls">
                    <button class="btn btn-primary" onclick="generateAllTrends()">🔄 Generate All Trends</button>
                    <div class="filter-item">
                        <select id="trends-dataset" onchange="generateAllTrends()">
                            <option value="all">All Datasets</option>
                            <option value="at">AT Only</option>
                            <option value="at-nyc">AT NYC Only</option>
                            <option value="mbt">MBT Only</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <select id="trends-grouping" onchange="generateAllTrends()">
                            <option value="month">By Month</option>
                            <option value="quarter">By Quarter</option>
                            <option value="year">By Year</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Summons Volume Over Time -->
            <div class="chart-section">
                <h4 style="color: #1e3c72; margin-bottom: 10px; font-size: 1em;">📊 Summons Volume Over Time</h4>
                <p style="color: #666; font-size: 0.85em; margin-bottom: 12px;">Total number of summonses issued per time period</p>
                <div class="chart-canvas-container">
                    <canvas id="trend-volume-chart"></canvas>
                </div>
            </div>

            <!-- Payment Status Trend -->
            <div class="chart-section">
                <h4 style="color: #1e3c72; margin-bottom: 10px; font-size: 1em;">💰 Payment Collection Trend</h4>
                <p style="color: #666; font-size: 0.85em; margin-bottom: 12px;">Track how payments, requests, and disqualifications change over time</p>
                <div class="chart-canvas-container">
                    <canvas id="trend-payment-chart"></canvas>
                </div>
            </div>

            <!-- Revenue Over Time -->
            <div class="chart-section">
                <h4 style="color: #1e3c72; margin-bottom: 10px; font-size: 1em;">💵 Revenue Over Time</h4>
                <p style="color: #666; font-size: 0.85em; margin-bottom: 12px;">Total amount paid to NYC and your 25% share</p>
                <div class="chart-canvas-container">
                    <canvas id="trend-revenue-chart"></canvas>
                </div>
            </div>

            <!-- Disqualification Rate -->
            <div class="chart-section">
                <h4 style="color: #1e3c72; margin-bottom: 10px; font-size: 1em;">❌ Disqualification Rate Over Time</h4>
                <p style="color: #666; font-size: 0.85em; margin-bottom: 12px;">Percentage of cases disqualified per period</p>
                <div class="chart-canvas-container">
                    <canvas id="trend-disqualification-chart"></canvas>
                </div>
            </div>

            <!-- Key Metrics Summary -->
            <div style="background: white; padding: 15px; border-radius: 6px; margin-top: 15px;">
                <h4 style="color: #1e3c72; margin-bottom: 12px; font-size: 1em;">📋 Period Comparison</h4>
                <div id="period-comparison" style="overflow-x: auto;">
                    <p style="color: #666; font-size: 0.85em;">Generate trends to see period-over-period comparisons</p>
                </div>
            </div>

            <!-- Top Companies Trend -->
            <div class="chart-section">
                <h4 style="color: #1e3c72; margin-bottom: 10px; font-size: 1em;">🏢 Top Companies Activity Over Time</h4>
                <p style="color: #666; font-size: 0.85em; margin-bottom: 12px;">Track summons volume for top 5 companies</p>
                <div class="chart-canvas-container">
                    <canvas id="trend-companies-chart"></canvas>
                </div>
            </div>

            <!-- Top 10 Weeks Analysis -->
            <div class="chart-section">
                <h4 style="color: #1e3c72; margin-bottom: 10px; font-size: 1em;">📅 Top 10 Weeks (Sunday-Saturday)</h4>
                <p style="color: #666; font-size: 0.85em; margin-bottom: 12px;">Busiest weeks for violations</p>
                <div id="trend-top-weeks"></div>
            </div>

            <!-- Top 10 Days Analysis -->
            <div class="chart-section">
                <h4 style="color: #1e3c72; margin-bottom: 10px; font-size: 1em;">📆 Top 10 Days</h4>
                <p style="color: #666; font-size: 0.85em; margin-bottom: 12px;">Single busiest days for violations</p>
                <div id="trend-top-days"></div>
            </div>

            <!-- Top 10 Hours Analysis -->
            <div class="chart-section">
                <h4 style="color: #1e3c72; margin-bottom: 10px; font-size: 1em;">⏰ Top 10 Hours</h4>
                <p style="color: #666; font-size: 0.85em; margin-bottom: 12px;">Most common violation times</p>
                <div id="trend-top-hours"></div>
            </div>

            <!-- Top 25 Companies Analysis -->
            <div class="chart-section">
                <h4 style="color: #1e3c72; margin-bottom: 10px; font-size: 1em;">🏆 Top 25 Companies</h4>
                <p style="color: #666; font-size: 0.85em; margin-bottom: 12px;">Companies with most submissions and their payment totals</p>
                <div id="trend-top-25-companies"></div>
            </div>
        </div>

        <!-- CHANGES Tab -->
        <div id="changes" class="tab-content">
            <div style="background: white; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                <h3 style="color: #1e3c72; margin-bottom: 12px;">🔄 Data Change Tracking</h3>
                <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">Track what changes between data refreshes - new summonses, status updates, and payment changes.</p>
                
                <div class="controls">
                    <button class="btn btn-primary" onclick="viewAllChanges()">📋 View All Changes</button>
                    <button class="btn" onclick="filterChangesByType('status')">Status Changes</button>
                    <button class="btn" onclick="filterChangesByType('payment')">Payment Changes</button>
                    <button class="btn" onclick="filterChangesByType('new')">New Summonses</button>
                    <button class="btn btn-danger" onclick="clearChangeHistory()">🗑️ Clear History</button>
                </div>
            </div>

            <!-- Summary Cards -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 20px;">
                <div style="background: linear-gradient(135deg, #27ae60 0%, #229954 100%); padding: 15px; border-radius: 6px; text-align: center; color: white;">
                    <div style="font-size: 0.8em; opacity: 0.9;">Total Changes</div>
                    <div style="font-size: 1.8em; font-weight: bold; margin: 8px 0;" id="changes-total">0</div>
                </div>
                <div style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); padding: 15px; border-radius: 6px; text-align: center; color: white;">
                    <div style="font-size: 0.8em; opacity: 0.9;">Status Changes</div>
                    <div style="font-size: 1.8em; font-weight: bold; margin: 8px 0;" id="changes-status">0</div>
                </div>
                <div style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); padding: 15px; border-radius: 6px; text-align: center; color: white;">
                    <div style="font-size: 0.8em; opacity: 0.9;">Payment Updates</div>
                    <div style="font-size: 1.8em; font-weight: bold; margin: 8px 0;" id="changes-payment">0</div>
                </div>
                <div style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); padding: 15px; border-radius: 6px; text-align: center; color: white;">
                    <div style="font-size: 0.8em; opacity: 0.9;">New Summonses</div>
                    <div style="font-size: 1.8em; font-weight: bold; margin: 8px 0;" id="changes-new">0</div>
                </div>
            </div>

            <!-- Last Refresh Info -->
            <div style="background: #e8f4f8; padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #3498db;">
                <div style="display: flex; gap: 20px; flex-wrap: wrap; font-size: 0.85em;">
                    <div><strong>Last Refresh:</strong> <span id="last-refresh-time">Never</span></div>
                    <div><strong>Changes Detected:</strong> <span id="last-refresh-changes">0</span></div>
                </div>
            </div>

            <!-- Changes Timeline -->
            <div style="background: white; padding: 15px; border-radius: 6px;">
                <h4 style="color: #1e3c72; margin-bottom: 15px; font-size: 1em;">📅 Change History Timeline</h4>
                <div id="changes-timeline" style="max-height: 600px; overflow-y: auto;">
                    <p style="text-align: center; color: #666; padding: 40px;">No changes tracked yet. Refresh your data to start tracking changes.</p>
                </div>
            </div>
        </div>

        <!-- FUN FACTS Tab -->
        <div id="fun-facts" class="tab-content">
            <div class="controls">
                <button class="btn btn-primary" onclick="generateFunFacts()">🎉 Generate Fun Facts</button>
            </div>
            <div id="fun-facts-container" style="display: grid; grid-template-columns: 1fr; gap: 15px; margin-top: 20px;"></div>
        </div>

        <!-- INSIGHTS Tab -->
        <div id="insights" class="tab-content">
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
                <h2 style="margin-bottom: 10px; font-size: 1.8em;">🚀 Advanced Analytics & Insights</h2>
                <p style="font-size: 1em; opacity: 0.95;">Powerful tools to maximize your revenue and optimize your workflow</p>
            </div>

            <!-- Dataset Filters -->
            <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <h4 style="color: #667eea; margin-bottom: 12px; font-size: 1em;">📊 Select Datasets to Analyze</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                    <div class="filter-item" style="background: #f8f9fa; padding: 10px; border-radius: 6px;">
                        <input type="checkbox" id="insights-filter-at-before" checked onchange="updateInsightsDatasetInfo()">
                        <label for="insights-filter-at-before" style="font-weight: 600;">🟢 AT (Before 10/1/24)</label>
                    </div>
                    <div class="filter-item" style="background: #f8f9fa; padding: 10px; border-radius: 6px;">
                        <input type="checkbox" id="insights-filter-at-after" checked onchange="updateInsightsDatasetInfo()">
                        <label for="insights-filter-at-after" style="font-weight: 600;">🟢 AT (After 10/1/24)</label>
                    </div>
                    <div class="filter-item" style="background: #f8f9fa; padding: 10px; border-radius: 6px;">
                        <input type="checkbox" id="insights-filter-mbt" checked onchange="updateInsightsDatasetInfo()">
                        <label for="insights-filter-mbt" style="font-weight: 600;">🔵 MBT</label>
                    </div>
                    <div class="filter-item" style="background: #f8f9fa; padding: 10px; border-radius: 6px;">
                        <input type="checkbox" id="insights-filter-at-nyc" checked onchange="updateInsightsDatasetInfo()">
                        <label for="insights-filter-at-nyc" style="font-weight: 600;">🟡 AT NYC</label>
                    </div>
                </div>
                <div id="insights-dataset-info" style="margin-top: 10px; padding: 10px; background: #e8f4f8; border-radius: 4px; font-size: 0.9em; color: #666; text-align: center;">
                    Loading dataset information...
                </div>
            </div>

            <div class="controls">
                <button class="btn btn-primary" onclick="generateAllInsights()">🚀 Generate All Insights</button>
                <button class="btn btn-success" onclick="exportInsightsReport()">📥 Export Report</button>
            </div>

            <!-- 1. Top Priority Cases -->
            <div style="background: white; padding: 20px; border-radius: 8px; margin-top: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <h3 style="color: #667eea; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.5em;">🎯</span>
                    <span>1. Top Priority Cases to Chase Now</span>
                </h3>
                <p style="color: #666; margin-bottom: 15px;">Actionable list of high-value unpaid cases ranked by priority for maximum ROI</p>
                <div id="insight-payment-predictor"></div>
            </div>

            <!-- 2. Company Intelligence Dashboard -->
            <div style="background: white; padding: 20px; border-radius: 8px; margin-top: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <h3 style="color: #667eea; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.5em;">🏢</span>
                    <span>2. Company Intelligence Dashboard</span>
                </h3>
                <p style="color: #666; margin-bottom: 15px;">Deep profiles of each company with reliability scores and recommendations</p>
                <div id="insight-company-intelligence"></div>
            </div>

            <!-- 3. Collection Optimizer -->
            <div style="background: white; padding: 20px; border-radius: 8px; margin-top: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <h3 style="color: #667eea; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.5em;">💰</span>
                    <span>3. Collection Optimizer</span>
                </h3>
                <p style="color: #666; margin-bottom: 15px;">Your prioritized to-do list: which cases to chase this week for maximum ROI</p>
                <div id="insight-collection-optimizer"></div>
            </div>

            <!-- 4. Cash Flow Forecaster -->
            <div style="background: white; padding: 20px; border-radius: 8px; margin-top: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <h3 style="color: #667eea; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.5em;">📊</span>
                    <span>4. Cash Flow Forecaster</span>
                </h3>
                <p style="color: #666; margin-bottom: 15px;">Predict when money will hit your account based on pending requests</p>
                <div id="insight-cash-flow"></div>
            </div>

            <!-- 5. Disqualification Detective -->
            <div style="background: white; padding: 20px; border-radius: 8px; margin-top: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <h3 style="color: #667eea; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.5em;">🔍</span>
                    <span>5. Disqualification Detective</span>
                </h3>
                <p style="color: #666; margin-bottom: 15px;">Find patterns in your losses to reduce disqualification rate</p>
                <div id="insight-disqualification"></div>
            </div>

            <!-- 6. Geographic Heat Map -->
            <div style="background: white; padding: 20px; border-radius: 8px; margin-top: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <h3 style="color: #667eea; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.5em;">🗺️</span>
                    <span>6. Geographic Heat Map</span>
                </h3>
                <p style="color: #666; margin-bottom: 15px;">Where to hunt: violation density and payment rates by location</p>
                <div id="insight-geographic"></div>
            </div>

            <!-- 7. Smart Alert System -->
            <div style="background: white; padding: 20px; border-radius: 8px; margin-top: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <h3 style="color: #667eea; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.5em;">🔔</span>
                    <span>7. Smart Alert System</span>
                </h3>
                <p style="color: #666; margin-bottom: 15px;">Real-time notifications for urgent actions needed</p>
                <div id="insight-alerts"></div>
            </div>

            <!-- 8. Seasonal Demand Planner -->
            <div style="background: white; padding: 20px; border-radius: 8px; margin-top: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <h3 style="color: #667eea; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.5em;">📅</span>
                    <span>8. Seasonal Demand Planner</span>
                </h3>
                <p style="color: #666; margin-bottom: 15px;">Predict violation volume by month and season</p>
                <div id="insight-seasonal"></div>
            </div>

            <!-- 9. Revenue Maximization Opportunities -->
            <div style="background: white; padding: 20px; border-radius: 8px; margin-top: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <h3 style="color: #667eea; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.5em;">💰</span>
                    <span>9. Revenue Maximization Opportunities</span>
                </h3>
                <p style="color: #666; margin-bottom: 15px;">Identify and quantify your biggest revenue opportunities to maximize earnings</p>
                <div id="insight-behavior-change"></div>
            </div>

            <!-- 10. ROI Time Tracker -->
            <div style="background: white; padding: 20px; border-radius: 8px; margin-top: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <h3 style="color: #667eea; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.5em;">⏱️</span>
                    <span>10. ROI & Performance Metrics</span>
                </h3>
                <p style="color: #666; margin-bottom: 15px;">Revenue per case type and profitability analysis</p>
                <div id="insight-roi"></div>
            </div>

            <!-- 11. Con Edison Deep Dive -->
            <div style="background: white; padding: 20px; border-radius: 8px; margin-top: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <h3 style="color: #667eea; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.5em;">⚡</span>
                    <span>11. Con Edison Complete Analysis</span>
                </h3>
                <p style="color: #666; margin-bottom: 15px;">Comprehensive data on your largest customer - all Con Ed variations grouped</p>
                <div id="insight-coned"></div>
            </div>
        </div>

        <!-- CHARTS Tab -->
        <div id="charts" class="tab-content">
            <div class="chart-section">
                <h3 style="margin-bottom: 15px; color: #1e3c72;">📊 Data Visualizations</h3>
                
                <!-- Quick Insights -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                    <h4 style="color: #1e3c72; margin-bottom: 10px; font-size: 1em;">⚡ Quick Insights</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px;">
                        <button class="btn btn-primary" onclick="showPaymentStatusChart()" style="font-size: 0.75em; padding: 8px;">Payment Status</button>
                        <button class="btn btn-primary" onclick="showCompanyChart()" style="font-size: 0.75em; padding: 8px;">Top Companies</button>
                        <button class="btn btn-primary" onclick="showBoroughChart()" style="font-size: 0.75em; padding: 8px;">By Borough</button>
                        <button class="btn btn-primary" onclick="showMonthlyTrend()" style="font-size: 0.75em; padding: 8px;">Monthly Trend</button>
                        <button class="btn btn-primary" onclick="showHearingResults()" style="font-size: 0.75em; padding: 8px;">Hearing Results</button>
                        <button class="btn btn-primary" onclick="showRevenueAnalysis()" style="font-size: 0.75em; padding: 8px;">Revenue Analysis</button>
                    </div>
                </div>

                <!-- Custom Chart Builder -->
                <div style="background: white; padding: 15px; border-radius: 6px; margin-bottom: 20px; border: 2px solid #5a7fa7;">
                    <h4 style="color: #1e3c72; margin-bottom: 12px; font-size: 1em;">🎨 Custom Chart Builder</h4>
                    
                    <div class="chart-type-buttons">
                        <button class="chart-type-btn active" onclick="setChartType('pie')">Pie</button>
                        <button class="chart-type-btn" onclick="setChartType('bar')">Bar</button>
                        <button class="chart-type-btn" onclick="setChartType('line')">Line</button>
                        <button class="chart-type-btn" onclick="setChartType('doughnut')">Doughnut</button>
                        <button class="chart-type-btn" onclick="setChartType('horizontalBar')">H-Bar</button>
                    </div>

                    <div class="chart-controls">
                        <div class="chart-control-group">
                            <label>📁 Data Source</label>
                            <select id="chart-tab-selector">
                                <option value="all">All Datasets Combined</option>
                                <option value="at">AT Only</option>
                                <option value="at-nyc">AT NYC Only</option>
                                <option value="mbt">MBT Only</option>
                            </select>
                        </div>

                        <div class="chart-control-group">
                            <label>📊 Measure</label>
                            <select id="chart-measure">
                                <option value="count">Count of Records</option>
                                <option value="sum-paid">Sum of Paid Amount</option>
                                <option value="avg-paid">Average Paid Amount</option>
                                <option value="sum-balance">Sum of Balance Due</option>
                            </select>
                        </div>

                        <div class="chart-control-group">
                            <label>🏷️ Group By</label>
                            <select id="chart-field-selector">
                                <option value="Payment Status">Payment Status</option>
                                <option value="Status">Status</option>
                                <option value="Hearing Status">Hearing Status</option>
                                <option value="Hearing Result">Hearing Result</option>
                                <option value="Company Name">Company Name</option>
                                <option value="Issuing Agency">Issuing Agency</option>
                                <option value="Violation Location (Borough)">Borough</option>
                                <option value="month">Month (from Violation Date)</option>
                                <option value="year">Year (from Violation Date)</option>
                            </select>
                        </div>

                        <div class="chart-control-group">
                            <label>🎯 Filter by Status</label>
                            <select id="chart-status-filter">
                                <option value="">All Statuses</option>
                                <option value="paid">Paid Only</option>
                                <option value="requested">Requested Only</option>
                                <option value="disqualified">Disqualified Only</option>
                                <option value="unpaid">Unpaid Only</option>
                            </select>
                        </div>

                        <div class="chart-control-group">
                            <label>📅 Date Range</label>
                            <select id="chart-date-range">
                                <option value="all">All Time</option>
                                <option value="ytd">Year to Date</option>
                                <option value="last-12">Last 12 Months</option>
                                <option value="last-6">Last 6 Months</option>
                                <option value="last-3">Last 3 Months</option>
                                <option value="this-year">This Year</option>
                                <option value="last-year">Last Year</option>
                            </select>
                        </div>

                        <div class="chart-control-group">
                            <label>🔢 Max Items</label>
                            <select id="chart-max-items">
                                <option value="5">Top 5</option>
                                <option value="10" selected>Top 10</option>
                                <option value="15">Top 15</option>
                                <option value="20">Top 20</option>
                                <option value="all">Show All</option>
                            </select>
                        </div>

                        <div class="chart-control-group">
                            <label>📈 Sort By</label>
                            <select id="chart-sort">
                                <option value="value-desc">Value (High to Low)</option>
                                <option value="value-asc">Value (Low to High)</option>
                                <option value="label-asc">Label (A to Z)</option>
                                <option value="label-desc">Label (Z to A)</option>
                            </select>
                        </div>

                        <div class="chart-control-group">
                            <label>🎨 Color Scheme</label>
                            <select id="chart-color-scheme">
                                <option value="default">Default Rainbow</option>
                                <option value="blue">Blue Gradient</option>
                                <option value="green">Green Gradient</option>
                                <option value="red">Red Gradient</option>
                                <option value="purple">Purple Gradient</option>
                                <option value="status">Status Colors</option>
                            </select>
                        </div>
                    </div>

                    <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 15px;">
                        <button class="btn btn-primary" onclick="updateGlobalChart()">🎨 Generate Chart</button>
                        <button class="btn btn-success" onclick="exportChartImage()">💾 Save as Image</button>
                        <button class="btn" onclick="exportChartDataCSV()">📄 Export Data (CSV)</button>
                    </div>
                </div>

                <!-- Chart Display Area -->
                <div style="background: white; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                    <div id="chart-title" style="text-align: center; font-size: 1.1em; font-weight: bold; color: #1e3c72; margin-bottom: 15px;">
                        Select options and click Generate Chart
                    </div>
                    <div class="chart-canvas-container">
                        <canvas id="global-chart"></canvas>
                    </div>
                </div>

                <!-- Statistics Panel -->
                <div id="chart-stats" style="background: #f8f9fa; padding: 15px; border-radius: 6px; display: none;"></div>

                <!-- Data Table -->
                <div id="chart-data-table" style="background: white; padding: 15px; border-radius: 6px; margin-top: 20px; display: none;">
                    <h4 style="color: #1e3c72; margin-bottom: 10px; font-size: 1em;">📋 Chart Data</h4>
                    <div style="overflow-x: auto;">
                        <table id="chart-table" style="width: 100%; font-size: 0.85em;">
                            <thead id="chart-table-head"></thead>
                            <tbody id="chart-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- SETTINGS Tab -->
        <div id="settings" class="tab-content">
            <div class="settings-panel">
                <div class="settings-section">
                    <h3>📊 Google Sheets Configuration</h3>
                    <p style="margin-bottom: 15px; color: #666; font-size: 0.9em;">Enter the URLs of your Google Sheets. Make sure each sheet is published to the web (File → Share → Publish to web → CSV format).</p>
                    
                    <h4 style="margin: 15px 0 10px 0; color: #1e3c72;">AT Dataset</h4>
                    <div class="sheet-input-group">
                        <label>Master Data:</label>
                        <input type="text" id="sheet-at-master" placeholder="https://docs.google.com/..." onchange="saveSheetURLs()">
                    </div>
                    <div class="sheet-input-group">
                        <label>Paid from NYC:</label>
                        <input type="text" id="sheet-at-paid" placeholder="https://docs.google.com/..." onchange="saveSheetURLs()">
                    </div>
                    <div class="sheet-input-group">
                        <label>Payment Requests:</label>
                        <input type="text" id="sheet-at-requests" placeholder="https://docs.google.com/..." onchange="saveSheetURLs()">
                    </div>

                    <h4 style="margin: 15px 0 10px 0; color: #1e3c72;">AT NYC Dataset</h4>
                    <div class="sheet-input-group">
                        <label>Master Data:</label>
                        <input type="text" id="sheet-at-nyc-master" placeholder="https://docs.google.com/..." onchange="saveSheetURLs()">
                    </div>
                    <div class="sheet-input-group">
                        <label>Paid from NYC:</label>
                        <input type="text" id="sheet-at-nyc-paid" placeholder="https://docs.google.com/..." onchange="saveSheetURLs()">
                    </div>
                    <div class="sheet-input-group">
                        <label>Payment Requests:</label>
                        <input type="text" id="sheet-at-nyc-requests" placeholder="https://docs.google.com/..." onchange="saveSheetURLs()">
                    </div>

                    <h4 style="margin: 15px 0 10px 0; color: #1e3c72;">MBT Dataset</h4>
                    <div class="sheet-input-group">
                        <label>Master Data:</label>
                        <input type="text" id="sheet-mbt-master" placeholder="https://docs.google.com/..." onchange="saveSheetURLs()">
                    </div>
                    <div class="sheet-input-group">
                        <label>Paid from NYC:</label>
                        <input type="text" id="sheet-mbt-paid" placeholder="https://docs.google.com/..." onchange="saveSheetURLs()">
                    </div>
                    <div class="sheet-input-group">
                        <label>Payment Requests:</label>
                        <input type="text" id="sheet-mbt-requests" placeholder="https://docs.google.com/..." onchange="saveSheetURLs()">
                    </div>

                    <button class="btn btn-success" onclick="loadAllData()">Load All Data</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global data storage
        const appData = {
            'at': { master: [], paid: [], requests: [], merged: [], filtered: [], currentPage: 1, pageSize: 'all', showExtra: false, lastRefreshSheets: null, lastRefreshNYC: null },
            'at-nyc': { master: [], paid: [], requests: [], merged: [], filtered: [], currentPage: 1, pageSize: 'all', showExtra: false, lastRefreshSheets: null, lastRefreshNYC: null },
            'mbt': { master: [], paid: [], requests: [], merged: [], filtered: [], currentPage: 1, pageSize: 'all', showExtra: false, lastRefreshSheets: null, lastRefreshNYC: null }
        };

        const sheetURLs = {
            'at': { 
                master: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ1o9qMz_zElO_r9I5ViHfeBmRQCv46NiecZoLDAOG76oojqjMnkd2Sy1MWZFYDYyE5RJ7OpFZXQ9Vb/pub?output=csv', 
                paid: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTwItpq2AsDCUfw9cEkRGe3E9JqXmIKQXztaXJSXiM4M6u1kwTzfszMAw3CgKXCa8tteoidy0MyMMoh/pub?output=csv', 
                requests: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS6Z2wJLGR3zBW0dSUxReBhrgzu0iKOpUURySRtnjL5R-7JJp_F8UCyqBO9kcJoJAmertKe7yQwuX31/pub?output=csv' 
            },
            'at-nyc': { 
                master: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRncTRjr3qqbr3n0iFhLr7kJ-1pwpVg9t1NJtR2RQFHsuq2QAQcyo75WgyQ1MVqZcY5gfDw2zy8jM67/pub?output=csv', 
                paid: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSKFvWDobRvxkaLQUZoVFh-YLag37CTTubJMRYS7KpS_Xv4a7ts3bhvdlU1s_mKiQY5FWKpaW7SjD2H/pub?output=csv', 
                requests: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT7mgKpDJmK_BbcK98IZUqUm2S5zk97nLdxndeVKAtOF5gjMzgjIGrSfm18fj5lFWEGgfJMJh8ZvmEC/pub?output=csv' 
            },
            'mbt': { 
                master: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQEdHNxEgIJnRElve2T6iUA-racSM-4Y871MGa6ruZ_Id8pGaENVZOAHRwOqNeypl7unfnSlHVgKnjK/pub?output=csv', 
                paid: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRBmD38Ggf3XOiDTgkmAjW0zOQfmTJyQTSxHFdj4GtgugY1L0ZO4gkgWvOcBT8OlgQ5TJSOL27_qM86/pub?output=csv', 
                requests: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTZtnehNQnyC0Zd794OvuYJtUVQFMou3IWUdnOQY491BNisPe3aIYvYHjsxJkTbtb_Eo9TW0H8u-Wzn/pub?output=csv' 
            }
        };

        let currentSortColumn = {};
        let currentSortDirection = {};
        let globalChart = null;
        let currentChartType = 'pie';
        let autoRefreshInterval = null;
        let filterDebounceTimers = {};
        let changeHistory = [];
        let currentChangeFilter = 'all';
        let mismatchesData = {}; // Store mismatches for PDF export

        const extraNYCFields = [
            'Violation Time', 'Issuing Agency', 'Respondent First Name', 'Respondent Last Name',
            'Balance Due', 'Violation Location (Borough)', 'Violation Location (House #)',
            'Violation Location (Street Name)', 'Hearing Result', 'Total Violation Amount'
        ];
        
        const defaultColumns = [
            'Complaint Number', 'Summons Number', 'Violation Date', 'Company Name',
            'Place of Occurrence', 'Status', 'Date Submitted', 'Hearing Date',
            'Paid Amount', 'Paid To Me', 'Payment Status', 'Payment Received',
            'Hearing Status', 'Hearing Result'
        ];

        const nycFieldMapping = {
            'ticket_number': 'Ticket Number',
            'violation_date': 'Violation Date',
            'respondent_last_name': 'Respondent Last Name',
            'paid_amount': 'Paid Amount',
            'hearing_status': 'Hearing Status',
            'hearing_date': 'Hearing Date',
            'violation_time': 'Violation Time',
            'issuing_agency': 'Issuing Agency',
            'respondent_first_name': 'Respondent First Name',
            'balance_due': 'Balance Due',
            'violation_location_borough': 'Violation Location (Borough)',
            'violation_location_house': 'Violation Location (House #)',
            'violation_location_street_name': 'Violation Location (Street Name)',
            'hearing_result': 'Hearing Result',
            'total_violation_amount': 'Total Violation Amount'
        };

        const companyNameMapping = {
            'A&L CESSPOOL SERVICE CORP': 'AL CESSPOOL SERVICE',
            'A.B.R. PLUMBING': 'ABR PLUMBING',
            'AB ONE': 'AB ONE',
            'ABBEY LOCKSMITHS': 'ABBEY LOCKSMITHS',
            'ABBEY LOCKSMITHS INC.': 'ABBEY LOCKSMITHS',
            'ABR PLUMBING': 'ABR PLUMBING',
            'ACV ENVIRONMENTAL SERVICES INC': 'ACV ENVIRONMENTAL SERVICES',
            'ADVANCE': 'ADVANCE',
            'ADVANCED ELECTRONIC SOLUTIONS INC': 'ADVANCED ELECTRONIC SOLUTIONS',
            'ADVANCED ELECTRONIC SOLUTIONS INC.': 'ADVANCED ELECTRONIC SOLUTIONS',
            'AGILITY CABLE': 'AGILITY CABLE',
            'AGILITY CABLE INC': 'AGILITY CABLE',
            'AINSWORTH': 'AINSWORTH',
            'AINSWORTH INC': 'AINSWORTH',
            'ALL CITY METAL': 'ALL CITY METAL',
            'ALL CITY METAL INC': 'ALL CITY METAL',
            'ALLNET TECHNOLOGY SOLUTION CORP': 'ALLNET TECHNOLOGY SOLUTION',
            'ALLNET TECHNOLOGY SOLUTION CORP.': 'ALLNET TECHNOLOGY SOLUTION',
            'AMAZON LOGISTICS INC': 'AMAZON LOGISTICS',
            'AMAZON LOGISTICS INC.': 'AMAZON LOGISTICS',
            'AMERICOLD': 'AMERICOLD',
            'AMERICOLD INC': 'AMERICOLD',
            'BALDOR EXPRESS TRANSPORTATION CO': 'BALDOR EXPRESS TRANSPORTATION',
            'BALDOR EXPRESS TRANSPORTATION CO LLC': 'BALDOR EXPRESS TRANSPORTATION',
            'BARN RENTALS': 'BARN RENTALS',
            'BELLA BUS CORP': 'BELLA BUS',
            'BELLA BUS CORP.': 'BELLA BUS',
            'BLUETRITON BRANDS INC': 'BLUETRITON BRANDS',
            'BLUETRITON BRANDS INC.': 'BLUETRITON BRANDS',
            'BROADWAY PARTY RENTALS': 'BROADWAY PARTY RENTALS',
            'BUCKMILLER AUTOMATIC SPRINKLER CORP': 'BUCKMILLER AUTOMATIC SPRINKLER',
            'C & J XPRESS CORP': 'C J XPRESS',
            'C & J XPRESS CORP.': 'C J XPRESS',
            'C.C. RENTAL': 'CC RENTAL',
            'CC RENTAL': 'CC RENTAL',
            'COURIER CAR RENTAL': 'CC RENTAL',
            'COURIER CAR RENTAL INC': 'CC RENTAL',
            'COURIER CAR RENTAL INC.': 'CC RENTAL',
            'CDM TRUCKING CORP': 'CDM TRUCKING',
            'CENTURY ELEVATOR': 'CENTURY ELEVATOR',
            'CHAMPION ELEVATOR': 'CHAMPION ELEVATOR',
            'CHARTER COMMUNICATIONS LLC': 'CHARTER COMMUNICATIONS',
            'CITIWAVE TRADING INC': 'CITIWAVE TRADING',
            'CITIWAVE TRADING INC.': 'CITIWAVE TRADING',
            'CLANCY MOVING SYSTEMS INC': 'CLANCY MOVING SYSTEMS',
            'CLEAN AIR GROUP': 'CLEAN AIR GROUP',
            'CLEAN AIR GROUP INC': 'CLEAN AIR GROUP',
            
            // FIXED: All Con Edison variations now map to one name
            'CONSOLIDATED EDISON COMPANY OF NEW YORK INC': 'CON EDISON',
            'CONSOLIDATED EDISON COMPANY OF NEW YORK INC.': 'CON EDISON',
            'CONSOLIDATED EDISON COMPANY OF NEW YORK, INC.': 'CON EDISON',
            'CONSOLIDATED EDISON COMPANY OF NY INC': 'CON EDISON',
            'CONSOLIDATED EDISON COMPANY OF NY INC.': 'CON EDISON',
            'CONSOLIDATED EDISON': 'CON EDISON',
            'CON EDISON': 'CON EDISON',
            'CON ED': 'CON EDISON',
            'CONED': 'CON EDISON',
            
            'CORNERSTONE CONTRACTING INC': 'CORNERSTONE CONTRACTING',
            'CORNERSTONE CONTRACTING, INC': 'CORNERSTONE CONTRACTING',
            'CORPORATE COFFEE SYSTEMS': 'CORPORATE COFFEE SYSTEMS',
            'CREATIVE GRAIN': 'CREATIVE GRAIN',
            'CREATIVE GRAIN LLC': 'CREATIVE GRAIN',
            'CROSS FIRE & SECURITY': 'CROSS FIRE SECURITY',
            'CROSS FIRE & SECURITY CO INC.': 'CROSS FIRE SECURITY',
            'CYM TRANSPORTATION INC': 'CYM TRANSPORTATION',
            'CYM TRANSPORTATION INC.': 'CYM TRANSPORTATION',
            'DATA-STRUCTION INC': 'DATA-STRUCTION',
            'DATA-STRUCTION INC.': 'DATA-STRUCTION',
            'DEPENDABLE GLASS & MIRROR': 'DEPENDABLE GLASS MIRROR',
            'DONNELLY MECHANICAL': 'DONNELLY MECHANICAL',
            'DONNELLY MECHANICAL CORP': 'DONNELLY MECHANICAL',
            'DONNELLY MECHANICAL INC': 'DONNELLY MECHANICAL',
            'DRAIN KLEEN SEWER SERVICE INC': 'DRAIN KLEEN SEWER SERVICE',
            'EAN HOLDINGS LLC': 'EAN HOLDINGS',
            'EAN HOLDINGS, LLC': 'EAN HOLDINGS',
            'EDGE AUTO INC': 'EDGE AUTO',
            'EDGE AUTO INC.': 'EDGE AUTO',
            'EDGE AUTO RENTAL': 'EDGE AUTO RENTAL',
            'ELDORADO': 'ELDORADO',
            'FEDERAL EXPRESS CORP': 'FEDERAL EXPRESS',
            'FEDERAL EXPRESS CORPORATION': 'FEDERAL EXPRESS',
            'FEDEX': 'FEDEX',
            'FEDEX GROUND PACKAGE SYSTEM INC': 'FEDEX GROUND PACKAGE SYSTEM',
            'FEDEX GROUND PACKAGE SYSTEM INC.': 'FEDEX GROUND PACKAGE SYSTEM',
            'FIRE RESPONSE INC': 'FIRE RESPONSE',
            'FIRE RESPONSE INC.': 'FIRE RESPONSE',
            'FIRSTLINE LOCKSMITH': 'FIRSTLINE LOCKSMITH',
            'FIRSTLINE LOCKSMITH LLC': 'FIRSTLINE LOCKSMITH',
            'GC PLUMBING & HEATING': 'GC PLUMBING HEATING',
            'GO NEW YORK TOURS': 'GO NEW YORK TOURS',
            'GO NEW YORK TOURS INC': 'GO NEW YORK TOURS',
            'GRAND PRIX TRADING CORP': 'GRAND PRIX TRADING',
            'GTSD TRANSPORT LLC': 'GTSD TRANSPORT',
            'HADDAD\'S INC': 'HADDAD\'S',
            'HARVARD MAINTENANCE INC': 'HARVARD MAINTENANCE',
            'HERCULES': 'HERCULES',
            'HERCULES CORP.': 'HERCULES',
            'HIGHBURY CONCRETE': 'HIGHBURY CONCRETE',
            'HJV ENTERPRISE': 'HJV ENTERPRISE',
            'HJV ENTERPRISE INC': 'HJV ENTERPRISE',
            'HUB TRUCK RENTAL': 'HUB TRUCK RENTAL',
            'HUB TRUCK RENTAL CORP': 'HUB TRUCK RENTAL',
            'HUB TRUCK RENTAL INC': 'HUB TRUCK RENTAL',
            'HUGH O\'KANE ELECTRIC CO INC': 'HUGH O\'KANE ELECTRIC',
            'HUGH O\'KANE ELECTRIC CO. INC.': 'HUGH O\'KANE ELECTRIC',
            'INDUSTRIAL COOLING INC': 'INDUSTRIAL COOLING',
            'INDUSTRIAL COOLING, INC': 'INDUSTRIAL COOLING',
            'INDUSTRIAL SOLUTIONS OF NY INC': 'INDUSTRIAL SOLUTIONS OF NY',
            'INDUSTRIAL SOLUTIONS OF NY, INC': 'INDUSTRIAL SOLUTIONS OF NY',
            'INTEGRITY SCAFFOLD SERVICE GROUP': 'INTEGRITY SCAFFOLD SERVICE GROUP',
            'IRON MOUNTAIN INFORMATION MANAGEMENT SERVICES': 'IRON MOUNTAIN INFORMATION MANAGEMENT SERVICES',
            'IRON MOUNTAIN INFORMATION MANAGEMENT SERVICES INC': 'IRON MOUNTAIN INFORMATION MANAGEMENT SERVICES',
            'IRON MOUNTAIN INFORMATION MANAGEMENT SERVICES, INC': 'IRON MOUNTAIN INFORMATION MANAGEMENT SERVICES',
            'JDP MECHANICAL': 'JDP MECHANICAL',
            'JDP MECHANICAL INC': 'JDP MECHANICAL',
            'JEROME ALUMINUM PRODUCTS': 'JEROME ALUMINUM PRODUCTS',
            'JEROME ALUMINUM PRODUCTS CORPORATION': 'JEROME ALUMINUM PRODUCTS',
            'JOVIN DEMO': 'JOVIN DEMO',
            'JOVIN DEMO INCORPORATED': 'JOVIN DEMO',
            'JTC PAINTING & DECORATING CORP': 'JTC PAINTING DECORATING',
            'JTC PAINTING DECORATING CORP': 'JTC PAINTING DECORATING',
            'KONE': 'KONE',
            'KONE INC': 'KONE',
            'KONE INC.': 'KONE',
            'KP MEC INC': 'KP MEC',
            'LEARDON BOILER WORKS INC': 'LEARDON BOILER WORKS',
            'LEYVA TRANSPORTATION CORP': 'LEYVA TRANSPORTATION',
            'LEYVA TRANSPORTATION CORP.': 'LEYVA TRANSPORTATION',
            'LIDO STONE WORKS': 'LIDO STONE WORKS',
            'LIDO STONE WORKS LLC': 'LIDO STONE WORKS',
            'MAK-STAR LLC': 'MAK-STAR',
            'MAQUETTE FINE ART SERVICES': 'MAQUETTE FINE ART SERVICES',
            'MAQUETTE FINE ART SERVICES LLC': 'MAQUETTE FINE ART SERVICES',
            'MARCELL TRANSPORT LLC': 'MARCELL TRANSPORT',
            'MERCHANTS AUTOMOTIVE GROUP INC': 'MERCHANTS AUTOMOTIVE GROUP',
            'MERCHANTS AUTOMOTIVE GROUP INC.': 'MERCHANTS AUTOMOTIVE GROUP',
            'MJJ SERVICE INC': 'MJJ SERVICE',
            'MJJ SERVICE, INC.': 'MJJ SERVICE',
            'MTLR CORP': 'MTLR',
            'NEPTUNE MACHINE': 'NEPTUNE MACHINE',
            'NEPTUNE MACHINE INC': 'NEPTUNE MACHINE',
            'NOUVEAU ELEVATOR': 'NOUVEAU ELEVATOR',
            'PENSKE LEASING & RENTAL CO': 'PENSKE LEASING RENTAL',
            'PENSKE LEASING & RENTAL CO.': 'PENSKE LEASING RENTAL',
            'PENSKE TRUCK LEASING CORPORATION': 'PENSKE TRUCK LEASING',
            'PIECE OF CAKE MOVING + STORAGE': 'PIECE OF CAKE MOVING + STORAGE',
            'PIECE OF CAKE MOVING + STORAGE LLC': 'PIECE OF CAKE MOVING + STORAGE',
            'PINK PINK TRADING INC': 'PINK PINK TRADING',
            'PRECISION PIPELINE SOLUTIONS': 'PRECISION PIPELINE SOLUTIONS',
            'PRECISION PIPELINE SOLUTIONS, LLC': 'PRECISION PIPELINE SOLUTIONS',
            'PRESTIGIOUS MAINTENANCE': 'PRESTIGIOUS MAINTENANCE',
            'PRESTIGIOUS MAINTENANCE INC': 'PRESTIGIOUS MAINTENANCE',
            'PRIDE & SERVICE ELEVATOR': 'PRIDE SERVICE ELEVATOR',
            'PRIDE & SERVICE ELEVATOR CO INC': 'PRIDE SERVICE ELEVATOR',
            'PRIDE TRANSPORTATION SERVICES INC': 'PRIDE TRANSPORTATION SERVICES',
            'PRO AIR MECHANICAL': 'PRO AIR MECHANICAL',
            'PRO AIR MECHANICAL CORP': 'PRO AIR MECHANICAL',
            'RAEL FIRE PROTECTION': 'RAEL FIRE PROTECTION',
            'RIVIERA PRODUCE': 'RIVIERA PRODUCE',
            'RIVIERA PRODUCE CORP': 'RIVIERA PRODUCE',
            'RX ELECTRIC': 'RX ELECTRIC',
            'RYDER TRUCK RENTAL INC': 'RYDER TRUCK RENTAL',
            'RYDER TRUCK RENTAL INC.': 'RYDER TRUCK RENTAL',
            'RYDER TRUCK RENTAL LTD': 'RYDER TRUCK RENTAL',
            'SAFWAY ATLANTIC': 'SAFWAY ATLANTIC',
            'SAFWAY ATLANTIC LLC': 'SAFWAY ATLANTIC',
            'SALEM TRUCK LEASING INC': 'SALEM TRUCK LEASING',
            'SALEM TRUCK LEASING INC.': 'SALEM TRUCK LEASING',
            'SCHINDLER ELEVATOR': 'SCHINDLER ELEVATOR',
            'SECURITY PRO NY INC': 'SECURITY PRO NY',
            'SECURITY PRO NY INC.': 'SECURITY PRO NY',
            'SOVEREIGN SERVICE': 'SOVEREIGN SERVICE',
            'SOVEREIGN SERVICE CORP': 'SOVEREIGN SERVICE',
            'STAGE CALL CORPORATION': 'STAGE CALL',
            'SUNBELT RENTALS': 'SUNBELT RENTALS',
            'SUNBELT RENTALS INC': 'SUNBELT RENTALS',
            'SUPERIOR PLUMBING HEATING MECHANICAL': 'SUPERIOR PLUMBING HEATING MECHANICAL',
            'SUPERIOR PLUMBING, HEATING & MECHANICAL LLC': 'SUPERIOR PLUMBING HEATING MECHANICAL',
            'SYSTEMS 2000 PLUMBING SERVICE': 'SYSTEMS 2000 PLUMBING SERVICE',
            'SYSTEMS 2000 PLUMBING SERVICE INC': 'SYSTEMS 2000 PLUMBING SERVICE',
            'TAEIL ENTERPRISE INC': 'TAEIL ENTERPRISE',
            'TAEIL ENTERPRISE LLC': 'TAEIL ENTERPRISE',
            'TEAM ELECTRIC': 'TEAM ELECTRIC',
            'TEAM ELECTRIC INC': 'TEAM ELECTRIC',
            'TOUCH UP CLEANING': 'TOUCH UP CLEANING',
            'TRI-STAR PLUMBING & HEATING': 'TRI-STAR PLUMBING HEATING',
            'U-HAUL CO OF NEW YORK AND VERMONT': 'U-HAUL CO OF NEW YORK AND VERMONT',
            'U-HAUL CO OF NEW YORK AND VERMONT INC': 'U-HAUL CO OF NEW YORK AND VERMONT',
            'U-HAUL CO. OF NEW YORK AND VERMONT INC.': 'U-HAUL CO OF NEW YORK AND VERMONT',
            'U-HAUL CO. OF NEW YORK AND VERMONT, INC.': 'U-HAUL CO OF NEW YORK AND VERMONT',
            'U.T.F. TRUCKING INC.': 'UTF TRUCKING',
            'UHAUL': 'UHAUL',
            'UNITED VAN LINES': 'UNITED VAN LINES',
            'UNITED VAN LINES LLC': 'UNITED VAN LINES',
            'UPRIGHT INSTALLATIONS': 'UPRIGHT INSTALLATIONS',
            'UPRIGHT INSTALLATIONS INC': 'UPRIGHT INSTALLATIONS',
            'UTF TRUCKING': 'UTF TRUCKING',
            'VALLE TRANSPORTATION SERVICE': 'VALLE TRANSPORTATION SERVICE',
            'VALLE TRANSPORTATION SERVICE LLC': 'VALLE TRANSPORTATION SERVICE',
            'VERIZON BUSINESS NETWORK SERVICES LLC': 'VERIZON BUSINESS NETWORK SERVICES',
            'VIXXO': 'VIXXO'
        };
        
        // Normalize company names to group variations together
        function normalizeCompanyName(companyName) {
            if (!companyName) return 'Unknown';
            
            const normalized = companyName.toUpperCase().trim();
            
            // Check if there's a mapping for this company
            if (companyNameMapping[normalized]) {
                return companyNameMapping[normalized];
            }
            
            // Return the normalized (uppercase) version for consistency
            return normalized;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            return dateStr.replace(/T\d{2}:\d{2}:\d{2}\.\d{3}/, '');
        }

        function toggleExtraColumns(tab) {
            appData[tab].showExtra = document.getElementById(`${tab}-show-extra`).checked;
            renderTable(tab);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function debouncedApplyFilters(tab) {
            if (filterDebounceTimers[tab]) {
                clearTimeout(filterDebounceTimers[tab]);
            }
            filterDebounceTimers[tab] = setTimeout(() => {
                applyFilters(tab);
            }, 300);
        }

        function getColumns(tab) {
            const filteredData = appData[tab].filtered;
            if (filteredData.length === 0) return [];

            const allColumnsSet = new Set();
            filteredData.forEach(row => {
                Object.keys(row).forEach(col => {
                    if (!col.startsWith('_')) {
                        allColumnsSet.add(col);
                    }
                });
            });
            let allColumns = Array.from(allColumnsSet);
            
            let columns = [];
            
            if (!appData[tab].showExtra) {
                columns = defaultColumns.filter(col => allColumns.includes(col));
            } else {
                columns = defaultColumns.filter(col => allColumns.includes(col));
                extraNYCFields.forEach(field => {
                    if (!columns.includes(field)) {
                        columns.push(field);
                    }
                });
            }

            return columns;
        }

        window.onload = function() {
            loadSheetURLs();
            loadFromStorage();
            loadChangeHistory();
            startAutoRefresh();
        };

        function startAutoRefresh() {
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
            autoRefreshInterval = setInterval(() => {
                loadAllData(true);
            }, 300000);
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            
            const tabElement = document.getElementById(tabName);
            tabElement.classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'new-money') {
                renderNewMoney();
            } else if (tabName === 'changes') {
                renderChangesView();
            } else if (tabName === 'insights') {
                updateInsightsDatasetInfo();
            }
        }

        function toggleFilters(tab) {
            const filtersDiv = document.getElementById(`${tab}-filters`);
            const icon = document.getElementById(`${tab}-filters-icon`);
            
            if (filtersDiv.classList.contains('show')) {
                filtersDiv.classList.remove('show');
                icon.classList.remove('open');
            } else {
                filtersDiv.classList.add('show');
                icon.classList.add('open');
            }
        }

        function convertToCSVUrl(url) {
            if (!url) return '';
            if (url.includes('pub?output=csv') || url.includes('export?format=csv')) {
                return url;
            }
            const match = url.match(/\/d\/([a-zA-Z0-9-_]+)/);
            if (match) {
                const sheetId = match[1];
                return `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv`;
            }
            return url;
        }

        async function fetchWithCORS(url) {
            try {
                const response = await fetch(url);
                if (response.ok) {
                    return await response.text();
                }
            } catch (error) {
                console.log('Direct fetch failed, trying CORS proxy...');
            }

            const corsProxies = [
                `https://corsproxy.io/?${encodeURIComponent(url)}`,
                `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`
            ];

            for (const proxyUrl of corsProxies) {
                try {
                    const response = await fetch(proxyUrl);
                    if (response.ok) {
                        return await response.text();
                    }
                } catch (error) {
                    console.log('Proxy failed:', error.message);
                }
            }

            throw new Error('Failed to fetch from Google Sheets');
        }

        function saveSheetURLs() {
            ['at', 'at-nyc', 'mbt'].forEach(tab => {
                sheetURLs[tab].master = document.getElementById(`sheet-${tab}-master`).value;
                sheetURLs[tab].paid = document.getElementById(`sheet-${tab}-paid`).value;
                sheetURLs[tab].requests = document.getElementById(`sheet-${tab}-requests`).value;
            });
            localStorage.setItem('sheetURLs', JSON.stringify(sheetURLs));
        }

        function loadSheetURLs() {
            const saved = localStorage.getItem('sheetURLs');
            if (saved) {
                const loaded = JSON.parse(saved);
                ['at', 'at-nyc', 'mbt'].forEach(tab => {
                    if (loaded[tab]) {
                        sheetURLs[tab] = loaded[tab];
                        if (sheetURLs[tab].master) document.getElementById(`sheet-${tab}-master`).value = sheetURLs[tab].master;
                        if (sheetURLs[tab].paid) document.getElementById(`sheet-${tab}-paid`).value = sheetURLs[tab].paid;
                        if (sheetURLs[tab].requests) document.getElementById(`sheet-${tab}-requests`).value = sheetURLs[tab].requests;
                    }
                });
            }
        }

        // ===== CHANGE TRACKING FUNCTIONS =====
        function detectChanges(oldData) {
            const timestamp = new Date().toISOString();
            const changes = [];

            ['at', 'at-nyc', 'mbt'].forEach(tab => {
                const oldRecords = oldData[tab] || [];
                const newRecords = appData[tab].merged;

                // Create maps for faster lookup
                const oldMap = {};
                oldRecords.forEach(row => {
                    const summonsNum = (row['Summons Number'] || '').trim();
                    if (summonsNum) oldMap[summonsNum] = row;
                });

                const newMap = {};
                newRecords.forEach(row => {
                    const summonsNum = (row['Summons Number'] || '').trim();
                    if (summonsNum) newMap[summonsNum] = row;
                });

                // Detect new summonses
                Object.keys(newMap).forEach(summonsNum => {
                    if (!oldMap[summonsNum]) {
                        changes.push({
                            timestamp: timestamp,
                            dataset: tab.toUpperCase(),
                            type: 'new',
                            summonsNumber: summonsNum,
                            companyName: newMap[summonsNum]['Company Name'] || 'Unknown',
                            description: 'New summons added',
                            details: {
                                violationDate: newMap[summonsNum]['Violation Date'],
                                status: newMap[summonsNum]['Status']
                            }
                        });
                    }
                });

                // Detect changes in existing summonses
                Object.keys(oldMap).forEach(summonsNum => {
                    if (newMap[summonsNum]) {
                        const oldRow = oldMap[summonsNum];
                        const newRow = newMap[summonsNum];

                        // Check for Status changes
                        const oldStatus = (oldRow['Status'] || '').trim();
                        const newStatus = (newRow['Status'] || '').trim();
                        if (oldStatus !== newStatus && newStatus) {
                            changes.push({
                                timestamp: timestamp,
                                dataset: tab.toUpperCase(),
                                type: 'status',
                                summonsNumber: summonsNum,
                                companyName: newRow['Company Name'] || 'Unknown',
                                description: 'Status changed',
                                details: {
                                    from: oldStatus || 'None',
                                    to: newStatus
                                }
                            });
                        }

                        // Check for Payment Status changes
                        const oldPaymentStatus = (oldRow['Payment Status'] || '').trim();
                        const newPaymentStatus = (newRow['Payment Status'] || '').trim();
                        if (oldPaymentStatus !== newPaymentStatus) {
                            changes.push({
                                timestamp: timestamp,
                                dataset: tab.toUpperCase(),
                                type: 'status',
                                summonsNumber: summonsNum,
                                companyName: newRow['Company Name'] || 'Unknown',
                                description: 'Payment status changed',
                                details: {
                                    from: oldPaymentStatus || 'Unpaid',
                                    to: newPaymentStatus || 'Unpaid'
                                }
                            });
                        }

                        // Check for Hearing Status changes
                        const oldHearingStatus = (oldRow['Hearing Status'] || '').trim();
                        const newHearingStatus = (newRow['Hearing Status'] || '').trim();
                        if (oldHearingStatus !== newHearingStatus && newHearingStatus) {
                            changes.push({
                                timestamp: timestamp,
                                dataset: tab.toUpperCase(),
                                type: 'status',
                                summonsNumber: summonsNum,
                                companyName: newRow['Company Name'] || 'Unknown',
                                description: 'Hearing status changed',
                                details: {
                                    from: oldHearingStatus || 'None',
                                    to: newHearingStatus
                                }
                            });
                        }

                        // Check for Hearing Result changes
                        const oldHearingResult = (oldRow['Hearing Result'] || '').trim();
                        const newHearingResult = (newRow['Hearing Result'] || '').trim();
                        if (oldHearingResult !== newHearingResult && newHearingResult) {
                            changes.push({
                                timestamp: timestamp,
                                dataset: tab.toUpperCase(),
                                type: 'status',
                                summonsNumber: summonsNum,
                                companyName: newRow['Company Name'] || 'Unknown',
                                description: 'Hearing result changed',
                                details: {
                                    from: oldHearingResult || 'None',
                                    to: newHearingResult
                                }
                            });
                        }

                        // Check for Paid Amount changes
                        const oldPaidAmount = parseFloat((oldRow['Paid Amount'] || '0').replace(/[$,]/g, ''));
                        const newPaidAmount = parseFloat((newRow['Paid Amount'] || '0').replace(/[$,]/g, ''));
                        if (!isNaN(oldPaidAmount) && !isNaN(newPaidAmount) && oldPaidAmount !== newPaidAmount) {
                            changes.push({
                                timestamp: timestamp,
                                dataset: tab.toUpperCase(),
                                type: 'payment',
                                summonsNumber: summonsNum,
                                companyName: newRow['Company Name'] || 'Unknown',
                                description: 'Paid amount changed',
                                details: {
                                    from: `$${oldPaidAmount.toFixed(2)}`,
                                    to: `$${newPaidAmount.toFixed(2)}`,
                                    difference: `${newPaidAmount > oldPaidAmount ? '+' : ''}$${(newPaidAmount - oldPaidAmount).toFixed(2)}`
                                }
                            });
                        }

                        // Check for Balance Due changes
                        const oldBalanceDue = parseFloat((oldRow['Balance Due'] || '0').replace(/[$,]/g, ''));
                        const newBalanceDue = parseFloat((newRow['Balance Due'] || '0').replace(/[$,]/g, ''));
                        if (!isNaN(oldBalanceDue) && !isNaN(newBalanceDue) && oldBalanceDue !== newBalanceDue) {
                            changes.push({
                                timestamp: timestamp,
                                dataset: tab.toUpperCase(),
                                type: 'payment',
                                summonsNumber: summonsNum,
                                companyName: newRow['Company Name'] || 'Unknown',
                                description: 'Balance due changed',
                                details: {
                                    from: `$${oldBalanceDue.toFixed(2)}`,
                                    to: `$${newBalanceDue.toFixed(2)}`,
                                    difference: `${newBalanceDue > oldBalanceDue ? '+' : ''}$${(newBalanceDue - oldBalanceDue).toFixed(2)}`
                                }
                            });
                        }

                        // Check for "Paid To Me" changes
                        const oldPaidToMe = parseFloat((oldRow['Paid To Me'] || '0').replace(/[$,]/g, ''));
                        const newPaidToMe = parseFloat((newRow['Paid To Me'] || '0').replace(/[$,]/g, ''));
                        if (!isNaN(newPaidToMe) && newPaidToMe > 0 && oldPaidToMe !== newPaidToMe) {
                            changes.push({
                                timestamp: timestamp,
                                dataset: tab.toUpperCase(),
                                type: 'payment',
                                summonsNumber: summonsNum,
                                companyName: newRow['Company Name'] || 'Unknown',
                                description: 'Payment received changed',
                                details: {
                                    from: `$${oldPaidToMe.toFixed(2)}`,
                                    to: `$${newPaidToMe.toFixed(2)}`,
                                    difference: `${newPaidToMe > oldPaidToMe ? '+' : ''}$${(newPaidToMe - oldPaidToMe).toFixed(2)}`
                                }
                            });
                        }
                    }
                });
            });

            // If there are 500+ changes, it's probably a data loading issue - skip logging
            if (changes.length >= 500) {
                console.log(`Skipping change tracking: ${changes.length} changes detected (likely data loading issue)`);
                return;
            }

            // Add changes to history
            if (changes.length > 0) {
                changeHistory.push({
                    refreshTime: timestamp,
                    changeCount: changes.length,
                    changes: changes
                });

                // Keep only last 50 refresh sessions
                if (changeHistory.length > 50) {
                    changeHistory = changeHistory.slice(-50);
                }

                saveChangeHistory();
                renderChangesView();
            }
        }

        function renderChangesView() {
            // Update summary cards
            let totalChanges = 0;
            let statusChanges = 0;
            let paymentChanges = 0;
            let newSummonses = 0;

            changeHistory.forEach(session => {
                session.changes.forEach(change => {
                    totalChanges++;
                    if (change.type === 'status') statusChanges++;
                    if (change.type === 'payment') paymentChanges++;
                    if (change.type === 'new') newSummonses++;
                });
            });

            document.getElementById('changes-total').textContent = totalChanges;
            document.getElementById('changes-status').textContent = statusChanges;
            document.getElementById('changes-payment').textContent = paymentChanges;
            document.getElementById('changes-new').textContent = newSummonses;

            // Update last refresh info
            if (changeHistory.length > 0) {
                const lastSession = changeHistory[changeHistory.length - 1];
                const refreshDate = new Date(lastSession.refreshTime);
                document.getElementById('last-refresh-time').textContent = refreshDate.toLocaleString();
                document.getElementById('last-refresh-changes').textContent = lastSession.changeCount;
            }

            // Render timeline
            renderChangesTimeline();
        }

        function renderChangesTimeline() {
            const timeline = document.getElementById('changes-timeline');
            
            if (changeHistory.length === 0) {
                timeline.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No changes tracked yet. Refresh your data to start tracking changes.</p>';
                return;
            }

            let html = '';

            // Filter changes based on current filter
            const filteredHistory = changeHistory.map(session => {
                if (currentChangeFilter === 'all') {
                    return session;
                }
                return {
                    ...session,
                    changes: session.changes.filter(change => change.type === currentChangeFilter)
                };
            }).filter(session => session.changes.length > 0);

            // Reverse to show most recent first
            filteredHistory.reverse().forEach((session, sessionIndex) => {
                const sessionDate = new Date(session.refreshTime);
                const isRecent = sessionIndex === 0;

                // Group changes by summons number and timestamp
                const groupedChanges = {};
                session.changes.forEach(change => {
                    const key = `${change.summonsNumber}_${change.timestamp}`;
                    if (!groupedChanges[key]) {
                        groupedChanges[key] = {
                            summonsNumber: change.summonsNumber,
                            companyName: change.companyName,
                            dataset: change.dataset,
                            timestamp: change.timestamp,
                            changes: []
                        };
                    }
                    groupedChanges[key].changes.push(change);
                });

                html += `
                    <div style="border-left: 3px solid ${isRecent ? '#27ae60' : '#3498db'}; padding-left: 15px; margin-bottom: 25px; position: relative;">
                        <div style="position: absolute; left: -8px; top: 0; width: 13px; height: 13px; border-radius: 50%; background: ${isRecent ? '#27ae60' : '#3498db'}; border: 3px solid white;"></div>
                        <div style="background: ${isRecent ? '#d4edda' : '#e8f4f8'}; padding: 10px; border-radius: 4px; margin-bottom: 12px;">
                            <div style="font-weight: bold; color: #1e3c72; font-size: 0.9em;">
                                📅 ${sessionDate.toLocaleString()}
                            </div>
                            <div style="color: #666; font-size: 0.85em; margin-top: 4px;">
                                ${Object.keys(groupedChanges).length} summons${Object.keys(groupedChanges).length !== 1 ? 'es' : ''} with changes
                            </div>
                        </div>
                `;

                Object.values(groupedChanges).forEach(group => {
                    // Determine the primary type and color
                    const hasNew = group.changes.some(c => c.type === 'new');
                    const hasStatus = group.changes.some(c => c.type === 'status');
                    const hasPayment = group.changes.some(c => c.type === 'payment');
                    
                    const typeIcons = {
                        'new': '✨',
                        'status': '🔄',
                        'payment': '💵'
                    };
                    const typeColors = {
                        'new': '#9b59b6',
                        'status': '#3498db',
                        'payment': '#f39c12'
                    };
                    
                    // Pick primary type/color based on priority
                    let primaryType = 'status';
                    if (hasNew) primaryType = 'new';
                    else if (hasPayment) primaryType = 'payment';
                    
                    const typeIcon = typeIcons[primaryType];
                    const typeColor = typeColors[primaryType];

                    html += `
                        <div style="background: white; padding: 12px; border-radius: 4px; margin-bottom: 8px; border-left: 3px solid ${typeColor}; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="display: flex; gap: 10px; align-items: start;">
                                <div style="font-size: 1.3em; line-height: 1;">${typeIcon}</div>
                                <div style="flex: 1;">
                                    <div style="font-weight: bold; color: #2c3e50; font-size: 0.85em; margin-bottom: 4px;">
                                        ${group.changes.length > 1 ? 'Multiple changes' : group.changes[0].description}
                                    </div>
                                    <div style="font-size: 0.8em; color: #666; margin-bottom: 6px;">
                                        <strong>Summons:</strong> ${group.summonsNumber} | 
                                        <strong>Company:</strong> ${group.companyName} | 
                                        <strong>Dataset:</strong> ${group.dataset}
                                    </div>
                    `;

                    // If multiple changes, show all details
                    if (group.changes.length > 1) {
                        html += '<div style="margin-top: 8px; padding: 8px; background: #f8f9fa; border-radius: 3px; font-size: 0.8em;">';
                        group.changes.forEach((change, idx) => {
                            if (idx > 0) html += '<div style="margin-top: 6px; padding-top: 6px; border-top: 1px solid #dee2e6;"></div>';
                            html += `<div><strong>${change.description}:</strong> `;
                            
                            if (change.details) {
                                if (change.details.from !== undefined && change.details.to !== undefined) {
                                    html += `<span style="color: #e74c3c;">${change.details.from}</span>`;
                                    html += ` → `;
                                    html += `<span style="color: #27ae60; font-weight: bold;">${change.details.to}</span>`;
                                    if (change.details.difference) {
                                        html += ` <span style="color: #666;">(${change.details.difference})</span>`;
                                    }
                                } else if (change.details.violationDate) {
                                    html += `${change.details.violationDate}`;
                                    if (change.details.status) html += ` | Status: ${change.details.status}`;
                                }
                            }
                            html += '</div>';
                        });
                        html += '</div>';
                    } else {
                        // Single change - show details inline
                        const change = group.changes[0];
                        if (change.details) {
                            if (change.details.from !== undefined && change.details.to !== undefined) {
                                html += `
                                    <div style="font-size: 0.8em; padding: 6px; background: #f8f9fa; border-radius: 3px;">
                                        <span style="color: #e74c3c;">${change.details.from}</span>
                                        <span style="margin: 0 6px;">→</span>
                                        <span style="color: #27ae60; font-weight: bold;">${change.details.to}</span>
                                `;
                                if (change.details.difference) {
                                    html += ` <span style="margin-left: 8px; color: #666;">(${change.details.difference})</span>`;
                                }
                                html += `</div>`;
                            } else if (change.details.violationDate) {
                                html += `
                                    <div style="font-size: 0.8em; color: #666;">
                                        <strong>Violation Date:</strong> ${change.details.violationDate}
                                        ${change.details.status ? ` | <strong>Status:</strong> ${change.details.status}` : ''}
                                    </div>
                                `;
                            }
                        }
                    }

                    html += `
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += `</div>`;
            });

            timeline.innerHTML = html;
        }

        function viewAllChanges() {
            currentChangeFilter = 'all';
            renderChangesTimeline();
        }

        function filterChangesByType(type) {
            currentChangeFilter = type;
            renderChangesTimeline();
        }

        function clearChangeHistory() {
            if (!confirm('Are you sure you want to clear all change history? This cannot be undone.')) {
                return;
            }
            changeHistory = [];
            saveChangeHistory();
            renderChangesView();
        }

        function saveChangeHistory() {
            try {
                localStorage.setItem('truckChanges', JSON.stringify(changeHistory));
            } catch (e) {
                console.error('Error saving change history:', e);
            }
        }

        function loadChangeHistory() {
            try {
                const saved = localStorage.getItem('truckChanges');
                if (saved) {
                    changeHistory = JSON.parse(saved);
                    renderChangesView();
                }
            } catch (e) {
                console.error('Error loading change history:', e);
            }
        }

        async function loadAllData(silent = false) {
            if (!silent) updateProgress('at', 0, 'Loading data from Google Sheets...');
            
            // Store snapshot of old data for change detection
            const oldData = {};
            ['at', 'at-nyc', 'mbt'].forEach(tab => {
                oldData[tab] = appData[tab].merged.map(row => ({...row}));
            });
            
            for (const tab of ['at', 'at-nyc', 'mbt']) {
                try {
                    if (sheetURLs[tab].master) {
                        const masterData = await fetchCSVFromSheet(convertToCSVUrl(sheetURLs[tab].master));
                        appData[tab].master = masterData;
                    }
                    if (sheetURLs[tab].paid) {
                        const paidData = await fetchCSVFromSheet(convertToCSVUrl(sheetURLs[tab].paid));
                        appData[tab].paid = paidData;
                    }
                    if (sheetURLs[tab].requests) {
                        const requestsData = await fetchCSVFromSheet(convertToCSVUrl(sheetURLs[tab].requests));
                        appData[tab].requests = requestsData;
                    }

                    appData[tab].lastRefreshSheets = new Date().toISOString();

                    mergeData(tab);
                    await enrichFromNYC(tab, true);
                    applyFilters(tab);
                    populateFilterDropdowns(tab);
                } catch (error) {
                    console.error(`Error loading ${tab}:`, error);
                }
            }

            // Detect and log changes
            detectChanges(oldData);

            saveToStorage();
            if (!silent) {
                updateProgress('at', 100, 'Data loaded successfully!');
                alert('All data loaded from Google Sheets!');
            }
        }

        async function fetchCSVFromSheet(url) {
            const text = await fetchWithCORS(url);
            const parsed = parseCSV(text);
            return parsed;
        }

        function parseCSV(text) {
            const rows = [];
            let currentRow = [];
            let currentCell = '';
            let insideQuotes = false;
            
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const nextChar = text[i + 1];
                
                if (char === '"') {
                    if (insideQuotes && nextChar === '"') {
                        currentCell += '"';
                        i++;
                    } else {
                        insideQuotes = !insideQuotes;
                    }
                } else if (char === ',' && !insideQuotes) {
                    currentRow.push(currentCell.trim());
                    currentCell = '';
                } else if ((char === '\n' || char === '\r') && !insideQuotes) {
                    if (char === '\r' && nextChar === '\n') {
                        i++;
                    }
                    if (currentCell || currentRow.length > 0) {
                        currentRow.push(currentCell.trim());
                        if (currentRow.some(cell => cell.length > 0)) {
                            rows.push(currentRow);
                        }
                        currentRow = [];
                        currentCell = '';
                    }
                } else {
                    currentCell += char;
                }
            }
            
            if (currentCell || currentRow.length > 0) {
                currentRow.push(currentCell.trim());
                if (currentRow.some(cell => cell.length > 0)) {
                    rows.push(currentRow);
                }
            }
            
            if (rows.length === 0) return [];
            
            const headers = rows[0].map(h => h.trim());
            const data = [];
            
            for (let i = 1; i < rows.length; i++) {
                const row = {};
                const values = rows[i];
                
                headers.forEach((header, index) => {
                    row[header] = values[index] ? values[index].trim() : '';
                });
                
                const hasData = Object.values(row).some(val => val.length > 0);
                if (hasData) {
                    data.push(row);
                }
            }
            
            return data;
        }

        function mergeData(tab) {
            const master = appData[tab].master;
            const paid = appData[tab].paid;
            const requests = appData[tab].requests;

            if (master.length === 0) {
                appData[tab].merged = [];
                return;
            }

            const paidMap = {};
            paid.forEach(row => {
                const summonsNum = row['Summons #'] || row['Summons Number'];
                if (summonsNum) paidMap[summonsNum.trim()] = row;
            });

            const requestsMap = {};
            requests.forEach(row => {
                const summonsNum = row['Complaint Number'] || row['Summons Number'];
                if (summonsNum) requestsMap[summonsNum.trim()] = row;
            });

            const merged = master.map(row => {
                const summonsNum = (row['Summons Number'] || '').trim();
                const newRow = { ...row };
                
                // Normalize company name for consistent grouping
                if (newRow['Company Name']) {
                    newRow['Company Name'] = normalizeCompanyName(newRow['Company Name']);
                }

                if (!newRow['Paid Amount']) newRow['Paid Amount'] = '';
                if (!newRow['Hearing Status']) newRow['Hearing Status'] = '';

                // Check if status is "Submitted" - set initially but can be overridden
                const status = (row['Status'] || '').toLowerCase();
                const isSubmitted = status === 'submitted';
                
                if (isSubmitted) {
                    newRow['_rowType'] = 'submitted';
                }

                if (summonsNum && paidMap[summonsNum]) {
                    // Only override submitted if it's not submitted
                    if (!isSubmitted) {
                        newRow['_rowType'] = 'paid';
                    }
                    
                    const paidRow = paidMap[summonsNum];
                    Object.keys(paidRow).forEach(key => {
                        if (key !== 'Summons #' && key !== 'Summons Number') {
                            newRow[key] = paidRow[key];
                        }
                    });
                    
                    newRow['Payment Status'] = 'PAID TO ME';
                } else if (summonsNum && requestsMap[summonsNum]) {
                    // Only override submitted if it's not submitted
                    if (!isSubmitted) {
                        newRow['_rowType'] = 'requested';
                    }
                    
                    Object.keys(requestsMap[summonsNum]).forEach(key => {
                        if (key !== 'Complaint Number' && key !== 'Summons Number') {
                            newRow[key] = requestsMap[summonsNum][key];
                        }
                    });
                    newRow['Payment Status'] = 'REQUESTED';
                }
                
                // Check for dismissed or disqualified status - dismissed takes priority
                const hearingResult = (row['Hearing Result'] || newRow['Hearing Result'] || '').toLowerCase();
                if (hearingResult.includes('dismissed')) {
                    newRow['_rowType'] = 'dismissed';
                } else if (status.includes('disqualified')) {
                    newRow['_rowType'] = 'disqualified';
                }

                return newRow;
            });

            appData[tab].merged = merged;
        }

        async function enrichFromNYC(tab, silent = false) {
            const data = appData[tab].merged;
            if (data.length === 0) return;

            try {
                const summonsNumbers = data.map(row => row['Summons Number']).filter(num => num && num.trim() !== '');
                if (summonsNumbers.length === 0) return;

                const batchSize = 50;
                const enrichedDataMap = {};

                for (let i = 0; i < summonsNumbers.length; i += batchSize) {
                    const batch = summonsNumbers.slice(i, i + batchSize);
                    const ticketNumbers = batch.map(num => `'${num}'`).join(',');
                    const url = `https://data.cityofnewyork.us/resource/jz4z-kudi.json?$where=ticket_number IN (${ticketNumbers})&$limit=1000`;

                    const response = await fetch(url);
                    const nycData = await response.json();

                    nycData.forEach(item => {
                        enrichedDataMap[item.ticket_number] = item;
                    });
                }

                appData[tab].merged = data.map(row => {
                    const summonsNum = (row['Summons Number'] || '').trim();
                    if (summonsNum && enrichedDataMap[summonsNum]) {
                        const nycRow = enrichedDataMap[summonsNum];
                        const enrichedRow = { ...row };
                        
                        Object.keys(nycFieldMapping).forEach(apiField => {
                            const displayName = nycFieldMapping[apiField];
                            if (nycRow[apiField] !== undefined && nycRow[apiField] !== null) {
                                enrichedRow[displayName] = nycRow[apiField];
                            }
                        });

                        // Re-check dismissed/disqualified status after enrichment since Hearing Result may have changed
                        const hearingResult = (enrichedRow['Hearing Result'] || '').toLowerCase();
                        const status = (enrichedRow['Status'] || '').toLowerCase();
                        if (hearingResult.includes('dismissed')) {
                            enrichedRow['_rowType'] = 'dismissed';
                        } else if (status.includes('disqualified')) {
                            enrichedRow['_rowType'] = 'disqualified';
                        }

                        return enrichedRow;
                    }
                    return row;
                });

                appData[tab].lastRefreshNYC = new Date().toISOString();

                saveToStorage();
            } catch (error) {
                console.error('Enrichment error:', error);
            }
        }

        function refreshData(tab) {
            loadAllData();
        }

        function clearData(tab) {
            if (!confirm(`Clear all data for ${tab.toUpperCase()}?`)) return;
            appData[tab] = { master: [], paid: [], requests: [], merged: [], filtered: [], currentPage: 1, pageSize: 'all' };
            saveToStorage();
            applyFilters(tab);
        }

        function populateFilterDropdowns(tab) {
            const data = appData[tab].merged;
            
            const paymentStatuses = new Set();
            const companies = new Set();
            
            data.forEach(row => {
                if (row['Payment Status']) paymentStatuses.add(row['Payment Status']);
                if (row['Company Name']) companies.add(row['Company Name']);
            });

            const paymentSelect = document.getElementById(`${tab}-filter-payment-status`);
            paymentSelect.innerHTML = '<option value="">All Payment Status</option>';
            [...paymentStatuses].sort().forEach(status => {
                paymentSelect.innerHTML += `<option value="${status}">${status}</option>`;
            });

            const companySelect = document.getElementById(`${tab}-filter-company`);
            companySelect.innerHTML = '<option value="">All Companies</option>';
            [...companies].sort().forEach(company => {
                companySelect.innerHTML += `<option value="${company}">${company}</option>`;
            });
        }

        function applyFilters(tab) {
            const data = appData[tab].merged;
            
            const showPaid = document.getElementById(`${tab}-filter-paid`).checked;
            const showRequested = document.getElementById(`${tab}-filter-requested`).checked;
            const showDisqualified = document.getElementById(`${tab}-filter-disqualified`).checked;
            const showUnpaid = document.getElementById(`${tab}-filter-unpaid`).checked;
            
            const paymentStatusFilter = document.getElementById(`${tab}-filter-payment-status`)?.value || '';
            const companyFilter = document.getElementById(`${tab}-filter-company`)?.value || '';
            const searchText = (document.getElementById(`${tab}-filter-search`)?.value || '').toLowerCase();

            const filteredData = data.filter(row => {
                if (row['_rowType'] === 'paid' && !showPaid) return false;
                if (row['_rowType'] === 'requested' && !showRequested) return false;
                if ((row['_rowType'] === 'disqualified' || row['_rowType'] === 'dismissed') && !showDisqualified) return false;
                
                const paymentStatus = (row['Payment Status'] || '').trim();
                if (!showUnpaid && !paymentStatus && row['_rowType'] !== 'submitted') return false;

                if (paymentStatusFilter && row['Payment Status'] !== paymentStatusFilter) return false;
                if (companyFilter && row['Company Name'] !== companyFilter) return false;

                if (searchText) {
                    const rowText = Object.values(row).join(' ').toLowerCase();
                    if (!rowText.includes(searchText)) return false;
                }
                
                return true;
            });

            appData[tab].filtered = filteredData;
            appData[tab].currentPage = 1;
            renderTable(tab);
        }

        function renderTable(tab) {
            const filteredData = appData[tab].filtered;
            const thead = document.getElementById(`${tab}-thead`);
            const tbody = document.getElementById(`${tab}-tbody`);

            if (filteredData.length === 0) {
                thead.innerHTML = '';
                tbody.innerHTML = '<tr><td colspan="100" style="text-align: center;">No data matches filters.</td></tr>';
                updateStatusBar(tab);
                updatePagination(tab);
                return;
            }

            const columns = getColumns(tab);

            thead.innerHTML = '<tr>' + columns.map(col => {
                return `<th onclick="sortTable('${tab}', '${col}')">${col} <span class="sort-indicator">${getSortIndicator(tab, col)}</span></th>`;
            }).join('') + '</tr>';

            const pageSize = appData[tab].pageSize;
            const currentPage = appData[tab].currentPage;
            const start = (currentPage - 1) * pageSize;
            const end = pageSize === 'all' ? filteredData.length : start + pageSize;
            const pageData = filteredData.slice(start, end);

            tbody.innerHTML = pageData.map(row => {
                let rowClass = '';
                if (row['_rowType'] === 'paid') rowClass = 'row-green';
                else if (row['_rowType'] === 'requested') rowClass = 'row-yellow';
                else if (row['_rowType'] === 'dismissed') rowClass = 'row-dismissed'; // Darker red for dismissed
                else if (row['_rowType'] === 'disqualified') rowClass = 'row-red';
                else if (row['_rowType'] === 'submitted') rowClass = 'row-gray';

                return '<tr class="' + rowClass + '">' + columns.map(col => {
                    let value = row[col] || '';
                    value = formatDate(value);
                    return `<td>${value}</td>`;
                }).join('') + '</tr>';
            }).join('');

            updateStatusBar(tab);
            updateTotalsBar(tab, filteredData);
            updatePagination(tab);
        }

        function updatePagination(tab) {
            const filtered = appData[tab].filtered;
            const pageSize = appData[tab].pageSize === 'all' ? filtered.length : appData[tab].pageSize;
            const totalPages = Math.ceil(filtered.length / pageSize);
            const currentPage = appData[tab].currentPage;

            const pageInfo = document.getElementById(`${tab}-page-info`);
            if (pageInfo) {
                pageInfo.textContent = `Page ${currentPage} of ${totalPages} (${filtered.length} total)`;
            }

            const pagination = document.getElementById(`${tab}-pagination`);
            if (!pagination) return;
            
            const prevBtn = pagination.querySelector('button:nth-child(2)');
            const nextBtn = pagination.querySelector('button:nth-child(3)');

            if (prevBtn) prevBtn.disabled = currentPage === 1;
            if (nextBtn) nextBtn.disabled = currentPage === totalPages || totalPages === 0;
        }

        function changePage(tab, direction) {
            appData[tab].currentPage += direction;
            renderTable(tab);
        }

        function changePageSize(tab) {
            const value = document.getElementById(`${tab}-page-size`).value;
            appData[tab].pageSize = value === 'all' ? 'all' : parseInt(value);
            appData[tab].currentPage = 1;
            renderTable(tab);
        }

        function getSortIndicator(tab, column) {
            if (currentSortColumn[tab] === column) {
                return currentSortDirection[tab] === 'asc' ? '▲' : '▼';
            }
            return '⇅';
        }

        function sortTable(tab, column) {
            if (currentSortColumn[tab] === column) {
                currentSortDirection[tab] = currentSortDirection[tab] === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn[tab] = column;
                currentSortDirection[tab] = 'asc';
            }

            const data = appData[tab].filtered;
            data.sort((a, b) => {
                let aVal = a[column] || '';
                let bVal = b[column] || '';

                const aNum = parseFloat(aVal.replace(/[$,]/g, ''));
                const bNum = parseFloat(bVal.replace(/[$,]/g, ''));

                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return currentSortDirection[tab] === 'asc' ? aNum - bNum : bNum - aNum;
                }

                if (currentSortDirection[tab] === 'asc') {
                    return aVal.localeCompare(bVal);
                } else {
                    return bVal.localeCompare(aVal);
                }
            });

            renderTable(tab);
        }

        function updateStatusBar(tab) {
            const data = appData[tab].merged;
            const statusBar = document.getElementById(`${tab}-status`);

            const paidCount = data.filter(row => row['_rowType'] === 'paid').length;
            const requestedCount = data.filter(row => row['_rowType'] === 'requested').length;
            const disqualifiedCount = data.filter(row => row['_rowType'] === 'disqualified' || row['_rowType'] === 'dismissed').length;
            const totalCount = data.length;

            // Data Received: has violation date AND status is not Disqualified or Not Pursued
            const eligibleCount = data.filter(row => {
                const status = (row['Status'] || '').toLowerCase();
                return status !== 'disqualified' && status !== 'not pursued';
            }).length;
            
            const dataReceivedCount = data.filter(row => {
                const hasViolationDate = row['Violation Date'] && row['Violation Date'].trim() !== '';
                const status = (row['Status'] || '').toLowerCase();
                const notDisqualified = status !== 'disqualified' && status !== 'not pursued';
                return hasViolationDate && notDisqualified;
            }).length;
            const dataReceivedPercentage = eligibleCount > 0 ? ((dataReceivedCount / eligibleCount) * 100).toFixed(1) : 0;

            const reviewedCount = data.filter(row => {
                const status = (row['Status'] || '').toLowerCase();
                return status !== 'submitted' && status !== '';
            }).length;

            const nonSubmittedCount = data.filter(row => {
                const status = (row['Status'] || '').toLowerCase();
                return status !== 'submitted' && status !== '';
            }).length;
            const disqualifiedPercentage = nonSubmittedCount > 0 ? ((disqualifiedCount / nonSubmittedCount) * 100).toFixed(1) : 0;
            
            // Calculate reviewed percentage
            const reviewedPercentage = totalCount > 0 ? ((reviewedCount / totalCount) * 100).toFixed(1) : 0;

            // Special handling for AT NYC dataset
            if (tab === 'at-nyc') {
                statusBar.innerHTML = `
                    <div class="status-item">
                        <span class="status-badge badge-total">Total: ${totalCount}</span>
                    </div>
                    <div class="status-item">
                        <span class="status-badge badge-green">Paid: ${paidCount}</span>
                    </div>
                    <div class="status-item">
                        <span class="status-badge badge-yellow">Requested: ${requestedCount}</span>
                    </div>
                    <div class="status-item">
                        <span class="status-badge badge-red">Disq: ${disqualifiedCount} (${disqualifiedPercentage}%)</span>
                    </div>
                    <div class="status-item">
                        <span class="status-badge" style="background: #3498db; color: white;">Data Received: ${dataReceivedCount} (${dataReceivedPercentage}%)</span>
                    </div>
                    <div class="status-item">
                        <span class="status-badge" style="background: #9b59b6; color: white;">Reviewed: ${reviewedCount} (${reviewedPercentage}%)</span>
                    </div>
                `;
            } else {
                statusBar.innerHTML = `
                    <div class="status-item">
                        <span class="status-badge badge-total">Total: ${totalCount}</span>
                    </div>
                    <div class="status-item">
                        <span class="status-badge badge-green">Paid: ${paidCount}</span>
                    </div>
                    <div class="status-item">
                        <span class="status-badge badge-yellow">Requested: ${requestedCount}</span>
                    </div>
                    <div class="status-item">
                        <span class="status-badge badge-red">Disq: ${disqualifiedCount} (${disqualifiedPercentage}%)</span>
                    </div>
                    <div class="status-item">
                        <span class="status-badge" style="background: #3498db; color: white;">Data Received: ${dataReceivedCount} (${dataReceivedPercentage}%)</span>
                    </div>
                `;
            }
            
            // Add refresh timestamps
            const lastSheets = appData[tab].lastRefreshSheets;
            const lastNYC = appData[tab].lastRefreshNYC;
            const formatTimestamp = (isoString) => {
                if (!isoString) return 'Never';
                const date = new Date(isoString);
                return date.toLocaleString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true });
            };
            
            // Insert timestamps into the placeholder div
            const timestampDiv = document.getElementById(`${tab}-timestamps`);
            if (timestampDiv) {
                timestampDiv.innerHTML = `
                    📊 <strong>Last Google Sheets Refresh:</strong> ${formatTimestamp(lastSheets)} &nbsp;
                    🏙️ <strong>Last NYC OpenData Refresh:</strong> ${formatTimestamp(lastNYC)}
                `;
            }
        }

        function updateTotalsBar(tab, filteredData) {
            const totalsBar = document.getElementById(`${tab}-totals`);
            if (!totalsBar) return;

            let totalHtml = `<div class="total-item">Visible: ${filteredData.length}</div>`;

            let totalPaidAmount = 0;
            let totalRequestedAmount = 0;

            filteredData.forEach(row => {
                const paidAmount = parseFloat((row['Paid Amount'] || '').replace(/[$,]/g, ''));
                
                if (row['_rowType'] === 'paid' && !isNaN(paidAmount)) {
                    totalPaidAmount += paidAmount;
                } else if (row['_rowType'] === 'requested' && !isNaN(paidAmount)) {
                    totalRequestedAmount += paidAmount;
                }
            });

            if (totalPaidAmount > 0) {
                const quarterPaid = totalPaidAmount / 4;
                totalHtml += `<div class="total-item">Paid: $${totalPaidAmount.toFixed(2)} ($${quarterPaid.toFixed(2)})</div>`;
            }

            if (totalRequestedAmount > 0) {
                const quarterRequested = totalRequestedAmount / 4;
                totalHtml += `<div class="total-item">Requested: $${totalRequestedAmount.toFixed(2)} ($${quarterRequested.toFixed(2)})</div>`;
            }

            totalsBar.innerHTML = totalHtml;
        }

        function updateProgress(tab, percent, message) {
            const progressContainer = document.getElementById(`${tab}-progress`);
            const progressFill = document.getElementById(`${tab}-progress-fill`);
            const progressStatus = document.getElementById(`${tab}-progress-status`);

            if (!progressContainer) return;

            progressContainer.classList.add('show');
            progressFill.style.width = percent + '%';
            progressFill.textContent = Math.round(percent) + '%';
            progressStatus.textContent = message;

            if (percent >= 100) {
                setTimeout(() => {
                    progressContainer.classList.remove('show');
                }, 1500);
            }
        }

        function renderNewMoney() {
            ['at', 'at-nyc', 'mbt'].forEach(tab => {
                const data = appData[tab].merged;
                const newMoneyData = data.filter(row => {
                    const hearingStatus = (row['Hearing Status'] || '').toLowerCase();
                    const paymentStatus = (row['Payment Status'] || '').trim();
                    return hearingStatus === 'paid in full' && !paymentStatus;
                });

                const thead = document.getElementById(`new-money-${tab}-thead`);
                const tbody = document.getElementById(`new-money-${tab}-tbody`);

                if (newMoneyData.length === 0) {
                    thead.innerHTML = '';
                    tbody.innerHTML = '<tr><td colspan="100" style="text-align: center;">✅ All caught up!</td></tr>';
                    document.getElementById(`new-money-${tab}-totals`).innerHTML = '💰 Total: $0.00';
                    return;
                }

                const columns = Object.keys(newMoneyData[0]).filter(col => !col.startsWith('_'));

                thead.innerHTML = '<tr>' + columns.map(col => `<th>${col}</th>`).join('') + '</tr>';
                tbody.innerHTML = newMoneyData.map(row => {
                    return '<tr>' + columns.map(col => {
                        let value = row[col] || '';
                        value = formatDate(value);
                        return `<td>${value}</td>`;
                    }).join('') + '</tr>';
                }).join('');

                let totalWaitingToCollect = 0;
                newMoneyData.forEach(row => {
                    const amount = parseFloat((row['Paid Amount'] || '').replace(/[$,]/g, ''));
                    if (!isNaN(amount)) {
                        totalWaitingToCollect += amount;
                    }
                });

                const quarterAmount = totalWaitingToCollect / 4;
                document.getElementById(`new-money-${tab}-totals`).innerHTML = `
                    💰 Total: $${totalWaitingToCollect.toFixed(2)} | Your 25%: $${quarterAmount.toFixed(2)} | Count: ${newMoneyData.length}
                `;
            });
        }

        function refreshNewMoney() {
            loadAllData(true);
            setTimeout(renderNewMoney, 2000);
        }

        function generateFunFacts() {
            const container = document.getElementById('fun-facts-container');
            const allData = [];
            
            ['at', 'at-nyc', 'mbt'].forEach(tab => {
                appData[tab].merged.forEach(row => {
                    allData.push({ ...row, _dataset: tab });
                });
            });

            if (allData.length === 0) {
                container.innerHTML = '<p>No data available. Please load data first.</p>';
                return;
            }

            const facts = [];

            // REVENUE & PERFORMANCE INSIGHTS
            
            // 1. Total Potential vs Realized
            let totalPotential = 0;
            let totalCollected = 0;
            allData.forEach(row => {
                const amount = parseFloat((row['Paid Amount'] || '0').replace(/[$,]/g, ''));
                if (!isNaN(amount) && amount > 0) {
                    totalPotential += amount;
                    // Count paid as full amount, requested as 25%
                    if (row['_rowType'] === 'paid') {
                        totalCollected += amount;
                    } else if (row['_rowType'] === 'requested') {
                        totalCollected += amount * 0.25;
                    }
                }
            });
            const yourPotential = totalPotential * 0.25;
            const yourCollected = totalCollected * 0.25;
            const uncollected = yourPotential - yourCollected;
            facts.push({
                title: '💰 Total Earnings Potential',
                description: `You've collected/requested $${yourCollected.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} out of a potential $${yourPotential.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} - that's $${uncollected.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} still outstanding!`
            });

            // 2. Success Rate
            const paidAndRequestedCount = allData.filter(row => row['_rowType'] === 'paid' || row['_rowType'] === 'requested').length;
            const successRate = ((paidAndRequestedCount / allData.length) * 100).toFixed(1);
            facts.push({
                title: '📈 Overall Success Rate',
                description: `${successRate}% success rate - ${paidAndRequestedCount} out of ${allData.length.toLocaleString()} summonses resulted in payment or request`
            });

            // 3. Average Payout
            const avgPayout = paidAndRequestedCount > 0 ? yourCollected / paidAndRequestedCount : 0;
            facts.push({
                title: '💵 Average Payout Per Case',
                description: `Each successful summons nets you an average of $${avgPayout.toFixed(2)}`
            });

            // 4. Biggest Single Win
            let biggestWin = 0;
            let biggestWinCompany = '';
            allData.filter(row => row['_rowType'] === 'paid').forEach(row => {
                const amount = parseFloat((row['Paid Amount'] || '0').replace(/[$,]/g, ''));
                if (!isNaN(amount) && amount > biggestWin) {
                    biggestWin = amount;
                    biggestWinCompany = row['Company Name'] || 'Unknown';
                }
            });
            if (biggestWin > 0) {
                const yourCut = biggestWin * 0.25;
                facts.push({
                    title: '🏆 Biggest Single Win',
                    description: `Your largest payday was $${yourCut.toFixed(2)} from ${biggestWinCompany} (NYC paid $${biggestWin.toFixed(2)})`
                });
            }

            // 5. Money Still in Pipeline (show 25% expected from requested amounts)
            const requestedCount = allData.filter(row => row['_rowType'] === 'requested').length;
            let requestedAmount = 0;
            allData.filter(row => row['_rowType'] === 'requested').forEach(row => {
                const amount = parseFloat((row['Paid Amount'] || '0').replace(/[$,]/g, ''));
                if (!isNaN(amount)) requestedAmount += amount;
            });
            const yourRequestedShare = requestedAmount * 0.25 * 0.25; // 25% of amount, expecting 25% payment rate
            if (requestedCount > 0) {
                facts.push({
                    title: '⏳ Money in Pipeline',
                    description: `You have ${requestedCount} payment requests pending worth approximately $${yourRequestedShare.toFixed(2)} to you (assuming 25% payment rate)`
                });
            }

            // 6. Disqualification Rate (include dismissed)
            const disqualifiedCount = allData.filter(row => row['_rowType'] === 'disqualified' || row['_rowType'] === 'dismissed').length;
            const disqualificationRate = ((disqualifiedCount / allData.length) * 100).toFixed(1);
            facts.push({
                title: '❌ Disqualification Rate',
                description: `${disqualificationRate}% of cases were disqualified (${disqualifiedCount} total) - room for improvement here!`
            });

            // 7. Win/Loss Ratio
            const paidCount = allData.filter(row => row['_rowType'] === 'paid').length;
            const winLossRatio = disqualifiedCount > 0 ? (paidCount / disqualifiedCount).toFixed(2) : 'Infinity';
            facts.push({
                title: '⚖️ Win/Loss Ratio',
                description: `You win ${winLossRatio} cases for every one you lose - ${winLossRatio > 2 ? 'excellent!' : winLossRatio > 1 ? 'good!' : 'needs work'}`
            });

            // 8. Collection Speed
            const daysToPayment = [];
            allData.filter(row => row['_rowType'] === 'paid').forEach(row => {
                const violationDate = new Date(row['Violation Date']);
                const paymentDate = new Date(row['Payment Received'] || row['Hearing Date']);
                if (!isNaN(violationDate.getTime()) && !isNaN(paymentDate.getTime())) {
                    const days = Math.floor((paymentDate - violationDate) / (1000 * 60 * 60 * 24));
                    if (days >= 0 && days < 1000) daysToPayment.push(days);
                }
            });
            if (daysToPayment.length > 0) {
                const avgDays = Math.round(daysToPayment.reduce((a, b) => a + b, 0) / daysToPayment.length);
                const fastestDays = Math.min(...daysToPayment);
                const slowestDays = Math.max(...daysToPayment);
                facts.push({
                    title: '⏱️ Collection Speed',
                    description: `Average time to payment: ${avgDays} days (fastest: ${fastestDays} days, slowest: ${slowestDays} days)`
                });
            }

            // 9. Conversion Rate
            const totalWithOutcome = paidCount + disqualifiedCount;
            const conversionRate = totalWithOutcome > 0 ? ((paidCount / totalWithOutcome) * 100).toFixed(1) : 0;
            facts.push({
                title: '🎯 Conversion Rate',
                description: `${conversionRate}% of decided cases result in payment - that means ${conversionRate}% of your work pays off!`
            });

            // STRATEGIC COMPANY INSIGHTS

            // 10. Repeat Offenders - Your Biggest Customer
            const companyCounts = {};
            const companyRevenue = {};
            allData.forEach(row => {
                const company = normalizeCompanyName(row['Company Name'] || 'Unknown');
                companyCounts[company] = (companyCounts[company] || 0) + 1;
                if (row['_rowType'] === 'paid') {
                    const amount = parseFloat((row['Paid Amount'] || '0').replace(/[$,]/g, ''));
                    if (!isNaN(amount)) {
                        companyRevenue[company] = (companyRevenue[company] || 0) + amount;
                    }
                }
            });
            const topCompany = Object.keys(companyCounts).reduce((a, b) => companyCounts[a] > companyCounts[b] ? a : b);
            const topCompanyYourShare = (companyRevenue[topCompany] || 0) * 0.25;
            facts.push({
                title: '🚚 Your Biggest Customer',
                description: `${topCompany} has ${companyCounts[topCompany]} violations worth $${topCompanyYourShare.toFixed(2)} to you - your golden goose!`
            });

            // 11. Best Payers
            const companyPaymentRate = {};
            Object.keys(companyCounts).forEach(company => {
                const companyData = allData.filter(row => normalizeCompanyName(row['Company Name']) === company);
                const companyPaid = companyData.filter(row => row['_rowType'] === 'paid').length;
                companyPaymentRate[company] = {
                    rate: (companyPaid / companyData.length) * 100,
                    count: companyData.length,
                    paidCount: companyPaid,
                    avgDays: 0
                };
                // Calculate avg days for this company
                const companyDays = [];
                companyData.filter(row => row['_rowType'] === 'paid').forEach(row => {
                    const violationDate = new Date(row['Violation Date']);
                    const paymentDate = new Date(row['Payment Received'] || row['Hearing Date']);
                    if (!isNaN(violationDate.getTime()) && !isNaN(paymentDate.getTime())) {
                        const days = Math.floor((paymentDate - violationDate) / (1000 * 60 * 60 * 24));
                        if (days >= 0 && days < 1000) companyDays.push(days);
                    }
                });
                if (companyDays.length > 0) {
                    companyPaymentRate[company].avgDays = Math.round(companyDays.reduce((a, b) => a + b, 0) / companyDays.length);
                }
            });
            const bestPayers = Object.keys(companyPaymentRate)
                .filter(company => companyCounts[company] >= 3 && companyPaymentRate[company].rate >= 80)
                .sort((a, b) => companyPaymentRate[b].rate - companyPaymentRate[a].rate);
            if (bestPayers.length > 0) {
                const bestPayer = bestPayers[0];
                const rate = companyPaymentRate[bestPayer].rate.toFixed(0);
                const avgDays = companyPaymentRate[bestPayer].avgDays;
                facts.push({
                    title: '⭐ Most Reliable Payer',
                    description: `${bestPayer} pays ${rate}% of the time${avgDays > 0 ? ` and averages ${avgDays} days to payment` : ''} - a dream client!`
                });
            }

            // 12. Worst Performers
            const worstPayers = Object.keys(companyPaymentRate)
                .filter(company => companyCounts[company] >= 3 && companyPaymentRate[company].rate < 30)
                .sort((a, b) => companyPaymentRate[a].rate - companyPaymentRate[b].rate);
            if (worstPayers.length > 0) {
                const worstPayer = worstPayers[0];
                const rate = companyPaymentRate[worstPayer].rate.toFixed(0);
                facts.push({
                    title: '⚠️ Problem Company',
                    description: `${worstPayer} only pays ${rate}% of the time - maybe not worth pursuing`
                });
            }

            // 13. High-Value Targets
            const unpaidCases = allData.filter(row => !row['_rowType'] || row['_rowType'] === 'submitted');
            let unpaidPotential = 0;
            unpaidCases.forEach(row => {
                const amount = parseFloat((row['Paid Amount'] || '0').replace(/[$,]/g, ''));
                if (!isNaN(amount)) unpaidPotential += amount;
            });
            const yourUnpaidPotential = unpaidPotential * 0.25;
            if (unpaidCases.length > 0) {
                facts.push({
                    title: '🎯 High-Value Targets',
                    description: `You have ${unpaidCases.length} unpaid violations worth $${yourUnpaidPotential.toFixed(2)} to you - time to chase these down!`
                });
            }

            // GEOGRAPHIC & TIMING PATTERNS

            // 14. Best Borough
            const boroughStats = {};
            allData.forEach(row => {
                const borough = row['Violation Location (Borough)'] || 'Unknown';
                if (!boroughStats[borough]) {
                    boroughStats[borough] = { total: 0, paid: 0 };
                }
                boroughStats[borough].total++;
                if (row['_rowType'] === 'paid') boroughStats[borough].paid++;
                else if (row['_rowType'] === 'requested') boroughStats[borough].paid += 0.25;
            });
            let bestBorough = null;
            let bestBoroughRate = 0;
            Object.keys(boroughStats).forEach(borough => {
                if (boroughStats[borough].total >= 5) {
                    const rate = (boroughStats[borough].paid / boroughStats[borough].total) * 100;
                    if (rate > bestBoroughRate) {
                        bestBoroughRate = rate;
                        bestBorough = borough;
                    }
                }
            });
            if (bestBorough && bestBorough !== 'Unknown') {
                facts.push({
                    title: '🗺️ Best Borough',
                    description: `${bestBorough} violations are ${bestBoroughRate.toFixed(0)}% more likely to pay than other boroughs - focus your efforts here!`
                });
            }

            // 15. Seasonal Patterns
            const monthCounts = {};
            allData.forEach(row => {
                const date = new Date(row['Violation Date']);
                if (!isNaN(date.getTime())) {
                    const month = date.getMonth();
                    monthCounts[month] = (monthCounts[month] || 0) + 1;
                }
            });
            if (Object.keys(monthCounts).length > 0) {
                const busiestMonth = Object.keys(monthCounts).reduce((a, b) => monthCounts[a] > monthCounts[b] ? a : b);
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                const avgMonthCount = Object.values(monthCounts).reduce((a, b) => a + b, 0) / Object.keys(monthCounts).length;
                const increasePercent = ((monthCounts[busiestMonth] / avgMonthCount - 1) * 100).toFixed(0);
                facts.push({
                    title: '📅 Peak Season',
                    description: `${monthNames[busiestMonth]} is your busiest month with ${increasePercent}% more violations than average - probably due to cold weather idling!`
                });
            }

            // 16. Day of Week Success
            const dowStats = {};
            allData.forEach(row => {
                const date = new Date(row['Violation Date']);
                if (!isNaN(date.getTime())) {
                    const dow = date.getDay();
                    if (!dowStats[dow]) dowStats[dow] = { total: 0, paid: 0 };
                    dowStats[dow].total++;
                    if (row['_rowType'] === 'paid') dowStats[dow].paid++;
                    else if (row['_rowType'] === 'requested') dowStats[dow].paid += 0.25;
                }
            });
            let bestDOW = null;
            let bestDOWRate = 0;
            Object.keys(dowStats).forEach(dow => {
                if (dowStats[dow].total >= 10) {
                    const rate = (dowStats[dow].paid / dowStats[dow].total) * 100;
                    if (rate > bestDOWRate) {
                        bestDOWRate = rate;
                        bestDOW = dow;
                    }
                }
            });
            if (bestDOW !== null) {
                const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                facts.push({
                    title: '📆 Lucky Day',
                    description: `Violations on ${dayNames[bestDOW]} have the highest success rate at ${bestDOWRate.toFixed(0)}% - your lucky day!`
                });
            }

            // 17. Hot Zone
            const locationCounts = {};
            allData.forEach(row => {
                const street = row['Violation Location (Street Name)'] || row['Place of Occurrence'] || 'Unknown';
                if (street && street !== 'Unknown') {
                    locationCounts[street] = (locationCounts[street] || 0) + 1;
                }
            });
            if (Object.keys(locationCounts).length > 0) {
                const hotZone = Object.keys(locationCounts).reduce((a, b) => locationCounts[a] > locationCounts[b] ? a : b);
                if (locationCounts[hotZone] >= 5) {
                    facts.push({
                        title: '🔥 Hot Zone',
                        description: `${hotZone} has the most violations (${locationCounts[hotZone]} total) - your prime hunting ground!`
                    });
                }
            }

            // ACTIONABLE INSIGHTS

            // 18. Quick Wins
            const unpaidUnder500 = allData.filter(row => {
                if (row['_rowType'] === 'paid' || row['_rowType'] === 'disqualified' || row['_rowType'] === 'dismissed') return false;
                const amount = parseFloat((row['Paid Amount'] || '0').replace(/[$,]/g, ''));
                return !isNaN(amount) && amount > 0 && amount < 500;
            });
            if (unpaidUnder500.length > 0) {
                let quickWinValue = 0;
                unpaidUnder500.forEach(row => {
                    const amount = parseFloat((row['Paid Amount'] || '0').replace(/[$,]/g, ''));
                    if (!isNaN(amount)) quickWinValue += amount;
                });
                const yourQuickWins = quickWinValue * 0.25;
                facts.push({
                    title: '💡 Quick Wins Available',
                    description: `You have ${unpaidUnder500.length} violations under $500 still unpaid - easy money worth $${yourQuickWins.toFixed(2)} to you!`
                });
            }

            // 19. Old Cases Needing Attention
            const oldUnpaid = allData.filter(row => {
                if (row['_rowType'] === 'paid' || row['_rowType'] === 'disqualified' || row['_rowType'] === 'dismissed') return false;
                const violationDate = new Date(row['Violation Date']);
                const sixMonthsAgo = new Date();
                sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
                return !isNaN(violationDate.getTime()) && violationDate < sixMonthsAgo;
            });
            if (oldUnpaid.length > 0) {
                facts.push({
                    title: '⏰ Old Cases Alert',
                    description: `${oldUnpaid.length} cases are over 6 months old with no activity - time to close or push these!`
                });
            }

            // 20. Recent Activity
            const oneMonthAgo = new Date();
            oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
            const recentViolations = allData.filter(row => {
                const date = new Date(row['Violation Date']);
                return !isNaN(date.getTime()) && date > oneMonthAgo;
            });
            if (recentViolations.length > 0) {
                // Compare to previous month
                const twoMonthsAgo = new Date();
                twoMonthsAgo.setMonth(twoMonthsAgo.getMonth() - 2);
                const previousMonthViolations = allData.filter(row => {
                    const date = new Date(row['Violation Date']);
                    return !isNaN(date.getTime()) && date > twoMonthsAgo && date <= oneMonthAgo;
                });
                const change = previousMonthViolations.length > 0 
                    ? ((recentViolations.length / previousMonthViolations.length - 1) * 100).toFixed(0)
                    : 0;
                const direction = change > 0 ? 'up' : change < 0 ? 'down' : 'same';
                facts.push({
                    title: '📊 Recent Activity Trend',
                    description: `You've had ${recentViolations.length} new violations this month - ${direction === 'same' ? 'holding steady' : direction === 'up' ? `up ${Math.abs(change)}% from last month!` : `down ${Math.abs(change)}% from last month`}`
                });
            }

            // 21. Payment Velocity by Quarter
            const q1Data = allData.filter(row => {
                const date = new Date(row['Date Submitted']);
                return !isNaN(date.getTime()) && date.getMonth() < 3;
            });
            const q1Paid = q1Data.filter(row => row['_rowType'] === 'paid').length;
            const q4Data = allData.filter(row => {
                const date = new Date(row['Date Submitted']);
                return !isNaN(date.getTime()) && date.getMonth() >= 9;
            });
            const q4Paid = q4Data.filter(row => row['_rowType'] === 'paid').length;
            if (q1Data.length >= 10 && q4Data.length >= 10) {
                const q1Rate = (q1Paid / q1Data.length * 100).toFixed(0);
                const q4Rate = (q4Paid / q4Data.length * 100).toFixed(0);
                const better = q1Rate > q4Rate ? 'Q1' : 'Q4';
                facts.push({
                    title: '📈 Best Quarter',
                    description: `Violations submitted in ${better} are more likely to pay (${better === 'Q1' ? q1Rate : q4Rate}% vs ${better === 'Q1' ? q4Rate : q1Rate}%)`
                });
            }

            // INTERESTING PATTERNS

            // 22. Busiest Time of Day
            const hourCounts = {};
            allData.forEach(row => {
                const time = row['Violation Time'];
                if (time) {
                    const hour = parseInt(time.split(':')[0]);
                    if (!isNaN(hour)) {
                        hourCounts[hour] = (hourCounts[hour] || 0) + 1;
                    }
                }
            });
            if (Object.keys(hourCounts).length > 0) {
                const busiestHour = Object.keys(hourCounts).reduce((a, b) => hourCounts[a] > hourCounts[b] ? a : b);
                const period = busiestHour < 12 ? 'AM' : 'PM';
                const hour12 = busiestHour > 12 ? busiestHour - 12 : busiestHour === 0 ? 12 : busiestHour;
                facts.push({
                    title: '⏰ Peak Idling Hours',
                    description: `Most violations happen around ${hour12}${period} - prime time for truck idling!`
                });
            }

            // 23. Company Size Analysis
            const smallCompanies = Object.keys(companyCounts).filter(c => companyCounts[c] <= 3);
            const largeCompanies = Object.keys(companyCounts).filter(c => companyCounts[c] > 10);
            if (smallCompanies.length > 0 && largeCompanies.length > 0) {
                const smallCompanyData = allData.filter(row => smallCompanies.includes(row['Company Name']));
                const largeCompanyData = allData.filter(row => largeCompanies.includes(row['Company Name']));
                const smallPaidRate = (smallCompanyData.filter(r => r['_rowType'] === 'paid').length / smallCompanyData.length * 100).toFixed(0);
                const largePaidRate = (largeCompanyData.filter(r => r['_rowType'] === 'paid').length / largeCompanyData.length * 100).toFixed(0);
                const better = smallPaidRate > largePaidRate ? 'Small' : 'Large';
                facts.push({
                    title: '🏢 Company Size Pattern',
                    description: `${better} companies pay more reliably (${better === 'Small' ? smallPaidRate : largePaidRate}% vs ${better === 'Small' ? largePaidRate : smallPaidRate}%)`
                });
            }

            // 24. Hearing Success Rate
            const hearingCases = allData.filter(row => row['Hearing Result'] && row['Hearing Result'].trim() !== '');
            const hearingPaid = hearingCases.filter(row => row['_rowType'] === 'paid').length;
            const noHearingCases = allData.filter(row => !row['Hearing Result'] || row['Hearing Result'].trim() === '');
            const noHearingPaid = noHearingCases.filter(row => row['_rowType'] === 'paid').length;
            if (hearingCases.length >= 10 && noHearingCases.length >= 10) {
                const hearingRate = (hearingPaid / hearingCases.length * 100).toFixed(0);
                const noHearingRate = (noHearingPaid / noHearingCases.length * 100).toFixed(0);
                const better = hearingRate > noHearingRate ? 'with hearings' : 'without hearings';
                facts.push({
                    title: '⚖️ Hearing Impact',
                    description: `Cases ${better} have a ${better === 'with hearings' ? hearingRate : noHearingRate}% success rate vs ${better === 'with hearings' ? noHearingRate : hearingRate}% - ${better === 'with hearings' ? 'fighting helps!' : 'settle early works better!'}`
                });
            }

            // 25. Chronic Offenders
            const chronicOffenders = Object.keys(companyCounts).filter(c => companyCounts[c] >= 5);
            if (chronicOffenders.length > 0) {
                const totalFromChronic = chronicOffenders.reduce((sum, company) => sum + companyCounts[company], 0);
                const percentOfTotal = (totalFromChronic / allData.length * 100).toFixed(0);
                facts.push({
                    title: '🔁 Repeat Offenders',
                    description: `${chronicOffenders.length} companies have 5+ violations - they represent ${percentOfTotal}% of your cases. They clearly aren't learning!`
                });
            }

            // 26. Collection Improvement
            const dates = allData.map(row => new Date(row['Violation Date'])).filter(d => !isNaN(d.getTime())).sort((a, b) => a - b);
            if (dates.length > 50) {
                const midpoint = Math.floor(dates.length / 2);
                const midDate = dates[midpoint];
                const oldData = allData.filter(row => {
                    const d = new Date(row['Violation Date']);
                    return !isNaN(d.getTime()) && d < midDate;
                });
                const newData = allData.filter(row => {
                    const d = new Date(row['Violation Date']);
                    return !isNaN(d.getTime()) && d >= midDate;
                });
                const oldRate = (oldData.filter(r => r['_rowType'] === 'paid').length / oldData.length * 100).toFixed(1);
                const newRate = (newData.filter(r => r['_rowType'] === 'paid').length / newData.length * 100).toFixed(1);
                const change = (newRate - oldRate).toFixed(1);
                if (Math.abs(change) > 1) {
                    facts.push({
                        title: '📊 Performance Trend',
                        description: `Your collection rate has ${change > 0 ? 'improved' : 'decreased'} ${Math.abs(change)}% over time - ${change > 0 ? 'keep it up!' : 'time to revisit your strategy'}`
                    });
                }
            }

            // 27. Revenue Concentration Analysis
            const revenueByCompany = {};
            allData.filter(row => row['_rowType'] === 'paid').forEach(row => {
                const company = normalizeCompanyName(row['Company Name'] || 'Unknown');
                const amount = parseFloat((row['Paid Amount'] || '0').replace(/[$,]/g, ''));
                if (!isNaN(amount)) {
                    revenueByCompany[company] = (revenueByCompany[company] || 0) + amount;
                }
            });
            
            const totalPaidRevenue = Object.values(revenueByCompany).reduce((a, b) => a + b, 0);
            const sortedCompanies = Object.entries(revenueByCompany).sort((a, b) => b[1] - a[1]);
            
            if (sortedCompanies.length >= 3) {
                const top3Revenue = sortedCompanies.slice(0, 3).reduce((sum, [_, amt]) => sum + amt, 0);
                const top3Percent = (top3Revenue / totalPaidRevenue * 100).toFixed(0);
                const yourTop3 = top3Revenue * 0.25;
                
                facts.push({
                    title: '🎯 Revenue Concentration',
                    description: `Your top 3 companies (${sortedCompanies[0][0]}, ${sortedCompanies[1][0]}, ${sortedCompanies[2][0]}) account for ${top3Percent}% of revenue ($${yourTop3.toFixed(2)}) - ${top3Percent > 50 ? 'high concentration risk!' : 'good diversification!'}`
                });
            }

            // Render all facts
            container.innerHTML = facts.map(fact => `
                <div style="background: white; padding: 15px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <h4 style="color: #1e3c72; margin-bottom: 10px; font-size: 1em;">${fact.title}</h4>
                    <p style="color: #2c3e50; line-height: 1.5; font-size: 0.9em;">${fact.description}</p>
                </div>
            `).join('');
        }

        // ===== ADVANCED INSIGHTS FUNCTIONS =====
        
        // Get filtered data for insights based on selected checkboxes
        function getFilteredInsightsData() {
            const cutoffDate = new Date('2024-10-01');
            const includeATBefore = document.getElementById('insights-filter-at-before').checked;
            const includeATAfter = document.getElementById('insights-filter-at-after').checked;
            const includeMBT = document.getElementById('insights-filter-mbt').checked;
            const includeATNYC = document.getElementById('insights-filter-at-nyc').checked;
            
            const filteredData = [];
            
            // AT dataset - split by date
            if (includeATBefore || includeATAfter) {
                appData['at'].merged.forEach(row => {
                    const violationDate = new Date(row['Violation Date']);
                    if (!isNaN(violationDate.getTime())) {
                        if (includeATBefore && violationDate < cutoffDate) {
                            filteredData.push({ ...row, _dataset: 'at', _period: 'before' });
                        } else if (includeATAfter && violationDate >= cutoffDate) {
                            filteredData.push({ ...row, _dataset: 'at', _period: 'after' });
                        }
                    } else {
                        // If no valid date, include based on checkbox settings
                        if (includeATBefore) {
                            filteredData.push({ ...row, _dataset: 'at', _period: 'unknown' });
                        }
                    }
                });
            }
            
            // MBT dataset
            if (includeMBT) {
                appData['mbt'].merged.forEach(row => {
                    filteredData.push({ ...row, _dataset: 'mbt' });
                });
            }
            
            // AT NYC dataset
            if (includeATNYC) {
                appData['at-nyc'].merged.forEach(row => {
                    filteredData.push({ ...row, _dataset: 'at-nyc' });
                });
            }
            
            return filteredData;
        }
        
        // Update the dataset info display
        function updateInsightsDatasetInfo() {
            const data = getFilteredInsightsData();
            const infoDiv = document.getElementById('insights-dataset-info');
            
            if (data.length === 0) {
                infoDiv.innerHTML = '<strong style="color: #e74c3c;">⚠️ No datasets selected! Please select at least one dataset to analyze.</strong>';
                return;
            }
            
            // Count by dataset
            const counts = {
                'at-before': 0,
                'at-after': 0,
                'mbt': 0,
                'at-nyc': 0
            };
            
            data.forEach(row => {
                if (row._dataset === 'at') {
                    if (row._period === 'before') counts['at-before']++;
                    else if (row._period === 'after') counts['at-after']++;
                } else if (row._dataset === 'mbt') {
                    counts['mbt']++;
                } else if (row._dataset === 'at-nyc') {
                    counts['at-nyc']++;
                }
            });
            
            let html = '<strong>📊 Analyzing: </strong>';
            const parts = [];
            if (counts['at-before'] > 0) parts.push(`AT Before 10/1/24 (${counts['at-before'].toLocaleString()})`);
            if (counts['at-after'] > 0) parts.push(`AT After 10/1/24 (${counts['at-after'].toLocaleString()})`);
            if (counts['mbt'] > 0) parts.push(`MBT (${counts['mbt'].toLocaleString()})`);
            if (counts['at-nyc'] > 0) parts.push(`AT NYC (${counts['at-nyc'].toLocaleString()})`);
            
            html += parts.join(' | ');
            html += ` <strong style="color: #667eea;">Total: ${data.length.toLocaleString()} records</strong>`;
            
            infoDiv.innerHTML = html;
        }
        
        function generateAllInsights() {
            const data = getFilteredInsightsData();
            
            if (data.length === 0) {
                alert('Please select at least one dataset to analyze!');
                return;
            }
            
            generatePaymentPredictor();
            generateCompanyIntelligence();
            generateCollectionOptimizer();
            generateCashFlowForecast();
            generateDisqualificationDetective();
            generateGeographicHeatMap();
            generateSmartAlerts();
            generateSeasonalPlanner();
            generateBehaviorChangeDetector();
            generateROIMetrics();
            generateConEdInsight();
        }
        
        function exportInsightsReport() {
            alert('Exporting comprehensive insights report... (Feature coming soon!)');
        }

        // 1. Top Priority Cases to Chase Now
        function generatePaymentPredictor() {
            const container = document.getElementById('insight-payment-predictor');
            const allData = getFilteredInsightsData();

            // Find unpaid cases
            const unpaidCases = allData.filter(row => {
                if (row['_rowType'] === 'requested' || row['_rowType'] === 'paid' || 
                    row['_rowType'] === 'disqualified' || row['_rowType'] === 'dismissed') {
                    return false;
                }
                const amount = parseFloat((row['Paid Amount'] || '0').replace(/[$,]/g, ''));
                return !isNaN(amount) && amount > 0;
            });

            // Calculate company payment history
            const companyStats = {};
            allData.forEach(row => {
                const company = row['Company Name'] || 'Unknown';
                if (!companyStats[company]) {
                    companyStats[company] = { total: 0, paid: 0 };
                }
                companyStats[company].total++;
                if (row['_rowType'] === 'paid') companyStats[company].paid++;
                else if (row['_rowType'] === 'requested') companyStats[company].paid += 0.25;
            });

            // Score each case for priority
            const priorityCases = unpaidCases.map(row => {
                let priorityScore = 0;
                const company = row['Company Name'] || 'Unknown';
                const amount = parseFloat((row['Paid Amount'] || '0').replace(/[$,]/g, ''));
                const yourCut = amount * 0.25;
                
                // High value = higher priority (0-30 points)
                if (yourCut > 100) priorityScore += 30;
                else if (yourCut > 50) priorityScore += 20;
                else if (yourCut > 25) priorityScore += 10;
                
                // Good company history = higher priority (0-40 points)
                if (companyStats[company] && companyStats[company].total >= 2) {
                    const payRate = companyStats[company].paid / companyStats[company].total;
                    priorityScore += payRate * 40;
                }
                
                // Recent violations = higher priority (0-20 points)
                const violationDate = new Date(row['Violation Date']);
                if (!isNaN(violationDate.getTime())) {
                    const daysOld = (new Date() - violationDate) / (1000 * 60 * 60 * 24);
                    if (daysOld < 90) priorityScore += 20;
                    else if (daysOld < 180) priorityScore += 10;
                }
                
                // Has hearing date soon = urgent (0-10 points)
                const hearingDate = new Date(row['Hearing Date']);
                if (!isNaN(hearingDate.getTime())) {
                    const daysUntil = (hearingDate - new Date()) / (1000 * 60 * 60 * 24);
                    if (daysUntil > 0 && daysUntil < 30) priorityScore += 10;
                }
                
                return {
                    ...row,
                    priorityScore: Math.round(priorityScore),
                    yourCut: yourCut
                };
            });

            priorityCases.sort((a, b) => b.priorityScore - a.priorityScore);

            let html = '<div style="margin-bottom: 15px; padding: 12px; background: #f0f4ff; border-radius: 6px; border-left: 4px solid #667eea;">';
            html += `<strong>🎯 Action Items:</strong> ${priorityCases.length} unpaid cases analyzed - focus on these top 15 for maximum ROI`;
            html += '</div>';

            html += '<div style="overflow-x: auto;"><table style="width: 100%; font-size: 0.85em; border-collapse: collapse;">';
            html += '<thead><tr style="background: #667eea; color: white;">';
            html += '<th style="padding: 8px; text-align: left;">Priority</th>';
            html += '<th style="padding: 8px; text-align: left;">Company</th>';
            html += '<th style="padding: 8px; text-align: left;">Summons</th>';
            html += '<th style="padding: 8px; text-align: right;">Your Cut</th>';
            html += '<th style="padding: 8px; text-align: left;">Action</th>';
            html += '</tr></thead><tbody>';

            priorityCases.slice(0, 15).forEach((row, i) => {
                const bgColor = i % 2 === 0 ? '#f8f9fa' : 'white';
                const priorityColor = row.priorityScore >= 70 ? '#27ae60' : row.priorityScore >= 40 ? '#f39c12' : '#e74c3c';
                
                let action = '';
                if (row.priorityScore >= 70) action = '✅ Chase Now';
                else if (row.priorityScore >= 40) action = '⚠️ Follow Up';
                else action = '📋 Monitor';
                
                html += `<tr style="background: ${bgColor};">`;
                html += `<td style="padding: 8px;"><span style="background: ${priorityColor}; color: white; padding: 4px 8px; border-radius: 4px; font-weight: bold;">${row.priorityScore}</span></td>`;
                html += `<td style="padding: 8px;">${(row['Company Name'] || 'Unknown').substring(0, 30)}</td>`;
                html += `<td style="padding: 8px; font-family: monospace;">${row['Summons Number'] || 'N/A'}</td>`;
                html += `<td style="padding: 8px; text-align: right; font-weight: bold; color: #27ae60;">$${row.yourCut.toFixed(2)}</td>`;
                html += `<td style="padding: 8px;">${action}</td>`;
                html += '</tr>';
            });

            html += '</tbody></table></div>';

            // Add summary stats
            const topTenValue = priorityCases.slice(0, 10).reduce((sum, row) => sum + row.yourCut, 0);
            html += '<div style="margin-top: 15px; padding: 15px; background: #d4edda; border-radius: 6px; border-left: 4px solid #27ae60;">';
            html += `<strong>💰 Quick Win Potential:</strong> Top 10 cases worth <strong>$${topTenValue.toFixed(2)}</strong> to you`;
            html += '</div>';

            container.innerHTML = html;
        }

        // 2. Company Intelligence Dashboard
        function generateCompanyIntelligence() {
            const container = document.getElementById('insight-company-intelligence');
            const allData = getFilteredInsightsData();

            const companyProfiles = {};
            
            allData.forEach(row => {
                const company = normalizeCompanyName(row['Company Name'] || 'Unknown');
                if (!companyProfiles[company]) {
                    companyProfiles[company] = {
                        total: 0,
                        paid: 0,
                        requested: 0,
                        disqualified: 0,
                        totalRevenue: 0,
                        paymentDays: [],
                        recentCases: []
                    };
                }
                
                const profile = companyProfiles[company];
                profile.total++;
                
                if (row['_rowType'] === 'paid') {
                    profile.paid++;
                    const amount = parseFloat((row['Paid Amount'] || '0').replace(/[$,]/g, ''));
                    if (!isNaN(amount)) profile.totalRevenue += amount;
                    
                    // Calculate days to payment
                    const violationDate = new Date(row['Violation Date']);
                    const paymentDate = new Date(row['Payment Received'] || row['Hearing Date']);
                    if (!isNaN(violationDate.getTime()) && !isNaN(paymentDate.getTime())) {
                        const days = Math.floor((paymentDate - violationDate) / (1000 * 60 * 60 * 24));
                        if (days >= 0 && days < 1000) profile.paymentDays.push(days);
                    }
                } else if (row['_rowType'] === 'requested') {
                    profile.requested++;
                } else if (row['_rowType'] === 'disqualified' || row['_rowType'] === 'dismissed') {
                    profile.disqualified++;
                }
                
                // Track recent cases
                const violationDate = new Date(row['Violation Date']);
                const threeMonthsAgo = new Date();
                threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
                if (!isNaN(violationDate.getTime()) && violationDate > threeMonthsAgo) {
                    profile.recentCases.push(row);
                }
            });

            // Calculate scores and sort
            const companies = Object.keys(companyProfiles)
                .filter(c => companyProfiles[c].total >= 3)
                .map(company => {
                    const profile = companyProfiles[company];
                    // Count paid as 1.0 and requested as 0.25 in payment rate
                    const effectivePaid = profile.paid + (profile.requested * 0.25);
                    const paymentRate = effectivePaid / profile.total;
                    const avgDays = profile.paymentDays.length > 0 
                        ? Math.round(profile.paymentDays.reduce((a, b) => a + b, 0) / profile.paymentDays.length)
                        : 0;
                    const yourRevenue = profile.totalRevenue * 0.25;
                    
                    // Reliability score (0-10)
                    let score = paymentRate * 7; // Max 7 points for payment rate
                    if (avgDays > 0 && avgDays < 60) score += 2; // 2 points for fast payment
                    if (profile.total >= 10) score += 1; // 1 point for volume
                    score = Math.min(10, score).toFixed(1);
                    
                    // Recommendation
                    let recommendation = '';
                    let recommendationClass = '';
                    if (paymentRate >= 0.8 && profile.total >= 5) {
                        recommendation = '🌟 Premium client - Pursue aggressively';
                        recommendationClass = 'background: #d4edda; color: #155724;';
                    } else if (paymentRate >= 0.6) {
                        recommendation = '✅ Good client - Standard pursuit';
                        recommendationClass = 'background: #d1ecf1; color: #0c5460;';
                    } else if (paymentRate >= 0.4) {
                        recommendation = '⚠️ Mixed results - Selective pursuit';
                        recommendationClass = 'background: #fff3cd; color: #856404;';
                    } else {
                        recommendation = '❌ Poor payer - Avoid or low priority';
                        recommendationClass = 'background: #f8d7da; color: #721c24;';
                    }
                    
                    return {
                        company,
                        profile,
                        paymentRate,
                        avgDays,
                        yourRevenue,
                        score,
                        recommendation,
                        recommendationClass
                    };
                })
                .sort((a, b) => b.yourRevenue - a.yourRevenue);

            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">';
            
            companies.slice(0, 12).forEach(c => {
                html += `<div style="border: 2px solid #667eea; border-radius: 8px; padding: 15px;">`;
                html += `<h4 style="color: #667eea; margin-bottom: 10px; font-size: 1em;">${c.company}</h4>`;
                
                // Reliability Score
                const scoreColor = c.score >= 7 ? '#27ae60' : c.score >= 5 ? '#f39c12' : '#e74c3c';
                html += `<div style="margin-bottom: 10px;">`;
                html += `<div style="font-size: 0.8em; color: #666;">Reliability Score</div>`;
                html += `<div style="font-size: 2em; font-weight: bold; color: ${scoreColor};">${c.score}/10</div>`;
                html += '</div>';
                
                // Stats
                html += `<div style="font-size: 0.85em; line-height: 1.8;">`;
                html += `<div>📊 <strong>${c.profile.total}</strong> total violations</div>`;
                html += `<div>✅ <strong>${(c.paymentRate * 100).toFixed(0)}%</strong> payment rate</div>`;
                html += `<div>💰 <strong>$${c.yourRevenue.toFixed(2)}</strong> earned</div>`;
                if (c.avgDays > 0) {
                    html += `<div>⏱️ <strong>${c.avgDays}</strong> days avg payment</div>`;
                }
                if (c.profile.recentCases.length > 0) {
                    html += `<div>🆕 <strong>${c.profile.recentCases.length}</strong> recent (3mo)</div>`;
                }
                html += '</div>';
                
                // Recommendation
                html += `<div style="margin-top: 12px; padding: 8px; border-radius: 4px; font-size: 0.85em; font-weight: 500; ${c.recommendationClass}">`;
                html += c.recommendation;
                html += '</div>';
                
                html += '</div>';
            });
            
            html += '</div>';
            
            html += '<div style="margin-top: 15px; padding: 12px; background: #f0f4ff; border-radius: 6px; border-left: 4px solid #667eea;">';
            html += '<strong>📊 Note:</strong> Chart shows fiscal year starting in July';
            html += '</div>';

            container.innerHTML = html;
        }

        // 3. Collection Optimizer
        function generateCollectionOptimizer() {
            const container = document.getElementById('insight-collection-optimizer');
            const allData = getFilteredInsightsData();

            // Get unpaid cases with scoring
            const unpaidCases = allData.filter(row => 
                (!row['_rowType'] || row['_rowType'] === 'submitted') &&
                row['Paid Amount']
            );

            const prioritizedCases = unpaidCases.map(row => {
                const amount = parseFloat((row['Paid Amount'] || '0').replace(/[$,]/g, ''));
                const yourCut = amount * 0.25;
                
                // Calculate age
                const violationDate = new Date(row['Violation Date']);
                const now = new Date();
                const daysOld = !isNaN(violationDate.getTime()) 
                    ? Math.floor((now - violationDate) / (1000 * 60 * 60 * 24))
                    : 0;
                
                // Priority score
                let priority = 0;
                priority += Math.min(yourCut / 10, 30); // Up to 30 points for value
                if (daysOld > 180) priority += 30; // 30 points if old
                else if (daysOld > 90) priority += 20;
                else if (daysOld > 30) priority += 10;
                
                // Company history bonus
                // (simplified - in real implementation would check company payment rate)
                
                priority = Math.min(100, priority);
                
                let urgency = daysOld > 150 ? '🚨 URGENT' : daysOld > 90 ? '⚠️ High' : daysOld > 30 ? '🔔 Medium' : '✅ Normal';
                
                return {
                    ...row,
                    amount,
                    yourCut,
                    daysOld,
                    priority: Math.round(priority),
                    urgency
                };
            });

            prioritizedCases.sort((a, b) => b.priority - a.priority);

            let html = '<div style="margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px;">';
            html += '<h4 style="margin-bottom: 10px;">📋 Your Action Plan This Week</h4>';
            
            const top10 = prioritizedCases.slice(0, 10);
            const expectedValue = top10.reduce((sum, c) => sum + c.yourCut, 0);
            
            html += `<p style="font-size: 1.1em;">Focus on these <strong>${top10.length}</strong> cases for expected return of <strong>$${expectedValue.toFixed(2)}</strong></p>`;
            html += '</div>';

            html += '<div style="overflow-x: auto;"><table style="width: 100%; font-size: 0.85em; border-collapse: collapse;">';
            html += '<thead><tr style="background: #667eea; color: white;">';
            html += '<th style="padding: 8px;">Priority</th>';
            html += '<th style="padding: 8px;">Urgency</th>';
            html += '<th style="padding: 8px; text-align: left;">Company</th>';
            html += '<th style="padding: 8px;">Summons</th>';
            html += '<th style="padding: 8px; text-align: right;">Your Cut</th>';
            html += '<th style="padding: 8px;">Days Old</th>';
            html += '<th style="padding: 8px; text-align: left;">Action</th>';
            html += '</tr></thead><tbody>';

            prioritizedCases.slice(0, 20).forEach((row, i) => {
                const bgColor = i % 2 === 0 ? '#f8f9fa' : 'white';
                const priorityColor = row.priority >= 70 ? '#e74c3c' : row.priority >= 50 ? '#f39c12' : '#3498db';
                
                html += `<tr style="background: ${bgColor};">`;
                html += `<td style="padding: 6px; text-align: center;"><span style="background: ${priorityColor}; color: white; padding: 4px 8px; border-radius: 4px; font-weight: bold;">${row.priority}</span></td>`;
                html += `<td style="padding: 6px;">${row.urgency}</td>`;
                html += `<td style="padding: 6px;">${row['Company Name'] || 'Unknown'}</td>`;
                html += `<td style="padding: 6px; font-family: monospace; font-size: 0.9em;">${row['Summons Number'] || 'N/A'}</td>`;
                html += `<td style="padding: 6px; text-align: right; font-weight: bold; color: #27ae60;">$${row.yourCut.toFixed(2)}</td>`;
                html += `<td style="padding: 6px; text-align: center;">${row.daysOld}</td>`;
                html += `<td style="padding: 6px; font-size: 0.85em;">${row.daysOld > 120 ? 'Call + email NOW' : row.daysOld > 60 ? 'Follow up' : 'Monitor'}</td>`;
                html += '</tr>';
            });

            html += '</tbody></table></div>';

            container.innerHTML = html;
        }

        // 4. Cash Flow Forecaster
        function generateCashFlowForecast() {
            const container = document.getElementById('insight-cash-flow');
            const allData = getFilteredInsightsData();

            // Analyze payment timing for paid cases
            const paymentDelays = [];
            allData.filter(row => row['_rowType'] === 'paid').forEach(row => {
                const submittedDate = new Date(row['Date Submitted']);
                const paymentDate = new Date(row['Payment Received'] || row['Hearing Date']);
                if (!isNaN(submittedDate.getTime()) && !isNaN(paymentDate.getTime())) {
                    const days = Math.floor((paymentDate - submittedDate) / (1000 * 60 * 60 * 24));
                    if (days >= 0 && days < 365) paymentDelays.push(days);
                }
            });

            const avgDelay = paymentDelays.length > 0 
                ? Math.round(paymentDelays.reduce((a, b) => a + b, 0) / paymentDelays.length)
                : 60;

            // Get requested cases
            const requestedCases = allData.filter(row => row['_rowType'] === 'requested');
            
            // Forecast by time period
            const forecast = {
                next30: 0,
                next60: 0,
                next90: 0,
                cases30: [],
                cases60: [],
                cases90: []
            };

            requestedCases.forEach(row => {
                const amount = parseFloat((row['Paid Amount'] || '0').replace(/[$,]/g, ''));
                if (isNaN(amount)) return;
                
                const yourCut = amount * 0.25;
                const requestDate = new Date(row['Date Submitted']);
                const now = new Date();
                const daysSinceRequest = !isNaN(requestDate.getTime())
                    ? Math.floor((now - requestDate) / (1000 * 60 * 60 * 24))
                    : 0;
                
                const expectedDaysToPayment = avgDelay - daysSinceRequest;
                
                if (expectedDaysToPayment <= 30) {
                    forecast.next30 += yourCut;
                    forecast.cases30.push(row);
                }
                if (expectedDaysToPayment <= 60) {
                    forecast.next60 += yourCut;
                    forecast.cases60.push(row);
                }
                if (expectedDaysToPayment <= 90) {
                    forecast.next90 += yourCut;
                    forecast.cases90.push(row);
                }
            });

            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">';
            
            html += `<div style="background: linear-gradient(135deg, #27ae60 0%, #229954 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;">`;
            html += '<div style="font-size: 0.9em; opacity: 0.9;">Next 30 Days</div>';
            html += `<div style="font-size: 2em; font-weight: bold; margin: 10px 0;">$${forecast.next30.toFixed(2)}</div>`;
            html += `<div style="font-size: 0.85em;">${forecast.cases30.length} payments expected</div>`;
            html += '</div>';

            html += `<div style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;">`;
            html += '<div style="font-size: 0.9em; opacity: 0.9;">Next 60 Days</div>';
            html += `<div style="font-size: 2em; font-weight: bold; margin: 10px 0;">$${forecast.next60.toFixed(2)}</div>`;
            html += `<div style="font-size: 0.85em;">${forecast.cases60.length} payments expected</div>`;
            html += '</div>';

            html += `<div style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;">`;
            html += '<div style="font-size: 0.9em; opacity: 0.9;">Next 90 Days</div>';
            html += `<div style="font-size: 2em; font-weight: bold; margin: 10px 0;">$${forecast.next90.toFixed(2)}</div>`;
            html += `<div style="font-size: 0.85em;">${forecast.cases90.length} payments expected</div>`;
            html += '</div>';

            html += '</div>';

            html += `<div style="padding: 15px; background: #e8f4f8; border-radius: 6px; border-left: 4px solid #3498db;">`;
            html += `<strong>💡 Insight:</strong> Based on historical data, payments typically arrive ${avgDelay} days after request submission.`;
            html += '</div>';
            
            html += '<div style="margin-top: 15px; padding: 12px; background: #f0f4ff; border-radius: 6px; border-left: 4px solid #667eea;">';
            html += '<strong>📊 Note:</strong> Chart shows fiscal year starting in July';
            html += '</div>';

            container.innerHTML = html;
        }

        // Continue with remaining insight functions (5-10)...
        
        function generateDisqualificationDetective() {
            const container = document.getElementById('insight-disqualification');
            const allData = getFilteredInsightsData();

            const disqualifiedCases = allData.filter(row => row['_rowType'] === 'disqualified' || row['_rowType'] === 'dismissed');
            
            // Analyze patterns
            const boroughBreakdown = {};
            const resultBreakdown = {};
            const hourBreakdown = {};
            const companyBreakdown = {};

            disqualifiedCases.forEach(row => {
                // By borough
                const borough = row['Violation Location (Borough)'] || 'Unknown';
                boroughBreakdown[borough] = (boroughBreakdown[borough] || 0) + 1;
                
                // By hearing result
                const result = row['Hearing Result'] || 'Unknown';
                resultBreakdown[result] = (resultBreakdown[result] || 0) + 1;
                
                // By time of day
                const time = row['Violation Time'];
                if (time) {
                    const hour = parseInt(time.split(':')[0]);
                    if (!isNaN(hour)) {
                        hourBreakdown[hour] = (hourBreakdown[hour] || 0) + 1;
                    }
                }
                
                // By company
                const company = row['Company Name'] || 'Unknown';
                companyBreakdown[company] = (companyBreakdown[company] || 0) + 1;
            });

            let html = `<div style="margin-bottom: 15px; padding: 12px; background: #fff3cd; border-radius: 6px; border-left: 4px solid #f39c12;">`;
            html += `<strong>⚠️ ${disqualifiedCases.length} cases disqualified</strong> - analyze patterns to reduce losses`;
            html += '</div>';

            html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">';
            
            // Top dismissal reasons
            html += '<div style="border: 1px solid #ddd; padding: 15px; border-radius: 6px;">';
            html += '<h4 style="color: #667eea; margin-bottom: 10px;">Top Dismissal Reasons</h4>';
            const topReasons = Object.entries(resultBreakdown)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            topReasons.forEach(([reason, count]) => {
                const pct = ((count / disqualifiedCases.length) * 100).toFixed(1);
                html += `<div style="margin-bottom: 8px;">`;
                html += `<div style="font-size: 0.85em; color: #666;">${reason}</div>`;
                html += `<div style="display: flex; align-items: center; gap: 8px;">`;
                html += `<div style="flex: 1; background: #e0e0e0; height: 20px; border-radius: 10px; overflow: hidden;">`;
                html += `<div style="width: ${pct}%; background: #e74c3c; height: 100%;"></div>`;
                html += `</div>`;
                html += `<span style="font-weight: bold; font-size: 0.9em;">${count}</span>`;
                html += '</div></div>';
            });
            html += '</div>';

            // Worst boroughs
            html += '<div style="border: 1px solid #ddd; padding: 15px; border-radius: 6px;">';
            html += '<h4 style="color: #667eea; margin-bottom: 10px;">Problem Boroughs</h4>';
            const topBoroughs = Object.entries(boroughBreakdown)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            topBoroughs.forEach(([borough, count]) => {
                html += `<div style="padding: 6px; background: #f8f9fa; margin-bottom: 6px; border-radius: 4px;">`;
                html += `<strong>${borough}:</strong> ${count} disqualified`;
                html += '</div>';
            });
            html += '</div>';

            html += '</div>';

            html += `<div style="margin-top: 15px; padding: 12px; background: #d4edda; border-radius: 6px;">`;
            html += `<strong>💡 Recommendation:</strong> Review documentation procedures for your top dismissal reasons. Consider focusing efforts on boroughs with lower disqualification rates.`;
            html += '</div>';
            
            html += '<div style="margin-top: 15px; padding: 12px; background: #f0f4ff; border-radius: 6px; border-left: 4px solid #667eea;">';
            html += '<strong>📊 Note:</strong> Chart shows fiscal year starting in July';
            html += '</div>';

            container.innerHTML = html;
        }

        function generateGeographicHeatMap() {
            const container = document.getElementById('insight-geographic');
            const allData = getFilteredInsightsData();

            const locationStats = {};

            allData.forEach(row => {
                const borough = row['Violation Location (Borough)'] || 'Unknown';
                const street = row['Violation Location (Street Name)'] || row['Place of Occurrence'] || 'Unknown';
                
                // Borough stats
                if (!locationStats[borough]) {
                    locationStats[borough] = {
                        total: 0,
                        paid: 0,
                        revenue: 0,
                        streets: {}
                    };
                }
                locationStats[borough].total++;
                if (row['_rowType'] === 'paid') {
                    locationStats[borough].paid++;
                    const amount = parseFloat((row['Paid Amount'] || '0').replace(/[$,]/g, ''));
                    if (!isNaN(amount)) locationStats[borough].revenue += amount;
                }
                else if (row['_rowType'] === 'requested') {
                    locationStats[borough].paid += 0.25;
                }
                
                // Street stats within borough
                if (!locationStats[borough].streets[street]) {
                    locationStats[borough].streets[street] = 0;
                }
                locationStats[borough].streets[street]++;
            });

            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">';

            Object.entries(locationStats)
                .sort((a, b) => b[1].revenue - a[1].revenue)
                .forEach(([borough, stats]) => {
                    const paymentRate = ((stats.paid / stats.total) * 100).toFixed(1);
                    const yourRevenue = stats.revenue * 0.25;
                    const rateColor = paymentRate >= 60 ? '#27ae60' : paymentRate >= 40 ? '#f39c12' : '#e74c3c';
                    
                    // Top streets in this borough
                    const topStreets = Object.entries(stats.streets)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 3);
                    
                    html += `<div style="border: 2px solid #667eea; border-radius: 8px; padding: 15px;">`;
                    html += `<h4 style="color: #667eea; margin-bottom: 10px;">${borough}</h4>`;
                    
                    html += `<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">`;
                    html += `<div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 4px;">`;
                    html += `<div style="font-size: 0.75em; color: #666;">Total Cases</div>`;
                    html += `<div style="font-size: 1.5em; font-weight: bold;">${stats.total}</div>`;
                    html += `</div>`;
                    html += `<div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 4px;">`;
                    html += `<div style="font-size: 0.75em; color: #666;">Pay Rate</div>`;
                    html += `<div style="font-size: 1.5em; font-weight: bold; color: ${rateColor};">${paymentRate}%</div>`;
                    html += `</div>`;
                    html += `</div>`;
                    
                    html += `<div style="margin-bottom: 10px;">`;
                    html += `<div style="font-size: 0.85em; color: #666;">Your Revenue</div>`;
                    html += `<div style="font-size: 1.3em; font-weight: bold; color: #27ae60;">$${yourRevenue.toFixed(2)}</div>`;
                    html += `</div>`;
                    
                    html += `<div>`;
                    html += `<div style="font-size: 0.85em; color: #666; margin-bottom: 6px;">🔥 Hot Spots:</div>`;
                    topStreets.forEach(([street, count]) => {
                        html += `<div style="font-size: 0.8em; padding: 4px; background: #fff3cd; margin-bottom: 3px; border-radius: 3px;">`;
                        html += `${street} (${count})`;
                        html += `</div>`;
                    });
                    html += `</div>`;
                    
                    html += `</div>`;
                });

            html += '</div>';
            
            html += '<div style="margin-top: 15px; padding: 12px; background: #f0f4ff; border-radius: 6px; border-left: 4px solid #667eea;">';
            html += '<strong>📊 Note:</strong> Chart shows fiscal year starting in July';
            html += '</div>';

            container.innerHTML = html;
        }

        function generateSmartAlerts() {
            const container = document.getElementById('insight-alerts');
            const allData = getFilteredInsightsData();

            const alerts = [];
            const now = new Date();

            // Check for new "Paid in Full" cases
            const newMoney = allData.filter(row => {
                const hearingStatus = (row['Hearing Status'] || '').toLowerCase();
                const paymentStatus = (row['Payment Status'] || '').trim();
                return hearingStatus === 'paid in full' && !paymentStatus;
            });

            if (newMoney.length > 0) {
                const totalValue = newMoney.reduce((sum, row) => {
                    const amount = parseFloat((row['Paid Amount'] || '0').replace(/[$,]/g, ''));
                    return sum + (isNaN(amount) ? 0 : amount * 0.25);
                }, 0);
                alerts.push({
                    type: 'money',
                    priority: 'high',
                    icon: '💰',
                    title: 'New Money Available to Collect',
                    message: `${newMoney.length} cases marked "Paid in Full" - worth $${totalValue.toFixed(2)} to you!`,
                    action: 'Go to NEW MONEY tab to collect'
                });
            }

            // Check for overdue requests
            const overdueRequests = allData.filter(row => {
                if (row['_rowType'] !== 'requested') return false;
                const requestDate = new Date(row['Date Submitted']);
                if (isNaN(requestDate.getTime())) return false;
                const daysSince = Math.floor((now - requestDate) / (1000 * 60 * 60 * 24));
                return daysSince > 60; // Overdue after 60 days
            });

            if (overdueRequests.length > 0) {
                alerts.push({
                    type: 'warning',
                    priority: 'high',
                    icon: '⚠️',
                    title: 'Overdue Payment Requests',
                    message: `${overdueRequests.length} payment requests are over 60 days old - follow up now!`,
                    action: 'Review and contact these companies'
                });
            }

            // Check for old unpaid cases
            const oldCases = allData.filter(row => {
                if (row['_rowType'] === 'paid' || row['_rowType'] === 'disqualified' || row['_rowType'] === 'dismissed') return false;
                const violationDate = new Date(row['Violation Date']);
                if (isNaN(violationDate.getTime())) return false;
                const daysSince = Math.floor((now - violationDate) / (1000 * 60 * 60 * 24));
                return daysSince > 180; // Very old
            });

            if (oldCases.length > 0) {
                alerts.push({
                    type: 'info',
                    priority: 'medium',
                    icon: '⏰',
                    title: 'Old Cases Need Attention',
                    message: `${oldCases.length} cases are 6+ months old - closing deadline approaching`,
                    action: 'Review and decide: pursue or close'
                });
            }

            // Check for high-value unpaid cases
            const highValueUnpaid = allData.filter(row => {
                if (row['_rowType'] === 'paid' || row['_rowType'] === 'disqualified' || row['_rowType'] === 'dismissed') return false;
                const amount = parseFloat((row['Paid Amount'] || '0').replace(/[$,]/g, ''));
                return amount > 1000;
            });

            if (highValueUnpaid.length > 0) {
                const totalValue = highValueUnpaid.reduce((sum, row) => {
                    const amount = parseFloat((row['Paid Amount'] || '0').replace(/[$,]/g, ''));
                    return sum + (amount * 0.25);
                }, 0);
                alerts.push({
                    type: 'opportunity',
                    priority: 'medium',
                    icon: '🎯',
                    title: 'High-Value Cases Unpaid',
                    message: `${highValueUnpaid.length} cases worth $${totalValue.toFixed(2)} to you - prioritize these!`,
                    action: 'Focus collection efforts here'
                });
            }

            // Render alerts
            let html = '';
            
            if (alerts.length === 0) {
                html = `<div style="text-align: center; padding: 40px; color: #27ae60;">`;
                html += `<div style="font-size: 3em; margin-bottom: 10px;">✅</div>`;
                html += `<h4>All Clear!</h4>`;
                html += `<p>No urgent alerts at this time. Keep up the good work!</p>`;
                html += `</div>`;
            } else {
                alerts.forEach(alert => {
                    const bgColor = alert.priority === 'high' ? '#fff3cd' : '#e8f4f8';
                    const borderColor = alert.priority === 'high' ? '#f39c12' : '#3498db';
                    
                    html += `<div style="background: ${bgColor}; border-left: 4px solid ${borderColor}; padding: 15px; margin-bottom: 12px; border-radius: 6px;">`;
                    html += `<div style="display: flex; align-items: start; gap: 12px;">`;
                    html += `<div style="font-size: 2em;">${alert.icon}</div>`;
                    html += `<div style="flex: 1;">`;
                    html += `<h4 style="color: #2c3e50; margin-bottom: 6px;">${alert.title}</h4>`;
                    html += `<p style="color: #666; margin-bottom: 8px;">${alert.message}</p>`;
                    html += `<div style="font-size: 0.85em; color: #667eea; font-weight: 600;">👉 ${alert.action}</div>`;
                    html += `</div>`;
                    html += `</div>`;
                    html += `</div>`;
                });
            }

            container.innerHTML = html;
        }

        function generateSeasonalPlanner() {
            const container = document.getElementById('insight-seasonal');
            const allData = getFilteredInsightsData();

            const monthlyStats = {};
            const fiscalMonthNames = ['Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
            const calendarMonthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

            allData.forEach(row => {
                const date = new Date(row['Violation Date']);
                if (!isNaN(date.getTime())) {
                    const calendarMonth = date.getMonth(); // 0-11 (Jan-Dec)
                    // Convert to fiscal month (July=0, June=11)
                    const fiscalMonth = calendarMonth >= 6 ? calendarMonth - 6 : calendarMonth + 6;
                    if (!monthlyStats[fiscalMonth]) {
                        monthlyStats[fiscalMonth] = 0;
                    }
                    monthlyStats[fiscalMonth]++;
                }
            });

            const avgPerMonth = Object.values(monthlyStats).reduce((a, b) => a + b, 0) / 12;
            const now = new Date();
            const currentCalendarMonth = now.getMonth();
            const currentFiscalMonth = currentCalendarMonth >= 6 ? currentCalendarMonth - 6 : currentCalendarMonth + 6;
            const nextFiscalMonth = (currentFiscalMonth + 1) % 12;
            const predictedNext = monthlyStats[nextFiscalMonth] || avgPerMonth;

            let html = '<div style="margin-bottom: 20px;">';
            html += '<canvas id="seasonal-chart"></canvas>';
            html += '</div>';

            html += `<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">`;
            
            html += `<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;">`;
            html += '<div style="font-size: 0.9em; opacity: 0.9;">Next Month Forecast</div>';
            html += `<div style="font-size: 2.5em; font-weight: bold; margin: 10px 0;">${Math.round(predictedNext)}</div>`;
            html += '<div style="font-size: 0.85em;">expected violations</div>';
            html += '</div>';

            const busiestMonth = Object.entries(monthlyStats).sort((a, b) => b[1] - a[1])[0];
            html += `<div style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;">`;
            html += '<div style="font-size: 0.9em; opacity: 0.9;">Peak Season</div>';
            html += `<div style="font-size: 2.5em; font-weight: bold; margin: 10px 0;">${fiscalMonthNames[busiestMonth[0]]}</div>`;
            html += `<div style="font-size: 0.85em;">${busiestMonth[1]} violations</div>`;
            html += '</div>';

            html += '</div>';
            
            html += '<div style="margin-top: 15px; padding: 12px; background: #f0f4ff; border-radius: 6px; border-left: 4px solid #667eea;">';
            html += '<strong>📊 Note:</strong> Chart shows fiscal year starting in July';
            html += '</div>';

            container.innerHTML = html;

            // Draw chart
            setTimeout(() => {
                const ctx = document.getElementById('seasonal-chart');
                if (ctx) {
                    new Chart(ctx.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: fiscalMonthNames,
                            datasets: [{
                                label: 'Violations by Month (Fiscal Year)',
                                data: fiscalMonthNames.map((_, i) => monthlyStats[i] || 0),
                                borderColor: '#667eea',
                                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { display: true }
                            },
                            scales: {
                                y: { beginAtZero: true }
                            }
                        }
                    });
                }
            }, 100);
        }

        function generateBehaviorChangeDetector() {
            const container = document.getElementById('insight-behavior-change');
            const allData = getFilteredInsightsData();

            // Find revenue opportunities
            const opportunities = [];
            
            // 1. High-value unpaid cases
            const unpaidHighValue = allData.filter(row => {
                if (row['_rowType'] === 'requested' || row['_rowType'] === 'paid' || 
                    row['_rowType'] === 'disqualified' || row['_rowType'] === 'dismissed') {
                    return false;
                }
                const amount = parseFloat((row['Paid Amount'] || '0').replace(/[$,]/g, ''));
                return !isNaN(amount) && amount > 300;
            });
            
            if (unpaidHighValue.length > 0) {
                const totalValue = unpaidHighValue.reduce((sum, row) => {
                    const amount = parseFloat((row['Paid Amount'] || '0').replace(/[$,]/g, ''));
                    return sum + (amount * 0.25);
                }, 0);
                
                opportunities.push({
                    type: 'High-Value Cases',
                    icon: '💎',
                    count: unpaidHighValue.length,
                    value: totalValue,
                    description: `You have ${unpaidHighValue.length} unpaid cases worth over $75 each to you`,
                    action: 'Prioritize these for immediate follow-up',
                    color: '#27ae60'
                });
            }
            
            // 2. Companies with good payment history but unpaid cases
            const companyStats = {};
            allData.forEach(row => {
                const company = row['Company Name'] || 'Unknown';
                if (!companyStats[company]) {
                    companyStats[company] = { total: 0, paid: 0, unpaid: [] };
                }
                companyStats[company].total++;
                if (row['_rowType'] === 'paid') {
                    companyStats[company].paid++;
                } else if (row['_rowType'] === 'requested') {
                    companyStats[company].paid += 0.25;
                } else if (row['_rowType'] !== 'disqualified' && row['_rowType'] !== 'dismissed' && row['_rowType'] !== 'requested') {
                    companyStats[company].unpaid.push(row);
                }
            });
            
            const reliableWithUnpaid = Object.entries(companyStats).filter(([company, stats]) => {
                const payRate = stats.paid / stats.total;
                return stats.total >= 3 && payRate >= 0.6 && stats.unpaid.length > 0;
            }).map(([company, stats]) => {
                const unpaidValue = stats.unpaid.reduce((sum, row) => {
                    const amount = parseFloat((row['Paid Amount'] || '0').replace(/[$,]/g, ''));
                    return sum + (amount * 0.25);
                }, 0);
                return { company, stats, unpaidValue };
            }).sort((a, b) => b.unpaidValue - a.unpaidValue);
            
            if (reliableWithUnpaid.length > 0) {
                const totalValue = reliableWithUnpaid.reduce((sum, item) => sum + item.unpaidValue, 0);
                const topCompany = reliableWithUnpaid[0];
                const payRate = Math.round((topCompany.stats.paid / topCompany.stats.total) * 100);
                
                opportunities.push({
                    type: 'Reliable Payers',
                    icon: '⭐',
                    count: reliableWithUnpaid.length,
                    value: totalValue,
                    description: `${reliableWithUnpaid.length} companies with strong payment history (${payRate}%+ rate) have unpaid cases`,
                    action: `Top target: ${topCompany.company} (${topCompany.stats.unpaid.length} unpaid, worth $${topCompany.unpaidValue.toFixed(2)})`,
                    color: '#f39c12'
                });
            }
            
            // 3. Quick wins - low value but easy to collect
            const quickWins = allData.filter(row => {
                if (row['_rowType'] !== 'paid' && row['_rowType'] !== 'requested' && 
                    row['_rowType'] !== 'disqualified' && row['_rowType'] !== 'dismissed') {
                    const amount = parseFloat((row['Paid Amount'] || '0').replace(/[$,]/g, ''));
                    const violationDate = new Date(row['Violation Date']);
                    const daysOld = (new Date() - violationDate) / (1000 * 60 * 60 * 24);
                    return !isNaN(amount) && amount > 0 && amount < 300 && daysOld < 90;
                }
                return false;
            });
            
            if (quickWins.length > 0) {
                const totalValue = quickWins.reduce((sum, row) => {
                    const amount = parseFloat((row['Paid Amount'] || '0').replace(/[$,]/g, ''));
                    return sum + (amount * 0.25);
                }, 0);
                
                opportunities.push({
                    type: 'Quick Wins',
                    icon: '⚡',
                    count: quickWins.length,
                    value: totalValue,
                    description: `${quickWins.length} recent, low-value cases under $300 - easy to collect`,
                    action: 'Batch process these for efficient collection',
                    color: '#3498db'
                });
            }
            
            // 4. Cases approaching statute of limitations
            const oldCases = allData.filter(row => {
                if (row['_rowType'] === 'paid' || row['_rowType'] === 'disqualified' || row['_rowType'] === 'dismissed') {
                    return false;
                }
                const violationDate = new Date(row['Violation Date']);
                const daysOld = (new Date() - violationDate) / (1000 * 60 * 60 * 24);
                return !isNaN(violationDate.getTime()) && daysOld > 365 && daysOld < 730;
            });
            
            if (oldCases.length > 0) {
                const totalValue = oldCases.reduce((sum, row) => {
                    const amount = parseFloat((row['Paid Amount'] || '0').replace(/[$,]/g, ''));
                    return sum + (amount * 0.25);
                }, 0);
                
                opportunities.push({
                    type: 'Urgent - Aging Cases',
                    icon: '⚠️',
                    count: oldCases.length,
                    value: totalValue,
                    description: `${oldCases.length} cases over 1 year old - act now before statute runs out`,
                    action: 'These need immediate attention!',
                    color: '#e74c3c'
                });
            }

            let html = '';
            
            if (opportunities.length === 0) {
                html = `<div style="text-align: center; padding: 40px; color: #666;">`;
                html += `<div style="font-size: 2em; margin-bottom: 10px;">💰</div>`;
                html += `<p>All major revenue opportunities have been captured!</p>`;
                html += `</div>`;
            } else {
                // Sort by value descending
                opportunities.sort((a, b) => b.value - a.value);
                
                html += '<div style="display: grid; gap: 15px;">';
                opportunities.forEach(opp => {
                    html += `<div style="background: white; border-left: 5px solid ${opp.color}; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">`;
                    html += `<div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">`;
                    html += `<div>`;
                    html += `<h4 style="color: #2c3e50; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">`;
                    html += `<span style="font-size: 1.5em;">${opp.icon}</span> ${opp.type}`;
                    html += `</h4>`;
                    html += `</div>`;
                    html += `<div style="background: ${opp.color}; color: white; padding: 10px 20px; border-radius: 6px; text-align: center;">`;
                    html += `<div style="font-size: 1.8em; font-weight: bold;">$${opp.value.toFixed(2)}</div>`;
                    html += `<div style="font-size: 0.8em; opacity: 0.9;">${opp.count} cases</div>`;
                    html += `</div>`;
                    html += `</div>`;
                    html += `<p style="color: #666; margin-bottom: 8px;">${opp.description}</p>`;
                    html += `<div style="background: #f8f9fa; padding: 10px; border-radius: 4px; font-size: 0.9em; color: #2c3e50;">`;
                    html += `<strong>💡 Action:</strong> ${opp.action}`;
                    html += `</div>`;
                    html += `</div>`;
                });
                html += '</div>';
                
                // Add total
                const totalOpportunityValue = opportunities.reduce((sum, opp) => sum + opp.value, 0);
                html += `<div style="margin-top: 15px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px; text-align: center;">`;
                html += `<div style="font-size: 1.2em; margin-bottom: 5px;">🎯 Total Revenue Opportunity</div>`;
                html += `<div style="font-size: 3em; font-weight: bold;">$${totalOpportunityValue.toFixed(2)}</div>`;
                html += `<div style="font-size: 0.9em; opacity: 0.9;">Act on these opportunities to maximize your revenue</div>`;
                html += `</div>`;
            }

            container.innerHTML = html;
        }

        function generateROIMetrics() {
            const container = document.getElementById('insight-roi');
            const allData = getFilteredInsightsData();

            // Count requested as effectively paid for revenue calculations
            const paidAndRequestedCases = allData.filter(row => row['_rowType'] === 'paid' || row['_rowType'] === 'requested');
            const totalRevenue = paidAndRequestedCases.reduce((sum, row) => {
                const amount = parseFloat((row['Paid Amount'] || '0').replace(/[$,]/g, ''));
                if (row['_rowType'] === 'paid') {
                    return sum + (isNaN(amount) ? 0 : amount * 0.25);
                } else if (row['_rowType'] === 'requested') {
                    return sum + (isNaN(amount) ? 0 : amount * 0.25 * 0.25);
                }
                return sum;
            }, 0);

            const avgRevenuePerCase = paidAndRequestedCases.length > 0 ? totalRevenue / paidAndRequestedCases.length : 0;

            // Break down by case characteristics
            const withHearing = paidAndRequestedCases.filter(row => row['Hearing Result'] && row['Hearing Result'].trim() !== '');
            const withoutHearing = paidAndRequestedCases.filter(row => !row['Hearing Result'] || row['Hearing Result'].trim() === '');

            const hearingRevenue = withHearing.reduce((sum, row) => {
                const amount = parseFloat((row['Paid Amount'] || '0').replace(/[$,]/g, ''));
                if (row['_rowType'] === 'paid') {
                    return sum + (amount * 0.25);
                } else if (row['_rowType'] === 'requested') {
                    return sum + (amount * 0.25 * 0.25);
                }
                return sum;
            }, 0);

            const noHearingRevenue = withoutHearing.reduce((sum, row) => {
                const amount = parseFloat((row['Paid Amount'] || '0').replace(/[$,]/g, ''));
                return sum + (amount * 0.25);
            }, 0);

            const avgWithHearing = withHearing.length > 0 ? hearingRevenue / withHearing.length : 0;
            const avgWithoutHearing = withoutHearing.length > 0 ? noHearingRevenue / withoutHearing.length : 0;

            // By amount range
            const ranges = {
                'Under $500': { count: 0, revenue: 0 },
                '$500-$1000': { count: 0, revenue: 0 },
                'Over $1000': { count: 0, revenue: 0 }
            };

            paidAndRequestedCases.forEach(row => {
                const amount = parseFloat((row['Paid Amount'] || '0').replace(/[$,]/g, ''));
                const yourCut = amount * 0.25;
                
                if (amount < 500) {
                    ranges['Under $500'].count++;
                    ranges['Under $500'].revenue += yourCut;
                } else if (amount < 1000) {
                    ranges['$500-$1000'].count++;
                    ranges['$500-$1000'].revenue += yourCut;
                } else {
                    ranges['Over $1000'].count++;
                    ranges['Over $1000'].revenue += yourCut;
                }
            });

            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">';
            
            html += `<div style="background: linear-gradient(135deg, #27ae60 0%, #229954 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;">`;
            html += '<div style="font-size: 0.9em; opacity: 0.9;">Total Revenue (Your Share)</div>';
            html += `<div style="font-size: 2em; font-weight: bold; margin: 10px 0;">$${totalRevenue.toFixed(2)}</div>`;
            html += `<div style="font-size: 0.85em;">${paidAndRequestedCases.length} paid/requested cases</div>`;
            html += '</div>';

            html += `<div style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;">`;
            html += '<div style="font-size: 0.9em; opacity: 0.9;">Avg Per Paid Case</div>';
            html += `<div style="font-size: 2em; font-weight: bold; margin: 10px 0;">$${avgRevenuePerCase.toFixed(2)}</div>`;
            html += '<div style="font-size: 0.85em;">per success</div>';
            html += '</div>';

            html += '</div>';

            // Comparison table
            html += '<h4 style="color: #667eea; margin: 20px 0 10px 0;">Revenue by Case Type</h4>';
            html += '<div style="overflow-x: auto;"><table style="width: 100%; font-size: 0.9em; border-collapse: collapse;">';
            html += '<thead><tr style="background: #667eea; color: white;">';
            html += '<th style="padding: 10px; text-align: left;">Case Type</th>';
            html += '<th style="padding: 10px; text-align: center;">Count</th>';
            html += '<th style="padding: 10px; text-align: right;">Total Revenue</th>';
            html += '<th style="padding: 10px; text-align: right;">Avg Per Case</th>';
            html += '</tr></thead><tbody>';

            html += `<tr style="background: #f8f9fa;">`;
            html += `<td style="padding: 10px;">With Hearing</td>`;
            html += `<td style="padding: 10px; text-align: center;">${withHearing.length}</td>`;
            html += `<td style="padding: 10px; text-align: right; font-weight: bold;">$${hearingRevenue.toFixed(2)}</td>`;
            html += `<td style="padding: 10px; text-align: right; color: #27ae60;">$${avgWithHearing.toFixed(2)}</td>`;
            html += '</tr>';

            html += `<tr style="background: white;">`;
            html += `<td style="padding: 10px;">Without Hearing</td>`;
            html += `<td style="padding: 10px; text-align: center;">${withoutHearing.length}</td>`;
            html += `<td style="padding: 10px; text-align: right; font-weight: bold;">$${noHearingRevenue.toFixed(2)}</td>`;
            html += `<td style="padding: 10px; text-align: right; color: #27ae60;">$${avgWithoutHearing.toFixed(2)}</td>`;
            html += '</tr>';

            Object.entries(ranges).forEach(([range, data], i) => {
                const avg = data.count > 0 ? data.revenue / data.count : 0;
                html += `<tr style="background: ${i % 2 === 0 ? 'white' : '#f8f9fa'};">`;
                html += `<td style="padding: 10px;">${range}</td>`;
                html += `<td style="padding: 10px; text-align: center;">${data.count}</td>`;
                html += `<td style="padding: 10px; text-align: right; font-weight: bold;">$${data.revenue.toFixed(2)}</td>`;
                html += `<td style="padding: 10px; text-align: right; color: #27ae60;">$${avg.toFixed(2)}</td>`;
                html += '</tr>';
            });

            html += '</tbody></table></div>';

            html += `<div style="margin-top: 15px; padding: 12px; background: #e8f4f8; border-radius: 6px;">`;
            html += `<strong>💡 Insight:</strong> ${avgWithHearing > avgWithoutHearing ? 'Cases with hearings generate more revenue on average' : 'Early settlements are more profitable'} - adjust your strategy accordingly.`;
            html += '</div>';
            
            html += '<div style="margin-top: 15px; padding: 12px; background: #f0f4ff; border-radius: 6px; border-left: 4px solid #667eea;">';
            html += '<strong>📊 Note:</strong> Chart shows fiscal year starting in July';
            html += '</div>';

            container.innerHTML = html;
        }

        // 11. Con Edison Deep Dive
        function generateConEdInsight() {
            const container = document.getElementById('insight-coned');
            const allData = getFilteredInsightsData();

            // Filter for all Con Ed related cases using normalization
            const conEdData = allData.filter(row => {
                const normalizedName = normalizeCompanyName(row['Company Name']);
                return normalizedName === 'CON EDISON';
            });

            if (conEdData.length === 0) {
                container.innerHTML = `<div style="text-align: center; padding: 40px; color: #666;">
                    <div style="font-size: 2em; margin-bottom: 10px;">⚡</div>
                    <p>No Con Edison data found in selected datasets.</p>
                </div>`;
                return;
            }

            // Calculate comprehensive Con Ed stats
            const stats = {
                total: conEdData.length,
                paid: conEdData.filter(r => r['_rowType'] === 'paid').length,
                requested: conEdData.filter(r => r['_rowType'] === 'requested').length,
                disqualified: conEdData.filter(r => r['_rowType'] === 'disqualified' || r['_rowType'] === 'dismissed').length,
                unpaid: conEdData.filter(r => !r['_rowType'] || r['_rowType'] === 'submitted').length,
                totalRevenue: 0,
                totalPending: 0,
                avgPaymentDays: [],
                boroughBreakdown: {},
                monthlyTrend: {},
                recentActivity: 0
            };

            // Calculate revenue and payment timing
            conEdData.forEach(row => {
                if (row['_rowType'] === 'paid') {
                    const amount = parseFloat((row['Paid Amount'] || '0').replace(/[$,]/g, ''));
                    if (!isNaN(amount)) stats.totalRevenue += amount;

                    // Calculate payment days
                    const violationDate = new Date(row['Violation Date']);
                    const paymentDate = new Date(row['Payment Received'] || row['Hearing Date']);
                    if (!isNaN(violationDate.getTime()) && !isNaN(paymentDate.getTime())) {
                        const days = Math.floor((paymentDate - violationDate) / (1000 * 60 * 60 * 24));
                        if (days >= 0 && days < 1000) stats.avgPaymentDays.push(days);
                    }
                } else if (row['_rowType'] === 'requested') {
                    const amount = parseFloat((row['Paid Amount'] || '0').replace(/[$,]/g, ''));
                    if (!isNaN(amount)) stats.totalPending += amount;
                }

                // Borough breakdown
                const borough = row['Violation Location (Borough)'] || 'Unknown';
                stats.boroughBreakdown[borough] = (stats.boroughBreakdown[borough] || 0) + 1;

                // Monthly trend
                const date = new Date(row['Violation Date']);
                if (!isNaN(date.getTime())) {
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    stats.monthlyTrend[monthKey] = (stats.monthlyTrend[monthKey] || 0) + 1;

                    // Recent activity (last 3 months)
                    const threeMonthsAgo = new Date();
                    threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
                    if (date > threeMonthsAgo) stats.recentActivity++;
                }
            });

            const avgDays = stats.avgPaymentDays.length > 0 
                ? Math.round(stats.avgPaymentDays.reduce((a, b) => a + b, 0) / stats.avgPaymentDays.length)
                : 0;
            const yourRevenue = stats.totalRevenue * 0.25;
            const yourPending = stats.totalPending * 0.25;
            const paymentRate = ((stats.paid / stats.total) * 100).toFixed(1);
            const disqualificationRate = ((stats.disqualified / stats.total) * 100).toFixed(1);

            // Build comprehensive HTML report
            let html = `<div style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
                <div style="font-size: 2.5em; margin-bottom: 10px;">⚡</div>
                <h3 style="margin-bottom: 10px; font-size: 1.5em;">Con Edison Complete Analysis</h3>
                <p style="font-size: 1em; opacity: 0.95;">Your largest customer - all data consolidated</p>
            </div>`;

            // Key Metrics Grid
            html += `<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px;">`;
            
            html += `<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                <div style="font-size: 0.9em; opacity: 0.9;">Total Cases</div>
                <div style="font-size: 2.5em; font-weight: bold; margin: 10px 0;">${stats.total.toLocaleString()}</div>
                <div style="font-size: 0.85em;">All time</div>
            </div>`;

            html += `<div style="background: linear-gradient(135deg, #27ae60 0%, #229954 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                <div style="font-size: 0.9em; opacity: 0.9;">Payment Rate</div>
                <div style="font-size: 2.5em; font-weight: bold; margin: 10px 0;">${paymentRate}%</div>
                <div style="font-size: 0.85em;">${stats.paid} paid cases</div>
            </div>`;

            html += `<div style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                <div style="font-size: 0.9em; opacity: 0.9;">Your Revenue</div>
                <div style="font-size: 2.5em; font-weight: bold; margin: 10px 0;">$${yourRevenue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                <div style="font-size: 0.85em;">Total earned</div>
            </div>`;

            html += `<div style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                <div style="font-size: 0.9em; opacity: 0.9;">Pending</div>
                <div style="font-size: 2.5em; font-weight: bold; margin: 10px 0;">$${yourPending.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                <div style="font-size: 0.85em;">${stats.requested} requested</div>
            </div>`;

            if (avgDays > 0) {
                html += `<div style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 0.9em; opacity: 0.9;">Avg Payment Time</div>
                    <div style="font-size: 2.5em; font-weight: bold; margin: 10px 0;">${avgDays}</div>
                    <div style="font-size: 0.85em;">days</div>
                </div>`;
            }

            html += `<div style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                <div style="font-size: 0.9em; opacity: 0.9;">Disqualification Rate</div>
                <div style="font-size: 2.5em; font-weight: bold; margin: 10px 0;">${disqualificationRate}%</div>
                <div style="font-size: 0.85em;">${stats.disqualified} dismissed</div>
            </div>`;

            html += `</div>`;

            // Recent Activity
            if (stats.recentActivity > 0) {
                html += `<div style="background: #e8f4f8; padding: 15px; border-radius: 6px; border-left: 4px solid #3498db; margin-bottom: 20px;">
                    <strong>📈 Recent Activity:</strong> ${stats.recentActivity} new violations in the last 3 months
                </div>`;
            }

            // Borough Breakdown
            const sortedBoroughs = Object.entries(stats.boroughBreakdown).sort((a, b) => b[1] - a[1]);
            if (sortedBoroughs.length > 0) {
                html += `<div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #667eea;">
                    <h4 style="color: #667eea; margin-bottom: 15px;">🗺️ Violation Hot Spots</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">`;
                
                sortedBoroughs.forEach(([borough, count]) => {
                    const percentage = ((count / stats.total) * 100).toFixed(1);
                    html += `<div style="padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #f39c12;">
                        <div style="font-weight: bold; color: #2c3e50; margin-bottom: 4px;">${borough}</div>
                        <div style="font-size: 1.3em; font-weight: bold; color: #f39c12;">${count}</div>
                        <div style="font-size: 0.85em; color: #666;">${percentage}% of total</div>
                    </div>`;
                });
                
                html += `</div></div>`;
            }

            // Monthly Trend Chart
            const sortedMonths = Object.keys(stats.monthlyTrend).sort();
            if (sortedMonths.length > 0) {
                html += `<div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #667eea;">
                    <h4 style="color: #667eea; margin-bottom: 15px;">📊 Violation Trend Over Time</h4>
                    <canvas id="coned-trend-chart"></canvas>
                </div>`;
            }

            // Performance Breakdown
            html += `<div style="background: white; padding: 20px; border-radius: 8px; border: 2px solid #667eea;">
                <h4 style="color: #667eea; margin-bottom: 15px;">📋 Case Status Breakdown</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                    <div style="padding: 15px; background: #d4edda; border-radius: 6px; border: 2px solid #27ae60;">
                        <div style="font-size: 0.85em; color: #155724; margin-bottom: 4px;">✅ Paid</div>
                        <div style="font-size: 1.8em; font-weight: bold; color: #27ae60;">${stats.paid}</div>
                        <div style="font-size: 0.85em; color: #155724;">${paymentRate}% success</div>
                    </div>
                    <div style="padding: 15px; background: #fff3cd; border-radius: 6px; border: 2px solid #f39c12;">
                        <div style="font-size: 0.85em; color: #856404; margin-bottom: 4px;">⏳ Requested</div>
                        <div style="font-size: 1.8em; font-weight: bold; color: #f39c12;">${stats.requested}</div>
                        <div style="font-size: 0.85em; color: #856404;">In pipeline</div>
                    </div>
                    <div style="padding: 15px; background: #f8d7da; border-radius: 6px; border: 2px solid #e74c3c;">
                        <div style="font-size: 0.85em; color: #721c24; margin-bottom: 4px;">❌ Disqualified</div>
                        <div style="font-size: 1.8em; font-weight: bold; color: #e74c3c;">${stats.disqualified}</div>
                        <div style="font-size: 0.85em; color: #721c24;">${disqualificationRate}% loss rate</div>
                    </div>
                    <div style="padding: 15px; background: #e2e3e5; border-radius: 6px; border: 2px solid #6c757d;">
                        <div style="font-size: 0.85em; color: #383d41; margin-bottom: 4px;">⚪ Unpaid</div>
                        <div style="font-size: 1.8em; font-weight: bold; color: #6c757d;">${stats.unpaid}</div>
                        <div style="font-size: 0.85em; color: #383d41;">Not yet pursued</div>
                    </div>
                </div>
            </div>`;

            // Strategic Recommendation
            let recommendation = '';
            if (paymentRate >= 70) {
                recommendation = `🌟 <strong>Excellent Partner:</strong> Con Edison is your most reliable customer with a ${paymentRate}% payment rate. Prioritize all Con Ed violations for maximum ROI.`;
            } else if (paymentRate >= 50) {
                recommendation = `✅ <strong>Good Partnership:</strong> Con Edison pays ${paymentRate}% of the time. Continue pursuing but monitor for improvements.`;
            } else {
                recommendation = `⚠️ <strong>Needs Attention:</strong> Con Edison's ${paymentRate}% payment rate is below optimal. Review your approach and consider more aggressive follow-up.`;
            }

            html += `<div style="margin-top: 20px; padding: 15px; background: #d4edda; border-radius: 6px; border-left: 4px solid #27ae60;">
                ${recommendation}
            </div>`;

            container.innerHTML = html;

            // Draw trend chart if data exists
            if (sortedMonths.length > 0) {
                setTimeout(() => {
                    const ctx = document.getElementById('coned-trend-chart');
                    if (ctx) {
                        const monthLabels = sortedMonths.map(m => {
                            const [year, month] = m.split('-');
                            return new Date(year, parseInt(month) - 1).toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
                        });
                        
                        new Chart(ctx.getContext('2d'), {
                            type: 'line',
                            data: {
                                labels: monthLabels,
                                datasets: [{
                                    label: 'Con Edison Violations',
                                    data: sortedMonths.map(m => stats.monthlyTrend[m]),
                                    borderColor: '#f39c12',
                                    backgroundColor: 'rgba(243, 156, 18, 0.1)',
                                    borderWidth: 3,
                                    fill: true,
                                    tension: 0.4
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: true,
                                plugins: {
                                    legend: { display: true }
                                },
                                scales: {
                                    y: { beginAtZero: true }
                                }
                            }
                        });
                    }
                }, 100);
            }
        }

        function generateDiscrepancies() {
            const mismatchesDiv = document.getElementById('discrepancies-mismatches');
            const paidNotFullDiv = document.getElementById('discrepancies-paid-not-full');
            const orphanedDiv = document.getElementById('discrepancies-orphaned');

            let mismatchesHTML = '';
            let paidNotFullHTML = '';
            let orphanedHTML = '';
            
            // Reset global mismatches data
            mismatchesData = {};

            ['at', 'at-nyc', 'mbt'].forEach(tab => {
                const datasetName = tab.toUpperCase();
                const merged = appData[tab].merged;
                const paid = appData[tab].paid;

                // Report A: Payment Mismatches
                const mismatches = [];
                let totalExpected = 0;
                let totalReceived = 0;

                merged.forEach(row => {
                    const summonsNum = (row['Summons Number'] || '').trim();
                    const nycPaidAmount = parseFloat((row['Paid Amount'] || '').replace(/[$,]/g, ''));
                    
                    if (!isNaN(nycPaidAmount) && nycPaidAmount > 0 && summonsNum) {
                        let receivedAmount = 0;
                        let paymentDate = '';
                        
                        if (row['Paid To Me']) {
                            receivedAmount = parseFloat((row['Paid To Me'] || '').replace(/[$,]/g, ''));
                            paymentDate = row['Payment Received'] || '';
                        }
                        
                        if (isNaN(receivedAmount) || receivedAmount === 0) {
                            const paidRow = paid.find(p => {
                                const paidSummons = (p['Summons #'] || p['Summons Number'] || '').trim();
                                return paidSummons === summonsNum;
                            });

                            if (paidRow) {
                                const amountFields = ['Paid To Me', 'Amount', 'Payment Amount', 'Check Amount', 'Amount Received', 'Paid Amount', 'Amount Paid'];
                                
                                for (const field of amountFields) {
                                    if (paidRow[field]) {
                                        const testAmount = parseFloat((paidRow[field] || '').replace(/[$,]/g, ''));
                                        if (!isNaN(testAmount) && testAmount > 0) {
                                            receivedAmount = testAmount;
                                            break;
                                        }
                                    }
                                }
                                paymentDate = paidRow['Payment Received'] || paidRow['Date Received'] || '';
                            }
                        }

                        if (receivedAmount > 0) {
                            const expected = nycPaidAmount * 0.25;
                            const difference = receivedAmount - expected;

                            if (Math.abs(difference) > 0.50) {
                                const invoiceNum = 'BP' + summonsNum.substring(1);
                                
                                mismatches.push({
                                    summons: summonsNum,
                                    invoice: invoiceNum,
                                    company: row['Company Name'] || 'Unknown',
                                    nycPaid: nycPaidAmount,
                                    expected: expected,
                                    received: receivedAmount,
                                    difference: difference,
                                    paymentDate: paymentDate
                                });
                                totalExpected += expected;
                                totalReceived += receivedAmount;
                            }
                        }
                    }
                });

                // Store mismatches data for this dataset
                if (mismatches.length > 0) {
                    mismatchesData[datasetName] = {
                        mismatches: mismatches,
                        totalExpected: totalExpected,
                        totalReceived: totalReceived,
                        totalDifference: totalReceived - totalExpected
                    };
                }

                if (mismatches.length > 0) {
                    const totalDifference = totalReceived - totalExpected;
                    mismatchesHTML += `
                        <div style="margin-bottom: 25px;">
                            <h4 style="color: #1e3c72; margin-bottom: 12px; font-size: 1em;">${datasetName} - ${mismatches.length} Discrepancies</h4>
                            <div style="overflow-x: auto;">
                                <table class="discrepancy-table">
                                    <thead>
                                        <tr>
                                            <th>Summons #</th>
                                            <th>Invoice #</th>
                                            <th>Company</th>
                                            <th style="text-align: right;">NYC Paid</th>
                                            <th style="text-align: right;">Expected</th>
                                            <th style="text-align: right;">Received</th>
                                            <th>Date</th>
                                            <th style="text-align: right;">Diff</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${mismatches.map(m => `
                                            <tr>
                                                <td style="font-family: monospace;">${m.summons}</td>
                                                <td>${m.invoice}</td>
                                                <td>${m.company}</td>
                                                <td style="text-align: right;">$${m.nycPaid.toFixed(2)}</td>
                                                <td style="text-align: right;">$${m.expected.toFixed(2)}</td>
                                                <td style="text-align: right;">$${m.received.toFixed(2)}</td>
                                                <td>${m.paymentDate}</td>
                                                <td style="text-align: right;" class="${m.difference < 0 ? 'amount-negative' : 'amount-positive'}">
                                                    ${m.difference < 0 ? '-' : '+'}$${Math.abs(m.difference).toFixed(2)}
                                                </td>
                                            </tr>
                                        `).join('')}
                                        <tr style="background: #f0f0f0; font-weight: bold;">
                                            <td colspan="4">TOTALS</td>
                                            <td style="text-align: right;">$${totalExpected.toFixed(2)}</td>
                                            <td style="text-align: right;">$${totalReceived.toFixed(2)}</td>
                                            <td>-</td>
                                            <td style="text-align: right;" class="${totalDifference < 0 ? 'amount-negative' : 'amount-positive'}">
                                                ${totalDifference < 0 ? '-' : '+'}$${Math.abs(totalDifference).toFixed(2)}
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }

                // NEW REPORT: Paid But Not "Paid in Full"
                const paidNotFull = [];
                
                // Create sets of summons numbers that are in Paid or Requested datasets
                const paidSummonsSet = new Set();
                paid.forEach(row => {
                    const summonsNum = (row['Summons #'] || row['Summons Number'] || '').trim();
                    if (summonsNum) paidSummonsSet.add(summonsNum);
                });
                
                const requestedSummonsSet = new Set();
                appData[tab].requests.forEach(row => {
                    const summonsNum = (row['Complaint Number'] || row['Summons Number'] || '').trim();
                    if (summonsNum) requestedSummonsSet.add(summonsNum);
                });
                
                merged.forEach(row => {
                    const paidAmount = parseFloat((row['Paid Amount'] || '').replace(/[$,]/g, ''));
                    const hearingStatus = (row['Hearing Status'] || '').toLowerCase();
                    const summonsNum = (row['Summons Number'] || '').trim();
                    
                    // Only include if: has paid amount, not "paid in full", and NOT in Paid or Requested datasets
                    if (!isNaN(paidAmount) && paidAmount > 0 && 
                        hearingStatus !== 'paid in full' && 
                        summonsNum &&
                        !paidSummonsSet.has(summonsNum) &&
                        !requestedSummonsSet.has(summonsNum)) {
                        const invoiceNum = 'BP' + summonsNum.substring(1);
                        paidNotFull.push({
                            invoice: invoiceNum,
                            company: row['Company Name'] || 'Unknown',
                            paidAmount: paidAmount,
                            hearingStatus: row['Hearing Status'] || 'Unknown',
                            violationDate: row['Violation Date'] || ''
                        });
                    }
                });

                if (paidNotFull.length > 0) {
                    const totalPaidNotFull = paidNotFull.reduce((sum, item) => sum + item.paidAmount, 0);
                    paidNotFullHTML += `
                        <div style="margin-bottom: 25px;">
                            <h4 style="color: #1e3c72; margin-bottom: 12px; font-size: 1em;">${datasetName} - ${paidNotFull.length} Cases</h4>
                            <div style="overflow-x: auto;">
                                <table class="discrepancy-table">
                                    <thead>
                                        <tr>
                                            <th>Invoice #</th>
                                            <th>Company</th>
                                            <th style="text-align: right;">Paid Amount</th>
                                            <th>Hearing Status</th>
                                            <th>Violation Date</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${paidNotFull.map(p => `
                                            <tr>
                                                <td>${p.invoice}</td>
                                                <td>${p.company}</td>
                                                <td style="text-align: right; color: #f39c12; font-weight: bold;">$${p.paidAmount.toFixed(2)}</td>
                                                <td>${p.hearingStatus}</td>
                                                <td>${p.violationDate}</td>
                                            </tr>
                                        `).join('')}
                                        <tr style="background: #f0f0f0; font-weight: bold;">
                                            <td colspan="2">TOTAL</td>
                                            <td style="text-align: right; color: #f39c12;">$${totalPaidNotFull.toFixed(2)}</td>
                                            <td colspan="2">-</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }

                // Report C: Orphaned Payments
                const orphaned = [];
                const masterSummons = new Set(merged.map(row => (row['Summons Number'] || '').trim()));

                paid.forEach(paidRow => {
                    const summonsNum = (paidRow['Summons #'] || paidRow['Summons Number'] || '').trim();
                    if (summonsNum && !masterSummons.has(summonsNum)) {
                        const amountFields = ['Paid To Me', 'Amount', 'Payment Amount', 'Check Amount', 'Amount Received', 'Paid Amount', 'Amount Paid'];
                        let amount = 0;
                        
                        for (const field of amountFields) {
                            if (paidRow[field]) {
                                amount = parseFloat((paidRow[field] || '').replace(/[$,]/g, ''));
                                if (!isNaN(amount) && amount > 0) break;
                            }
                        }

                        const invoiceNum = 'BP' + summonsNum.substring(1);
                        const paymentDate = paidRow['Payment Received'] || paidRow['Date Received'] || '';

                        orphaned.push({
                            summons: summonsNum,
                            invoice: invoiceNum,
                            amount: amount,
                            paymentDate: paymentDate
                        });
                    }
                });

                if (orphaned.length > 0) {
                    orphanedHTML += `
                        <div style="margin-bottom: 25px;">
                            <h4 style="color: #1e3c72; margin-bottom: 12px; font-size: 1em;">${datasetName} - ${orphaned.length} Orphaned</h4>
                            <div style="overflow-x: auto;">
                                <table class="discrepancy-table">
                                    <thead>
                                        <tr>
                                            <th>Invoice #</th>
                                            <th style="text-align: right;">Amount</th>
                                            <th>Date</th>
                                            <th>Note</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${orphaned.map(o => `
                                            <tr>
                                                <td>${o.invoice}</td>
                                                <td style="text-align: right;">$${o.amount.toFixed(2)}</td>
                                                <td>${o.paymentDate}</td>
                                                <td style="font-style: italic; color: #666;">Not in master</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }
            });

            mismatchesDiv.innerHTML = mismatchesHTML || '<p style="color: #27ae60; font-weight: bold;">✅ No payment mismatches found!</p>';
            paidNotFullDiv.innerHTML = paidNotFullHTML || '<p style="color: #27ae60; font-weight: bold;">✅ All paid amounts match "Paid in Full" status!</p>';
            orphanedDiv.innerHTML = orphanedHTML || '<p style="color: #27ae60; font-weight: bold;">✅ No orphaned payments found!</p>';
        }

        function setChartType(type) {
            currentChartType = type;
            document.querySelectorAll('.chart-type-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        function getChartColors(count, scheme) {
            const schemes = {
                'default': (i, total) => `hsl(${(i * 360 / total)}, 70%, 60%)`,
                'blue': (i, total) => `hsl(210, ${70 - (i * 40 / total)}%, ${60 - (i * 30 / total)}%)`,
                'green': (i, total) => `hsl(120, ${70 - (i * 40 / total)}%, ${50 - (i * 30 / total)}%)`,
                'red': (i, total) => `hsl(0, ${70 - (i * 40 / total)}%, ${60 - (i * 30 / total)}%)`,
                'purple': (i, total) => `hsl(280, ${70 - (i * 40 / total)}%, ${60 - (i * 30 / total)}%)`,
                'status': (i, total, label) => {
                    const statusColors = {
                        'PAID TO ME': '#27ae60',
                        'REQUESTED': '#f39c12',
                        'Paid': '#27ae60',
                        'Requested': '#f39c12',
                        'Disqualified': '#e74c3c',
                        'Submitted': '#9b59b6',
                        'Unpaid': '#95a5a6'
                    };
                    return statusColors[label] || `hsl(${(i * 360 / total)}, 70%, 60%)`;
                }
            };
            return schemes[scheme] || schemes['default'];
        }

        function filterDataByDateRange(data, dateRange) {
            if (dateRange === 'all') return data;
            
            const now = new Date();
            const getDateThreshold = () => {
                switch(dateRange) {
                    case 'ytd':
                        return new Date(now.getFullYear(), 0, 1);
                    case 'last-12':
                        return new Date(now.setMonth(now.getMonth() - 12));
                    case 'last-6':
                        return new Date(now.setMonth(now.getMonth() - 6));
                    case 'last-3':
                        return new Date(now.setMonth(now.getMonth() - 3));
                    case 'this-year':
                        return new Date(now.getFullYear(), 0, 1);
                    case 'last-year':
                        return [new Date(now.getFullYear() - 1, 0, 1), new Date(now.getFullYear() - 1, 11, 31)];
                    default:
                        return null;
                }
            };
            
            const threshold = getDateThreshold();
            if (!threshold) return data;
            
            return data.filter(row => {
                const dateStr = row['Violation Date'] || row['Date Submitted'];
                if (!dateStr) return false;
                const rowDate = new Date(dateStr);
                if (Array.isArray(threshold)) {
                    return rowDate >= threshold[0] && rowDate <= threshold[1];
                }
                return rowDate >= threshold;
            });
        }

        function groupByMonth(data) {
            const monthCounts = {};
            data.forEach(row => {
                const dateStr = row['Violation Date'] || row['Date Submitted'];
                if (dateStr) {
                    const date = new Date(dateStr);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    monthCounts[monthKey] = (monthCounts[monthKey] || 0) + 1;
                }
            });
            return monthCounts;
        }

        function groupByYear(data) {
            const yearCounts = {};
            data.forEach(row => {
                const dateStr = row['Violation Date'] || row['Date Submitted'];
                if (dateStr) {
                    const date = new Date(dateStr);
                    const year = date.getFullYear();
                    yearCounts[year] = (yearCounts[year] || 0) + 1;
                }
            });
            return yearCounts;
        }

        function calculateMeasure(data, measure, field) {
            if (measure === 'count') {
                const counts = {};
                data.forEach(row => {
                    const value = row[field] || 'Unknown';
                    counts[value] = (counts[value] || 0) + 1;
                });
                return counts;
            } else if (measure === 'sum-paid') {
                const sums = {};
                data.forEach(row => {
                    const value = row[field] || 'Unknown';
                    const amount = parseFloat((row['Paid Amount'] || '0').replace(/[$,]/g, ''));
                    sums[value] = (sums[value] || 0) + (isNaN(amount) ? 0 : amount);
                });
                return sums;
            } else if (measure === 'avg-paid') {
                const sums = {};
                const counts = {};
                data.forEach(row => {
                    const value = row[field] || 'Unknown';
                    const amount = parseFloat((row['Paid Amount'] || '0').replace(/[$,]/g, ''));
                    if (!isNaN(amount) && amount > 0) {
                        sums[value] = (sums[value] || 0) + amount;
                        counts[value] = (counts[value] || 0) + 1;
                    }
                });
                const avgs = {};
                Object.keys(sums).forEach(key => {
                    avgs[key] = sums[key] / (counts[key] || 1);
                });
                return avgs;
            } else if (measure === 'sum-balance') {
                const sums = {};
                data.forEach(row => {
                    const value = row[field] || 'Unknown';
                    const amount = parseFloat((row['Balance Due'] || '0').replace(/[$,]/g, ''));
                    sums[value] = (sums[value] || 0) + (isNaN(amount) ? 0 : amount);
                });
                return sums;
            }
            return {};
        }

        function updateGlobalChart() {
            const tabSelector = document.getElementById('chart-tab-selector').value;
            const fieldSelector = document.getElementById('chart-field-selector').value;
            const measure = document.getElementById('chart-measure').value;
            const sortBy = document.getElementById('chart-sort').value;
            const maxItems = document.getElementById('chart-max-items').value;
            const statusFilter = document.getElementById('chart-status-filter').value;
            const dateRange = document.getElementById('chart-date-range').value;
            const colorScheme = document.getElementById('chart-color-scheme').value;

            let data = [];
            if (tabSelector === 'all') {
                ['at', 'at-nyc', 'mbt'].forEach(tab => data.push(...appData[tab].merged));
            } else {
                data = appData[tabSelector].merged;
            }

            if (data.length === 0) {
                alert('No data available. Please load data first.');
                return;
            }

            // Apply status filter
            if (statusFilter) {
                data = data.filter(row => {
                    if (statusFilter === 'paid') return row['_rowType'] === 'paid';
                    if (statusFilter === 'requested') return row['_rowType'] === 'requested';
                    if (statusFilter === 'disqualified') return row['_rowType'] === 'disqualified' || row['_rowType'] === 'dismissed';
                    if (statusFilter === 'unpaid') return !row['Payment Status'] || row['Payment Status'] === '';
                    return true;
                });
            }

            // Apply date range filter
            data = filterDataByDateRange(data, dateRange);

            let chartData;
            if (fieldSelector === 'month') {
                chartData = groupByMonth(data);
            } else if (fieldSelector === 'year') {
                chartData = groupByYear(data);
            } else {
                chartData = calculateMeasure(data, measure, fieldSelector);
            }

            let entries = Object.entries(chartData);

            // Sort
            if (sortBy === 'value-desc') {
                entries.sort((a, b) => b[1] - a[1]);
            } else if (sortBy === 'value-asc') {
                entries.sort((a, b) => a[1] - b[1]);
            } else if (sortBy === 'label-asc') {
                entries.sort((a, b) => a[0].localeCompare(b[0]));
            } else if (sortBy === 'label-desc') {
                entries.sort((a, b) => b[0].localeCompare(a[0]));
            }

            // Limit items
            if (maxItems !== 'all') {
                entries = entries.slice(0, parseInt(maxItems));
            }

            if (entries.length === 0) {
                alert('No data matches the selected filters.');
                return;
            }

            const labels = entries.map(e => e[0]);
            const values = entries.map(e => e[1]);

            const colorFunc = getChartColors(labels.length, colorScheme);
            const colors = labels.map((label, i) => colorFunc(i, labels.length, label));

            const ctx = document.getElementById('global-chart').getContext('2d');

            if (globalChart) globalChart.destroy();

            const chartType = currentChartType === 'horizontalBar' ? 'bar' : currentChartType;
            const isHorizontal = currentChartType === 'horizontalBar';

            globalChart = new Chart(ctx, {
                type: chartType,
                data: {
                    labels: labels,
                    datasets: [{
                        label: getMeasureLabel(measure),
                        data: values,
                        backgroundColor: colors,
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    indexAxis: isHorizontal ? 'y' : 'x',
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: chartType === 'line' || isHorizontal ? 'top' : 'right',
                            labels: { font: { size: 10 }, padding: 8 }
                        },
                        title: {
                            display: true,
                            text: getChartTitle(fieldSelector, measure),
                            font: { size: 14, weight: 'bold' },
                            color: '#1e3c72'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (measure.includes('sum') || measure.includes('avg')) {
                                        label += '$' + context.parsed.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                                    } else {
                                        label += context.parsed.toLocaleString();
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: chartType === 'bar' || chartType === 'line' ? {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    if (measure.includes('sum') || measure.includes('avg')) {
                                        return '$' + value.toLocaleString();
                                    }
                                    return value.toLocaleString();
                                }
                            }
                        }
                    } : {}
                }
            });

            // Update title
            document.getElementById('chart-title').textContent = getChartTitle(fieldSelector, measure);

            // Show stats
            displayChartStats(values, measure, labels.length, data.length);

            // Show data table
            displayChartDataTable(labels, values, measure);
        }

        function getMeasureLabel(measure) {
            const labels = {
                'count': 'Count',
                'sum-paid': 'Total Paid Amount',
                'avg-paid': 'Average Paid Amount',
                'sum-balance': 'Total Balance Due'
            };
            return labels[measure] || 'Value';
        }

        function getChartTitle(field, measure) {
            const measureName = getMeasureLabel(measure);
            return `${measureName} by ${field}`;
        }

        function displayChartStats(values, measure, categoryCount, totalRecords) {
            const total = values.reduce((a, b) => a + b, 0);
            const avg = total / values.length;
            const max = Math.max(...values);
            const min = Math.min(...values);

            const statsDiv = document.getElementById('chart-stats');
            statsDiv.style.display = 'block';
            
            const isMonetary = measure.includes('sum') || measure.includes('avg');
            const formatValue = (val) => {
                if (isMonetary) {
                    return '$' + val.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                }
                return val.toLocaleString();
            };

            statsDiv.innerHTML = `
                <h4 style="color: #1e3c72; margin-bottom: 12px; font-size: 1em;">📈 Statistics</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
                    <div style="padding: 10px; background: linear-gradient(135deg, #ff8c42 0%, #ff6b35 100%); border-radius: 6px; text-align: center;">
                        <div style="color: white; font-size: 0.7em; opacity: 0.9;">TOTAL</div>
                        <div style="color: white; font-size: 1.2em; font-weight: bold;">${formatValue(total)}</div>
                    </div>
                    <div style="padding: 10px; background: #3498db; border-radius: 6px; text-align: center;">
                        <div style="color: white; font-size: 0.7em; opacity: 0.9;">AVERAGE</div>
                        <div style="color: white; font-size: 1.2em; font-weight: bold;">${formatValue(avg)}</div>
                    </div>
                    <div style="padding: 10px; background: #27ae60; border-radius: 6px; text-align: center;">
                        <div style="color: white; font-size: 0.7em; opacity: 0.9;">HIGHEST</div>
                        <div style="color: white; font-size: 1.2em; font-weight: bold;">${formatValue(max)}</div>
                    </div>
                    <div style="padding: 10px; background: #e74c3c; border-radius: 6px; text-align: center;">
                        <div style="color: white; font-size: 0.7em; opacity: 0.9;">LOWEST</div>
                        <div style="color: white; font-size: 1.2em; font-weight: bold;">${formatValue(min)}</div>
                    </div>
                    <div style="padding: 10px; background: #9b59b6; border-radius: 6px; text-align: center;">
                        <div style="color: white; font-size: 0.7em; opacity: 0.9;">CATEGORIES</div>
                        <div style="color: white; font-size: 1.2em; font-weight: bold;">${categoryCount}</div>
                    </div>
                    <div style="padding: 10px; background: #34495e; border-radius: 6px; text-align: center;">
                        <div style="color: white; font-size: 0.7em; opacity: 0.9;">RECORDS</div>
                        <div style="color: white; font-size: 1.2em; font-weight: bold;">${totalRecords.toLocaleString()}</div>
                    </div>
                </div>
            `;
        }

        function displayChartDataTable(labels, values, measure) {
            const tableDiv = document.getElementById('chart-data-table');
            tableDiv.style.display = 'block';

            const thead = document.getElementById('chart-table-head');
            const tbody = document.getElementById('chart-table-body');

            const isMonetary = measure.includes('sum') || measure.includes('avg');
            const formatValue = (val) => {
                if (isMonetary) {
                    return '$' + val.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                }
                return val.toLocaleString();
            };

            thead.innerHTML = `
                <tr style="background: #1e3c72; color: white;">
                    <th style="padding: 8px; text-align: left;">Category</th>
                    <th style="padding: 8px; text-align: right;">${getMeasureLabel(measure)}</th>
                    <th style="padding: 8px; text-align: right;">Percentage</th>
                </tr>
            `;

            const total = values.reduce((a, b) => a + b, 0);
            tbody.innerHTML = labels.map((label, i) => {
                const percentage = ((values[i] / total) * 100).toFixed(1);
                return `
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 6px;">${label}</td>
                        <td style="padding: 6px; text-align: right; font-weight: bold;">${formatValue(values[i])}</td>
                        <td style="padding: 6px; text-align: right;">${percentage}%</td>
                    </tr>
                `;
            }).join('') + `
                <tr style="background: #f0f0f0; font-weight: bold;">
                    <td style="padding: 6px;">TOTAL</td>
                    <td style="padding: 6px; text-align: right;">${formatValue(total)}</td>
                    <td style="padding: 6px; text-align: right;">100%</td>
                </tr>
            `;
        }

        // Quick Insight Functions
        function showPaymentStatusChart() {
            document.getElementById('chart-tab-selector').value = 'all';
            document.getElementById('chart-measure').value = 'count';
            document.getElementById('chart-field-selector').value = 'Payment Status';
            document.getElementById('chart-status-filter').value = '';
            document.getElementById('chart-date-range').value = 'all';
            document.getElementById('chart-color-scheme').value = 'status';
            setChartTypeByName('pie');
            updateGlobalChart();
        }

        function showCompanyChart() {
            document.getElementById('chart-tab-selector').value = 'all';
            document.getElementById('chart-measure').value = 'count';
            document.getElementById('chart-field-selector').value = 'Company Name';
            document.getElementById('chart-status-filter').value = '';
            document.getElementById('chart-date-range').value = 'all';
            document.getElementById('chart-max-items').value = '10';
            document.getElementById('chart-color-scheme').value = 'default';
            setChartTypeByName('horizontalBar');
            updateGlobalChart();
        }

        function showBoroughChart() {
            document.getElementById('chart-tab-selector').value = 'all';
            document.getElementById('chart-measure').value = 'count';
            document.getElementById('chart-field-selector').value = 'Violation Location (Borough)';
            document.getElementById('chart-status-filter').value = '';
            document.getElementById('chart-date-range').value = 'all';
            document.getElementById('chart-color-scheme').value = 'blue';
            setChartTypeByName('bar');
            updateGlobalChart();
        }

        function showMonthlyTrend() {
            document.getElementById('chart-tab-selector').value = 'all';
            document.getElementById('chart-measure').value = 'count';
            document.getElementById('chart-field-selector').value = 'month';
            document.getElementById('chart-status-filter').value = '';
            document.getElementById('chart-date-range').value = 'last-12';
            document.getElementById('chart-sort').value = 'label-asc';
            document.getElementById('chart-max-items').value = 'all';
            document.getElementById('chart-color-scheme').value = 'blue';
            setChartTypeByName('line');
            updateGlobalChart();
        }

        function showHearingResults() {
            document.getElementById('chart-tab-selector').value = 'all';
            document.getElementById('chart-measure').value = 'count';
            document.getElementById('chart-field-selector').value = 'Hearing Result';
            document.getElementById('chart-status-filter').value = '';
            document.getElementById('chart-date-range').value = 'all';
            document.getElementById('chart-color-scheme').value = 'purple';
            setChartTypeByName('doughnut');
            updateGlobalChart();
        }

        function showRevenueAnalysis() {
            document.getElementById('chart-tab-selector').value = 'all';
            document.getElementById('chart-measure').value = 'sum-paid';
            document.getElementById('chart-field-selector').value = 'Company Name';
            document.getElementById('chart-status-filter').value = 'paid';
            document.getElementById('chart-date-range').value = 'all';
            document.getElementById('chart-max-items').value = '10';
            document.getElementById('chart-color-scheme').value = 'green';
            setChartTypeByName('bar');
            updateGlobalChart();
        }

        function setChartTypeByName(type) {
            currentChartType = type;
            document.querySelectorAll('.chart-type-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.chart-type-btn').forEach(btn => {
                if (btn.textContent.toLowerCase().includes(type.toLowerCase().replace('horizontalbar', 'h-bar'))) {
                    btn.classList.add('active');
                }
            });
        }

        function exportChartImage() {
            if (!globalChart) {
                alert('Please generate a chart first.');
                return;
            }
            const canvas = document.getElementById('global-chart');
            const link = document.createElement('a');
            link.download = 'chart-' + new Date().getTime() + '.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        function exportChartDataCSV() {
            const thead = document.getElementById('chart-table-head');
            const tbody = document.getElementById('chart-table-body');
            
            if (!thead || !tbody || tbody.children.length === 0) {
                alert('Please generate a chart first.');
                return;
            }

            let csv = 'Category,Value,Percentage\n';
            Array.from(tbody.children).forEach(row => {
                const cells = Array.from(row.children);
                csv += cells.map(cell => '"' + cell.textContent.trim() + '"').join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.download = 'chart-data-' + new Date().getTime() + '.csv';
            link.href = url;
            link.click();
            window.URL.revokeObjectURL(url);
        }

        // ===== TRENDS TAB FUNCTIONS =====
        let trendCharts = {
            volume: null,
            payment: null,
            revenue: null,
            disqualification: null,
            companies: null
        };

        function getTimeKey(date, grouping) {
            const d = new Date(date);
            if (isNaN(d.getTime())) return null;
            
            if (grouping === 'month') {
                return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
            } else if (grouping === 'quarter') {
                const quarter = Math.floor(d.getMonth() / 3) + 1;
                return `${d.getFullYear()}-Q${quarter}`;
            } else if (grouping === 'year') {
                return `${d.getFullYear()}`;
            }
            return null;
        }

        function formatTimeLabel(key, grouping) {
            if (grouping === 'month') {
                const [year, month] = key.split('-');
                const date = new Date(year, parseInt(month) - 1);
                return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
            } else if (grouping === 'quarter') {
                return key;
            } else if (grouping === 'year') {
                return key;
            }
            return key;
        }

        function getTrendData() {
            const dataset = document.getElementById('trends-dataset').value;
            let data = [];
            
            if (dataset === 'all') {
                ['at', 'at-nyc', 'mbt'].forEach(tab => data.push(...appData[tab].merged));
            } else {
                data = appData[dataset].merged;
            }
            
            return data;
        }

        function generateAllTrends() {
            const data = getTrendData();
            
            if (data.length === 0) {
                alert('No data available. Please load data first.');
                return;
            }

            const grouping = document.getElementById('trends-grouping').value;
            
            generateVolumeChart(data, grouping);
            generatePaymentTrendChart(data, grouping);
            generateRevenueChart(data, grouping);
            generateDisqualificationChart(data, grouping);
            generateCompaniesChart(data, grouping);
            generatePeriodComparison(data, grouping);
            
            // Generate new trend analyses
            generateTopWeeks(data);
            generateTopDays(data);
            generateTopHours(data);
            generateTop25Companies(data);
        }

        function generateVolumeChart(data, grouping) {
            const timeData = {};
            
            data.forEach(row => {
                const dateStr = row['Violation Date'] || row['Date Submitted'];
                if (dateStr) {
                    const key = getTimeKey(dateStr, grouping);
                    if (key) {
                        timeData[key] = (timeData[key] || 0) + 1;
                    }
                }
            });

            const sortedKeys = Object.keys(timeData).sort();
            const labels = sortedKeys.map(key => formatTimeLabel(key, grouping));
            const values = sortedKeys.map(key => timeData[key]);

            const ctx = document.getElementById('trend-volume-chart').getContext('2d');
            
            if (trendCharts.volume) trendCharts.volume.destroy();
            
            trendCharts.volume = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Summons Issued',
                        data: values,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Summons: ' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function generatePaymentTrendChart(data, grouping) {
            const timeData = {};
            
            data.forEach(row => {
                const dateStr = row['Violation Date'] || row['Date Submitted'];
                if (dateStr) {
                    const key = getTimeKey(dateStr, grouping);
                    if (key) {
                        if (!timeData[key]) {
                            timeData[key] = { paid: 0, requested: 0, disqualified: 0, unpaid: 0 };
                        }
                        
                        if (row['_rowType'] === 'paid') {
                            timeData[key].paid++;
                        } else if (row['_rowType'] === 'requested') {
                            timeData[key].requested++;
                        } else if (row['_rowType'] === 'disqualified' || row['_rowType'] === 'dismissed') {
                            timeData[key].disqualified++;
                        } else {
                            timeData[key].unpaid++;
                        }
                    }
                }
            });

            const sortedKeys = Object.keys(timeData).sort();
            const labels = sortedKeys.map(key => formatTimeLabel(key, grouping));

            const ctx = document.getElementById('trend-payment-chart').getContext('2d');
            
            if (trendCharts.payment) trendCharts.payment.destroy();
            
            trendCharts.payment = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Paid',
                            data: sortedKeys.map(key => timeData[key].paid),
                            borderColor: '#27ae60',
                            backgroundColor: 'rgba(39, 174, 96, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Requested',
                            data: sortedKeys.map(key => timeData[key].requested),
                            borderColor: '#f39c12',
                            backgroundColor: 'rgba(243, 156, 18, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Disqualified',
                            data: sortedKeys.map(key => timeData[key].disqualified),
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Unpaid',
                            data: sortedKeys.map(key => timeData[key].unpaid),
                            borderColor: '#95a5a6',
                            backgroundColor: 'rgba(149, 165, 166, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: true, position: 'top' }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            stacked: false
                        }
                    }
                }
            });
        }

        function generateRevenueChart(data, grouping) {
            const timeData = {};
            
            data.forEach(row => {
                const dateStr = row['Violation Date'] || row['Date Submitted'];
                // Count both paid and requested as revenue
                if (dateStr && (row['_rowType'] === 'paid' || row['_rowType'] === 'requested')) {
                    const key = getTimeKey(dateStr, grouping);
                    if (key) {
                        const amount = parseFloat((row['Paid Amount'] || '0').replace(/[$,]/g, ''));
                        if (!isNaN(amount)) {
                            timeData[key] = (timeData[key] || 0) + amount;
                        }
                    }
                }
            });

            const sortedKeys = Object.keys(timeData).sort();
            const labels = sortedKeys.map(key => formatTimeLabel(key, grouping));
            const totalValues = sortedKeys.map(key => timeData[key]);
            const yourShareValues = sortedKeys.map(key => timeData[key] * 0.25);

            const ctx = document.getElementById('trend-revenue-chart').getContext('2d');
            
            if (trendCharts.revenue) trendCharts.revenue.destroy();
            
            trendCharts.revenue = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Total Paid/Requested to NYC',
                            data: totalValues,
                            backgroundColor: 'rgba(52, 152, 219, 0.7)',
                            borderColor: '#3498db',
                            borderWidth: 1
                        },
                        {
                            label: 'Your 25% Share',
                            data: yourShareValues,
                            backgroundColor: 'rgba(39, 174, 96, 0.7)',
                            borderColor: '#27ae60',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': $' + context.parsed.y.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function generateDisqualificationChart(data, grouping) {
            const timeData = {};
            
            data.forEach(row => {
                const dateStr = row['Violation Date'] || row['Date Submitted'];
                if (dateStr) {
                    const key = getTimeKey(dateStr, grouping);
                    if (key) {
                        if (!timeData[key]) {
                            timeData[key] = { total: 0, disqualified: 0 };
                        }
                        timeData[key].total++;
                        if (row['_rowType'] === 'disqualified' || row['_rowType'] === 'dismissed') {
                            timeData[key].disqualified++;
                        }
                    }
                }
            });

            const sortedKeys = Object.keys(timeData).sort();
            const labels = sortedKeys.map(key => formatTimeLabel(key, grouping));
            const percentages = sortedKeys.map(key => {
                const rate = (timeData[key].disqualified / timeData[key].total) * 100;
                return rate.toFixed(1);
            });

            const ctx = document.getElementById('trend-disqualification-chart').getContext('2d');
            
            if (trendCharts.disqualification) trendCharts.disqualification.destroy();
            
            trendCharts.disqualification = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Disqualification Rate (%)',
                        data: percentages,
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Rate: ' + context.parsed.y + '%';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        function generateCompaniesChart(data, grouping) {
            // Get top 5 companies
            const companyCounts = {};
            data.forEach(row => {
                const company = normalizeCompanyName(row['Company Name'] || 'Unknown');
                companyCounts[company] = (companyCounts[company] || 0) + 1;
            });
            
            const topCompanies = Object.entries(companyCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(e => e[0]);

            // Track each company over time
            const companyTimeData = {};
            topCompanies.forEach(company => {
                companyTimeData[company] = {};
            });

            data.forEach(row => {
                const company = normalizeCompanyName(row['Company Name'] || 'Unknown');
                if (topCompanies.includes(company)) {
                    const dateStr = row['Violation Date'] || row['Date Submitted'];
                    if (dateStr) {
                        const key = getTimeKey(dateStr, grouping);
                        if (key) {
                            companyTimeData[company][key] = (companyTimeData[company][key] || 0) + 1;
                        }
                    }
                }
            });

            const allKeys = new Set();
            Object.values(companyTimeData).forEach(timeData => {
                Object.keys(timeData).forEach(key => allKeys.add(key));
            });
            const sortedKeys = Array.from(allKeys).sort();
            const labels = sortedKeys.map(key => formatTimeLabel(key, grouping));

            const colors = ['#3498db', '#27ae60', '#f39c12', '#e74c3c', '#9b59b6'];
            const datasets = topCompanies.map((company, i) => ({
                label: company,
                data: sortedKeys.map(key => companyTimeData[company][key] || 0),
                borderColor: colors[i],
                backgroundColor: colors[i] + '20',
                borderWidth: 2,
                fill: false,
                tension: 0.4
            }));

            const ctx = document.getElementById('trend-companies-chart').getContext('2d');
            
            if (trendCharts.companies) trendCharts.companies.destroy();
            
            trendCharts.companies = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: true, position: 'top' }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function generatePeriodComparison(data, grouping) {
            const timeData = {};
            
            data.forEach(row => {
                const dateStr = row['Violation Date'] || row['Date Submitted'];
                if (dateStr) {
                    const key = getTimeKey(dateStr, grouping);
                    if (key) {
                        if (!timeData[key]) {
                            timeData[key] = {
                                total: 0,
                                paid: 0,
                                requested: 0,
                                disqualified: 0,
                                revenue: 0
                            };
                        }
                        timeData[key].total++;
                        
                        if (row['_rowType'] === 'paid') {
                            timeData[key].paid++;
                            const amount = parseFloat((row['Paid Amount'] || '0').replace(/[$,]/g, ''));
                            if (!isNaN(amount)) {
                                timeData[key].revenue += amount;
                            }
                        } else if (row['_rowType'] === 'requested') {
                            timeData[key].requested++;
                        } else if (row['_rowType'] === 'disqualified' || row['_rowType'] === 'dismissed') {
                            timeData[key].disqualified++;
                        }
                    }
                }
            });

            const sortedKeys = Object.keys(timeData).sort();
            const recentPeriods = sortedKeys.slice(-6); // Last 6 periods

            const comparisonDiv = document.getElementById('period-comparison');
            
            if (recentPeriods.length === 0) {
                comparisonDiv.innerHTML = '<p style="color: #666; font-size: 0.85em;">No data available for comparison</p>';
                return;
            }

            let html = '<div style="overflow-x: auto;"><table style="width: 100%; font-size: 0.8em; border-collapse: collapse;">';
            html += '<thead><tr style="background: #1e3c72; color: white;">';
            html += '<th style="padding: 8px; text-align: left;">Period</th>';
            html += '<th style="padding: 8px; text-align: right;">Total</th>';
            html += '<th style="padding: 8px; text-align: right;">Paid</th>';
            html += '<th style="padding: 8px; text-align: right;">Requested</th>';
            html += '<th style="padding: 8px; text-align: right;">Disqualified</th>';
            html += '<th style="padding: 8px; text-align: right;">Revenue</th>';
            html += '<th style="padding: 8px; text-align: right;">Your Share</th>';
            html += '</tr></thead><tbody>';

            recentPeriods.forEach((key, index) => {
                const period = timeData[key];
                const bgColor = index % 2 === 0 ? '#f8f9fa' : 'white';
                html += `<tr style="background: ${bgColor}; border-bottom: 1px solid #ddd;">`;
                html += `<td style="padding: 6px; font-weight: bold;">${formatTimeLabel(key, grouping)}</td>`;
                html += `<td style="padding: 6px; text-align: right;">${period.total}</td>`;
                html += `<td style="padding: 6px; text-align: right; color: #27ae60;">${period.paid}</td>`;
                html += `<td style="padding: 6px; text-align: right; color: #f39c12;">${period.requested}</td>`;
                html += `<td style="padding: 6px; text-align: right; color: #e74c3c;">${period.disqualified}</td>`;
                html += `<td style="padding: 6px; text-align: right;">$${period.revenue.toFixed(2)}</td>`;
                html += `<td style="padding: 6px; text-align: right; font-weight: bold; color: #27ae60;">$${(period.revenue * 0.25).toFixed(2)}</td>`;
                html += '</tr>';
            });

            html += '</tbody></table></div>';
            comparisonDiv.innerHTML = html;
        }

        // Function to get week start date (Sunday) for a given date
        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day;
            return new Date(d.setDate(diff));
        }

        // Generate Top 10 Weeks
        function generateTopWeeks(data) {
            const weekData = {};
            
            data.forEach(row => {
                const dateStr = row['Violation Date'];
                if (dateStr) {
                    const date = new Date(dateStr);
                    if (!isNaN(date.getTime())) {
                        const weekStart = getWeekStart(date);
                        const weekKey = weekStart.toISOString().split('T')[0];
                        
                        if (!weekData[weekKey]) {
                            weekData[weekKey] = {
                                count: 0,
                                startDate: weekStart,
                                endDate: new Date(weekStart.getTime() + 6 * 24 * 60 * 60 * 1000)
                            };
                        }
                        weekData[weekKey].count++;
                    }
                }
            });

            const topWeeks = Object.entries(weekData)
                .sort((a, b) => b[1].count - a[1].count)
                .slice(0, 10);

            const container = document.getElementById('trend-top-weeks');
            let html = '<div style="overflow-x: auto;"><table style="width: 100%; font-size: 0.85em; border-collapse: collapse;">';
            html += '<thead><tr style="background: #1e3c72; color: white;">';
            html += '<th style="padding: 8px;">Rank</th>';
            html += '<th style="padding: 8px;">Week</th>';
            html += '<th style="padding: 8px;">Date Range</th>';
            html += '<th style="padding: 8px; text-align: right;">Violations</th>';
            html += '</tr></thead><tbody>';

            topWeeks.forEach(([weekKey, data], index) => {
                const bgColor = index % 2 === 0 ? '#f8f9fa' : 'white';
                const startStr = data.startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const endStr = data.endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                
                html += `<tr style="background: ${bgColor};">`;
                html += `<td style="padding: 6px; text-align: center; font-weight: bold;">#${index + 1}</td>`;
                html += `<td style="padding: 6px;">Week of ${startStr}</td>`;
                html += `<td style="padding: 6px; font-size: 0.9em; color: #666;">${startStr} - ${endStr}</td>`;
                html += `<td style="padding: 6px; text-align: right; font-weight: bold; color: #1e3c72;">${data.count}</td>`;
                html += '</tr>';
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // Generate Top 10 Days
        function generateTopDays(data) {
            const dayData = {};
            
            data.forEach(row => {
                const dateStr = row['Violation Date'];
                if (dateStr) {
                    const date = new Date(dateStr);
                    if (!isNaN(date.getTime())) {
                        const dayKey = date.toISOString().split('T')[0];
                        dayData[dayKey] = (dayData[dayKey] || 0) + 1;
                    }
                }
            });

            const topDays = Object.entries(dayData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            const container = document.getElementById('trend-top-days');
            let html = '<div style="overflow-x: auto;"><table style="width: 100%; font-size: 0.85em; border-collapse: collapse;">';
            html += '<thead><tr style="background: #1e3c72; color: white;">';
            html += '<th style="padding: 8px;">Rank</th>';
            html += '<th style="padding: 8px;">Date</th>';
            html += '<th style="padding: 8px;">Day of Week</th>';
            html += '<th style="padding: 8px; text-align: right;">Violations</th>';
            html += '</tr></thead><tbody>';

            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            
            topDays.forEach(([dayKey, count], index) => {
                const date = new Date(dayKey);
                const dayOfWeek = dayNames[date.getDay()];
                const dateStr = date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                const bgColor = index % 2 === 0 ? '#f8f9fa' : 'white';
                
                html += `<tr style="background: ${bgColor};">`;
                html += `<td style="padding: 6px; text-align: center; font-weight: bold;">#${index + 1}</td>`;
                html += `<td style="padding: 6px;">${dateStr}</td>`;
                html += `<td style="padding: 6px; color: #666;">${dayOfWeek}</td>`;
                html += `<td style="padding: 6px; text-align: right; font-weight: bold; color: #1e3c72;">${count}</td>`;
                html += '</tr>';
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // Generate Top 10 Hours (Specific hour-long blocks)
        function generateTopHours(data) {
            // Collect all violations with exact timestamps
            const violationTimestamps = [];
            
            data.forEach(row => {
                const dateStr = row['Violation Date'];
                const timeStr = row['Violation Time'];
                if (dateStr && timeStr) {
                    const date = new Date(dateStr);
                    if (!isNaN(date.getTime()) && timeStr.includes(':')) {
                        const [hour, minute] = timeStr.split(':').map(n => parseInt(n));
                        if (!isNaN(hour) && !isNaN(minute)) {
                            date.setHours(hour, minute, 0, 0);
                            violationTimestamps.push({
                                timestamp: date.getTime(),
                                dateStr: dateStr,
                                timeStr: timeStr,
                                row: row
                            });
                        }
                    }
                }
            });
            
            // Sort by timestamp
            violationTimestamps.sort((a, b) => a.timestamp - b.timestamp);
            
            // Find hour-long blocks with most violations
            const hourBlocks = [];
            
            for (let i = 0; i < violationTimestamps.length; i++) {
                const startTime = violationTimestamps[i].timestamp;
                const endTime = startTime + (60 * 60 * 1000); // 1 hour later
                
                // Count violations in this hour block
                let count = 0;
                let j = i;
                while (j < violationTimestamps.length && violationTimestamps[j].timestamp < endTime) {
                    count++;
                    j++;
                }
                
                if (count > 1) { // Only consider blocks with multiple violations
                    const startDate = new Date(startTime);
                    const endDate = new Date(endTime);
                    
                    hourBlocks.push({
                        startTime: startTime,
                        endTime: endTime,
                        startDateStr: startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }),
                        startTimeStr: startDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true }),
                        endTimeStr: endDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true }),
                        count: count,
                        firstViolation: violationTimestamps[i],
                        lastViolation: violationTimestamps[Math.min(i + count - 1, j - 1)]
                    });
                }
            }
            
            // Remove overlapping blocks (keep the one with higher count)
            const uniqueBlocks = [];
            hourBlocks.forEach(block => {
                const overlapping = uniqueBlocks.find(existing => 
                    (block.startTime >= existing.startTime && block.startTime < existing.endTime) ||
                    (existing.startTime >= block.startTime && existing.startTime < block.endTime)
                );
                
                if (!overlapping) {
                    uniqueBlocks.push(block);
                } else if (block.count > overlapping.count) {
                    const index = uniqueBlocks.indexOf(overlapping);
                    uniqueBlocks[index] = block;
                }
            });
            
            // Sort by count and take top 10
            const topBlocks = uniqueBlocks
                .sort((a, b) => b.count - a.count)
                .slice(0, 10);

            const container = document.getElementById('trend-top-hours');
            
            if (topBlocks.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Not enough data to identify specific hour-long violation clusters.</p>';
                return;
            }
            
            let html = '<div style="overflow-x: auto;"><table style="width: 100%; font-size: 0.85em; border-collapse: collapse;">';
            html += '<thead><tr style="background: #1e3c72; color: white;">';
            html += '<th style="padding: 8px;">Rank</th>';
            html += '<th style="padding: 8px;">Date</th>';
            html += '<th style="padding: 8px;">Hour Block</th>';
            html += '<th style="padding: 8px; text-align: right;">Violations</th>';
            html += '</tr></thead><tbody>';

            topBlocks.forEach((block, index) => {
                const bgColor = index % 2 === 0 ? '#f8f9fa' : 'white';
                
                html += `<tr style="background: ${bgColor};">`;
                html += `<td style="padding: 6px; text-align: center; font-weight: bold;">#${index + 1}</td>`;
                html += `<td style="padding: 6px;">${block.startDateStr}</td>`;
                html += `<td style="padding: 6px; font-weight: bold;">${block.startTimeStr} - ${block.endTimeStr}</td>`;
                html += `<td style="padding: 6px; text-align: right; font-weight: bold; color: #1e3c72;">${block.count}</td>`;
                html += '</tr>';
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // Generate Top 25 Companies
        function generateTop25Companies(data) {
            const companyData = {};
            
            data.forEach(row => {
                const company = normalizeCompanyName(row['Company Name'] || 'Unknown');
                
                if (!companyData[company]) {
                    companyData[company] = {
                        submissions: 0,
                        totalPaid: 0,
                        paidCount: 0
                    };
                }
                
                companyData[company].submissions++;
                
                if (row['_rowType'] === 'paid') {
                    companyData[company].paidCount++;
                    const amount = parseFloat((row['Paid Amount'] || '0').replace(/[$,]/g, ''));
                    if (!isNaN(amount)) {
                        companyData[company].totalPaid += amount;
                    }
                }
            });

            const top25 = Object.entries(companyData)
                .sort((a, b) => b[1].submissions - a[1].submissions)
                .slice(0, 25);

            const container = document.getElementById('trend-top-25-companies');
            let html = '<div style="overflow-x: auto;"><table style="width: 100%; font-size: 0.85em; border-collapse: collapse;">';
            html += '<thead><tr style="background: #1e3c72; color: white;">';
            html += '<th style="padding: 8px;">Rank</th>';
            html += '<th style="padding: 8px;">Company</th>';
            html += '<th style="padding: 8px; text-align: right;">Submissions</th>';
            html += '<th style="padding: 8px; text-align: right;">Paid Count</th>';
            html += '<th style="padding: 8px; text-align: right;">NYC Paid Total</th>';
            html += '<th style="padding: 8px; text-align: right;">Your 25%</th>';
            html += '<th style="padding: 8px; text-align: right;">Pay Rate</th>';
            html += '</tr></thead><tbody>';

            let totalYourShare = 0;
            
            top25.forEach(([company, data], index) => {
                const bgColor = index % 2 === 0 ? '#f8f9fa' : 'white';
                const yourShare = data.totalPaid * 0.25;
                totalYourShare += yourShare;
                const payRate = data.submissions > 0 ? ((data.paidCount / data.submissions) * 100).toFixed(1) : '0.0';
                const rateColor = parseFloat(payRate) >= 60 ? '#27ae60' : parseFloat(payRate) >= 40 ? '#f39c12' : '#e74c3c';
                
                html += `<tr style="background: ${bgColor};">`;
                html += `<td style="padding: 6px; text-align: center; font-weight: bold;">#${index + 1}</td>`;
                html += `<td style="padding: 6px;">${company}</td>`;
                html += `<td style="padding: 6px; text-align: right; font-weight: bold;">${data.submissions}</td>`;
                html += `<td style="padding: 6px; text-align: right;">${data.paidCount}</td>`;
                html += `<td style="padding: 6px; text-align: right;">$${data.totalPaid.toFixed(2)}</td>`;
                html += `<td style="padding: 6px; text-align: right; font-weight: bold; color: #27ae60;">$${yourShare.toFixed(2)}</td>`;
                html += `<td style="padding: 6px; text-align: right; font-weight: bold; color: ${rateColor};">${payRate}%</td>`;
                html += '</tr>';
            });

            // Add total row
            const totalSubmissions = top25.reduce((sum, [, data]) => sum + data.submissions, 0);
            const totalPaidCount = top25.reduce((sum, [, data]) => sum + data.paidCount, 0);
            const totalNYCPaid = top25.reduce((sum, [, data]) => sum + data.totalPaid, 0);
            const avgPayRate = totalSubmissions > 0 ? ((totalPaidCount / totalSubmissions) * 100).toFixed(1) : '0.0';
            
            html += `<tr style="background: #f0f0f0; font-weight: bold;">`;
            html += `<td colspan="2" style="padding: 8px;">TOTAL (Top 25)</td>`;
            html += `<td style="padding: 8px; text-align: right;">${totalSubmissions}</td>`;
            html += `<td style="padding: 8px; text-align: right;">${totalPaidCount}</td>`;
            html += `<td style="padding: 8px; text-align: right;">$${totalNYCPaid.toFixed(2)}</td>`;
            html += `<td style="padding: 8px; text-align: right; color: #27ae60;">$${totalYourShare.toFixed(2)}</td>`;
            html += `<td style="padding: 8px; text-align: right;">${avgPayRate}%</td>`;
            html += '</tr>';

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        function exportMismatchesPDF() {
            if (Object.keys(mismatchesData).length === 0) {
                alert('Please generate the discrepancy report first by clicking "🔍 Generate Reports"');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Add title
            doc.setFontSize(18);
            doc.setTextColor(30, 60, 114);
            doc.text('Payment Amount Mismatches Report', 14, 20);
            
            // Add generation date
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text('Generated: ' + new Date().toLocaleString(), 14, 28);
            
            let yPosition = 38;
            
            // Process each dataset
            Object.keys(mismatchesData).forEach((datasetName, index) => {
                const data = mismatchesData[datasetName];
                
                // Add page break if needed (except for first dataset)
                if (index > 0 && yPosition > 240) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                // Dataset header
                doc.setFontSize(14);
                doc.setTextColor(30, 60, 114);
                doc.text(`${datasetName} Dataset - ${data.mismatches.length} Discrepancies`, 14, yPosition);
                yPosition += 8;
                
                // Create table data
                const tableData = data.mismatches.map(m => [
                    m.summons,
                    m.invoice,
                    m.company.length > 25 ? m.company.substring(0, 22) + '...' : m.company,
                    '$' + m.nycPaid.toFixed(2),
                    '$' + m.expected.toFixed(2),
                    '$' + m.received.toFixed(2),
                    m.paymentDate,
                    (m.difference < 0 ? '-' : '+') + '$' + Math.abs(m.difference).toFixed(2)
                ]);
                
                // Add summary row
                tableData.push([
                    '',
                    '',
                    'TOTALS',
                    '',
                    '$' + data.totalExpected.toFixed(2),
                    '$' + data.totalReceived.toFixed(2),
                    '',
                    (data.totalDifference < 0 ? '-' : '+') + '$' + Math.abs(data.totalDifference).toFixed(2)
                ]);
                
                // Generate table
                doc.autoTable({
                    startY: yPosition,
                    head: [['Summons #', 'Invoice #', 'Company', 'NYC Paid', 'Expected', 'Received', 'Date', 'Difference']],
                    body: tableData,
                    theme: 'striped',
                    headStyles: {
                        fillColor: [30, 60, 114],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold',
                        fontSize: 8
                    },
                    bodyStyles: {
                        fontSize: 7,
                        cellPadding: 2
                    },
                    columnStyles: {
                        0: { cellWidth: 22, fontStyle: 'mono' }, // Summons
                        1: { cellWidth: 20 }, // Invoice
                        2: { cellWidth: 35 }, // Company
                        3: { halign: 'right', cellWidth: 20 }, // NYC Paid
                        4: { halign: 'right', cellWidth: 20 }, // Expected
                        5: { halign: 'right', cellWidth: 20 }, // Received
                        6: { cellWidth: 22, fontSize: 6 }, // Date
                        7: { halign: 'right', cellWidth: 20 } // Difference
                    },
                    didParseCell: function(data) {
                        // Highlight summary row
                        if (data.row.index === tableData.length - 1) {
                            data.cell.styles.fillColor = [240, 240, 240];
                            data.cell.styles.fontStyle = 'bold';
                        }
                        
                        // Color code differences in last column
                        if (data.column.index === 7 && data.row.index < tableData.length - 1) {
                            const value = data.cell.text[0];
                            if (value.startsWith('-')) {
                                data.cell.styles.textColor = [231, 76, 60]; // Red for negative
                            } else if (value.startsWith('+')) {
                                data.cell.styles.textColor = [52, 152, 219]; // Blue for positive
                            }
                        }
                    },
                    didDrawPage: function(data) {
                        // Footer
                        const pageCount = doc.internal.getNumberOfPages();
                        const pageSize = doc.internal.pageSize;
                        const pageHeight = pageSize.height ? pageSize.height : pageSize.getHeight();
                        
                        doc.setFontSize(8);
                        doc.setTextColor(150, 150, 150);
                        doc.text('Page ' + doc.internal.getCurrentPageInfo().pageNumber + ' of ' + pageCount, 
                                14, pageHeight - 10);
                    }
                });
                
                yPosition = doc.lastAutoTable.finalY + 15;
            });
            
            // Add summary page if multiple datasets
            if (Object.keys(mismatchesData).length > 1) {
                doc.addPage();
                
                doc.setFontSize(16);
                doc.setTextColor(30, 60, 114);
                doc.text('Overall Summary', 14, 20);
                
                let overallExpected = 0;
                let overallReceived = 0;
                let overallDiscrepancies = 0;
                
                const summaryData = [];
                Object.keys(mismatchesData).forEach(datasetName => {
                    const data = mismatchesData[datasetName];
                    overallExpected += data.totalExpected;
                    overallReceived += data.totalReceived;
                    overallDiscrepancies += data.mismatches.length;
                    
                    summaryData.push([
                        datasetName,
                        data.mismatches.length,
                        '$' + data.totalExpected.toFixed(2),
                        '$' + data.totalReceived.toFixed(2),
                        (data.totalDifference < 0 ? '-' : '+') + '$' + Math.abs(data.totalDifference).toFixed(2)
                    ]);
                });
                
                // Add total row
                summaryData.push([
                    'TOTAL',
                    overallDiscrepancies,
                    '$' + overallExpected.toFixed(2),
                    '$' + overallReceived.toFixed(2),
                    (overallReceived - overallExpected < 0 ? '-' : '+') + '$' + Math.abs(overallReceived - overallExpected).toFixed(2)
                ]);
                
                doc.autoTable({
                    startY: 30,
                    head: [['Dataset', 'Count', 'Expected', 'Received', 'Difference']],
                    body: summaryData,
                    theme: 'grid',
                    headStyles: {
                        fillColor: [30, 60, 114],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold'
                    },
                    columnStyles: {
                        1: { halign: 'center' },
                        2: { halign: 'right' },
                        3: { halign: 'right' },
                        4: { halign: 'right' }
                    },
                    didParseCell: function(data) {
                        // Highlight total row
                        if (data.row.index === summaryData.length - 1) {
                            data.cell.styles.fillColor = [30, 60, 114];
                            data.cell.styles.textColor = [255, 255, 255];
                            data.cell.styles.fontStyle = 'bold';
                        }
                    }
                });
                
                // Add notes section
                yPosition = doc.lastAutoTable.finalY + 15;
                doc.setFontSize(12);
                doc.setTextColor(30, 60, 114);
                doc.text('Notes:', 14, yPosition);
                
                doc.setFontSize(10);
                doc.setTextColor(80, 80, 80);
                yPosition += 8;
                doc.text('• Expected amount is 25% of what NYC was paid', 14, yPosition);
                yPosition += 6;
                doc.text('• Positive difference = You received MORE than expected', 14, yPosition);
                yPosition += 6;
                doc.text('• Negative difference = You received LESS than expected', 14, yPosition);
                yPosition += 6;
                doc.text('• Only discrepancies greater than $0.50 are shown', 14, yPosition);
            }
            
            // Save the PDF
            const fileName = `Payment_Mismatches_Report_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
        }

        function saveToStorage() {
            try {
                const saveData = {};
                ['at', 'at-nyc', 'mbt'].forEach(tab => {
                    saveData[tab] = {
                        master: appData[tab].master,
                        paid: appData[tab].paid,
                        requests: appData[tab].requests,
                        merged: appData[tab].merged,
                        lastRefreshSheets: appData[tab].lastRefreshSheets,
                        lastRefreshNYC: appData[tab].lastRefreshNYC
                    };
                });
                localStorage.setItem('truckDataManager', JSON.stringify(saveData));
            } catch (e) {
                console.error('Error saving to localStorage:', e);
            }
        }

        function loadFromStorage() {
            try {
                const saved = localStorage.getItem('truckDataManager');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    Object.keys(parsed).forEach(tab => {
                        if (appData[tab] && parsed[tab]) {
                            appData[tab].master = parsed[tab].master || [];
                            appData[tab].paid = parsed[tab].paid || [];
                            appData[tab].requests = parsed[tab].requests || [];
                            appData[tab].merged = parsed[tab].merged || [];
                            appData[tab].lastRefreshSheets = parsed[tab].lastRefreshSheets || null;
                            appData[tab].lastRefreshNYC = parsed[tab].lastRefreshNYC || null;
                        }
                    });
                    ['at', 'at-nyc', 'mbt'].forEach(tab => {
                        if (appData[tab].merged.length > 0) {
                            applyFilters(tab);
                            populateFilterDropdowns(tab);
                        }
                    });
                }
            } catch (e) {
                console.error('Error loading from localStorage:', e);
            }
        }
    </script>
</body>
</html>
